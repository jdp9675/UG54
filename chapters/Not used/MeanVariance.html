
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Capital Allocation &#8212; Quantitative Investing</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/book.css?v=c2893119" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/Not used/MeanVariance';</script>
    <link rel="canonical" href="https://amoreira2.github.io/Fin418/chapters/Not used/MeanVariance.html" />
    <link rel="icon" href="../../_static/figuremain2.jpg"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/figuremain2.jpg" class="logo__image only-light" alt="Quantitative Investing - Home"/>
    <script>document.write(`<img src="../../_static/figuremain2.jpg" class="logo__image only-dark" alt="Quantitative Investing - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01/what-is-quant-investing.html">1. What is Data Driven Investing?</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01/statistical-techniques.html">1.1. Statistical Techniques</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/computational-tools.html">1.2. Computational tools</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../02/getting_started.html">2. Getting Started</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02/cloud_setup.html">2.3. Cloud Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/local_install.html">2.4. Local installation</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../essentials/intro.html">3. Python Essentials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../essentials/basics.html">3.1. Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/collections.html">3.2. Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/numpy.html">3.3. Numpy</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../essentials/introtopandas.html">3.4. Pandas</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/the_index.html">3.4.3. Indexing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/timeseries.html">3.4.4. Time-Series</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/reshape.html">3.4.5. Reshape</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/merge.html">3.4.6. Merge</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/groupby.html">3.4.7. Group-by</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/matplotlib.html">3.4.8. Plotting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/data_clean.html">3.4.9. Cleaning data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/storage_formats.html">3.4.10. Data Storage</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/control_flow.html">3.5. Flow control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/functions.html">3.6. Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/plotting.html">3.7. Plotting</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Finance/IntrotoReturns.html">4. Introduction to Asset Returns</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Finance/TheChoiceofFrequency.html">4.5. The Choice of Frequency and Annualization of Returns</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Finance/UsingAPI.html">4.6. Data APIs</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../Finance/FactorModels.html">5. Factor Models</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Finance/PortfolioMath.html">6. Portfolios</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../scientific/linear_algebra1.html">6.5. Linear Algebra Review</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../Finance/CapitalAllocationI.html">7. Capital Allocation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Finance/FactorModelEstimation.html">8. Factor Model Estimation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Finance/Timing.html">9. Timing Strategies</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Finance/MarketTiming.html">9.1. Expected Returns Timing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Finance/Volatilitytiming.html">9.2. Volatility Timing</a></li>

</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Finance/crosssectionalequitystrategies.html">10. Cross-Sectional Equity Strategies</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Finance/Momentum.html">10.3. Momentum factor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Finance/Factors.html">10.4. An overview of factors</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../Finance/CapitalAllocationII.html">11. Capital Allocation II</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Finance/Performance_evaluation.html">12. Performance Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Finance/MachineLearning.html">13. Machine Learning in Finance</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Finance/MultiFactorModels.html">14. Multi Factor Models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Finance/InterpretingFactorModels.html">14.6. 📊 Interpreting Factor Models</a></li>


</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../Finance/RiskManagement.html">15. Risk Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Finance/TradingCosts.html">16. Liquidity and Trading Cost Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Finance/LeverageandShorting.html">17. Leverage, Shorting, and Limits to Arbitrage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Finance/GenAIandLLMsinFinance.html">18. Gen AI and LLMs in Finance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/additional.html">19. Additional Statistics Material</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Assignments/Assignments.html">20. Assignments</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment1.html">20.1. Assignment 1</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/amoreira2/Fin418/blob/main/chapters/Not used/MeanVariance.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/amoreira2/Fin418" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/amoreira2/Fin418/issues/new?title=Issue%20on%20page%20%2Fchapters/Not used/MeanVariance.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/chapters/Not used/MeanVariance.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Capital Allocation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-rise-of-pod-shops">The rise of “pod shops”</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#volatility-management">Volatility Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#volatility-managing-the-market">Volatility managing the market</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#constructing-monthly-realized-variance-from-daily-data"><strong>Constructing monthly realized variance from daily data</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#from-signal-to-weights"><strong>From signal to weights</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#construct-strategy-returns"><strong>Construct strategy returns</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-bond-equity-strategic-investment-problem-of-an-international-investor">A bond-equity strategic investment problem of an international investor</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numerical-solution">Numerical solution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introducing-a-benchmark">Introducing a benchmark</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#information-ratio">Information Ratio</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analytical-solution">Analytical solution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sharpe-ratio">Sharpe-ratio !</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-the-mean-variance-efficient-portfolio"><strong>Finding the Mean-variance efficient portfolio</strong></a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span><span class="w"> </span><span class="nn">wrds</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas_datareader.data</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">web</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_factors</span><span class="p">(</span><span class="n">factors</span><span class="o">=</span><span class="s1">&#39;CAPM&#39;</span><span class="p">):</span>   
    <span class="k">if</span> <span class="n">factors</span><span class="o">==</span><span class="s1">&#39;CAPM&#39;</span><span class="p">:</span>
        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_Factors_daily&quot;</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">daily_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df_factor</span> <span class="o">=</span> <span class="n">daily_data</span><span class="p">[[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]]</span> 
    <span class="k">elif</span> <span class="n">factors</span><span class="o">==</span><span class="s1">&#39;FF3&#39;</span><span class="p">:</span>
        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_Factors_daily&quot;</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">daily_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df_factor</span> <span class="o">=</span> <span class="n">daily_data</span><span class="p">[[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span><span class="s1">&#39;HML&#39;</span><span class="p">]]</span>
    <span class="k">elif</span> <span class="n">factors</span><span class="o">==</span><span class="s1">&#39;FF5&#39;</span><span class="p">:</span>
        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_5_Factors_2x3_daily&quot;</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">daily_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df_factor</span> <span class="o">=</span> <span class="n">daily_data</span><span class="p">[[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span><span class="s1">&#39;HML&#39;</span><span class="p">,</span><span class="s1">&#39;RMW&#39;</span><span class="p">,</span><span class="s1">&#39;CMA&#39;</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_5_Factors_2x3_daily&quot;</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">daily_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df_factor</span> <span class="o">=</span> <span class="n">daily_data</span><span class="p">[[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span><span class="s1">&#39;HML&#39;</span><span class="p">,</span><span class="s1">&#39;RMW&#39;</span><span class="p">,</span><span class="s1">&#39;CMA&#39;</span><span class="p">]]</span>
        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Momentum_Factor_daily&quot;</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">df_factor</span><span class="o">=</span><span class="n">df_factor</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>    

    <span class="k">return</span> <span class="n">df_factor</span><span class="o">/</span><span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="capital-allocation">
<h1>Capital Allocation<a class="headerlink" href="#capital-allocation" title="Link to this heading">#</a></h1>
<p>How should you allocate capital?</p>
<p>This question can be decomposed in two:</p>
<ol class="arabic simple">
<li><p>How large is my risk portfolio? This comes down to determining how much risk do you want to take</p></li>
<li><p>How will I split this portfolio across assets</p></li>
</ol>
<p>How to approach these questions depend on whether you are investing as principal (i.e. on your behalf) or as a delegate (a manager in a hedge fund)</p>
<p><strong>1. The Portfolio risk decision</strong></p>
<p>The benefit of risk-taking is the extra expected return you get relative to the risk-free rate.
That is true both for a principal and a delegate
You wealth is expected to grow faster (either directly or indirectly trough your performance compensation)</p>
<p>The cost is the “risk”. It is important to think exactly what you fear to think about how costly taking on risk is for you</p>
<p><strong>A. Principal</strong></p>
<ul class="simple">
<li><p>What do you want to do with the money and when?</p></li>
<li><p>How terrible you feel if you have less than you expected</p></li>
<li><p>How much joy would you enjoy if you had more</p></li>
<li><p>Do you have commitments that you absolutely need to satisfy?</p>
<ul>
<li><p>Minimum retirement income</p></li>
<li><p>Minimum balance in college fund</p></li>
<li><p>Minimum budget for health issues</p></li>
<li><p>Future purchase of a property</p></li>
</ul>
</li>
<li><p>Commitments will push you to take less risk if you currently have enough money to fulfill them</p>
<ul>
<li><p>Complete de-risking guarantees you can honor these commitments</p></li>
</ul>
</li>
<li><p>We often talk about someone risk-aversion to describe how painful risk-taking is</p></li>
</ul>
<p><strong>B. Delegate</strong></p>
<ul class="simple">
<li><p>The delegate certainly has stop loss rule</p></li>
<li><p>If they lose more than that amount they are forced to liquidate their positions and they are likely to be fired</p></li>
<li><p>Such stop loss is particularly biding for new managers</p></li>
<li><p>This stop loss might be explicit:the fund principal literally tells what it is</p></li>
<li><p>But most likely is implicitly–there is a loss that investors will freak out and pull out</p></li>
<li><p>You got to think for yourself and have very clearly what the number is</p></li>
</ul>
<p><strong>Formalizing their problems</strong></p>
<ul class="simple">
<li><p>I think is more useful to think in terms of the one-year ahead looses you are comfortable with.</p>
<ul>
<li><p>F is the CDF of a standard normal, and <span class="math notranslate nohighlight">\(F^{-1}\)</span> is it’s quantile function</p></li>
<li><p>h is a scalar greater than 1 that adjusts for deviation from the normal.</p></li>
<li><p>For example h=1.5 will mean that a 3 sigma event is as likely as a 3/h=2 sigma event</p></li>
<li><p>You pick a probability, <span class="math notranslate nohighlight">\(\underline{p}\)</span>,</p></li>
<li><p>And a maximum loss <span class="math notranslate nohighlight">\(\overline{L}\)</span> for  your portfolio in 1 year</p></li>
</ul>
</li>
</ul>
<div class="math notranslate nohighlight">
\[hF^{-1}(\underline{p})\sigma\geq-\overline{L}\]</div>
<p>Then</p>
<div class="math notranslate nohighlight">
\[\sigma\leq-\frac{\overline{L}}{hF^{-1}(\underline{p})}\]</div>
<p>for <span class="math notranslate nohighlight">\(\underline{p}=5 \%\)</span>, <span class="math notranslate nohighlight">\(\overline{L}=30\%\)</span>,h=2 what do we get?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>

<span class="n">p</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">h</span><span class="o">=</span><span class="mi">2</span>
<span class="n">L</span><span class="o">=</span><span class="mf">0.3</span>
<span class="n">sigma</span><span class="o">=-</span><span class="n">L</span><span class="o">/</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="n">sigma</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.09119352478676533
</pre></div>
</div>
</div>
</div>
<p>You might want to incorporate your views on the portfolio expected return</p>
<p>That is relevant in case your horizons are one year or longer.</p>
<p>For horizons that are 1 month or shorter you are safe ignoring the expected value since the volatility totally dominates</p>
<p>Now we write the problem as what fraction of your wealth w, you should invest in this portfolio</p>
<p>the mode you invest, the higher the expected growth <span class="math notranslate nohighlight">\(w\mu+rf\)</span>, but also the higher your wealth vol <span class="math notranslate nohighlight">\(x\sigma\)</span></p>
<div class="math notranslate nohighlight">
\[w(hF^{-1}(\underline{p})\sigma+\mu)+rf\geq-\overline{L}\]</div>
<p>to again represent in terms of total vol you choose to take I will rewrite</p>
<div class="math notranslate nohighlight">
\[w\sigma(hF^{-1}(\underline{p})+\frac{\mu}{\sigma})+rf\geq-\overline{L}\]</div>
<p>Now note that <span class="math notranslate nohighlight">\(F^{-1}(\underline{p})\)</span> is a negative number and <span class="math notranslate nohighlight">\(\frac{\mu}{\sigma}\)</span> is positive</p>
<p>Lets first assume <span class="math notranslate nohighlight">\(hF^{-1}(\underline{p})+\frac{\mu}{\sigma}&lt;0\)</span> which is the realistic case</p>
<div class="math notranslate nohighlight">
\[w\sigma\leq-\frac{\overline{L}+rf}{(hF^{-1}(\underline{p})+\frac{\mu}{\sigma})}\]</div>
<ul class="simple">
<li><p>A higher risk-free rate means you can take more vol, since you start from a higher expected baseline</p>
<ul>
<li><p>It is natural to have a real rate here since you probably care about your purchasing power</p></li>
</ul>
</li>
<li><p>Sharpe Ratio: We can the ratio of the portfolio expected excess return, it’t risk-premium, relative to the portfolio volatility, the Sharpe Ratio</p></li>
</ul>
<div class="math notranslate nohighlight">
\[SR=\frac{E[r]-rf}{\sqrt{Var(r)}}=\frac{E[r^e]}{\sigma}=\frac{\mu}{\sigma}\]</div>
<ul class="simple">
<li><p>The higher the Sharpe ratio, the less negative is <span class="math notranslate nohighlight">\(hF^{-1}(\underline{p})+\frac{\mu}{\sigma}\)</span> and the higher is the higher the volatility you choose to take</p></li>
</ul>
<p>Lets plug some numbers with <span class="math notranslate nohighlight">\(rf=1\%\)</span> and SR=0.4 ( that is the market Sharpe ratio)</p>
<div class="math notranslate nohighlight">
\[-\frac{0.3+0.01}{2*(-1.64)+0.4}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calculate_sigma</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span><span class="n">sr</span><span class="p">,</span><span class="n">rf</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">L</span><span class="o">+</span><span class="n">rf</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span><span class="n">sr</span><span class="p">)</span>




<span class="c1"># Example usage</span>
<span class="n">L</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">rf</span><span class="o">=</span><span class="mf">0.01</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">calculate_sigma</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">rf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">calculate_sigma</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="n">rf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">calculate_sigma</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">rf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">calculate_sigma</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span><span class="mf">3.2896</span><span class="p">,</span><span class="n">rf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.09423330894632417
0.10727730277221074
0.13538848665984968
-3.2897072539029457
2890.3377078699764
</pre></div>
</div>
</div>
</div>
<p>As your SR grows that loss becomes less likely than 5% and the amount of risk that you can take while being 95% sure that you will not lose 30% of your dollars goes to infinity</p>
<p>In this case you can simply adjust your confidence probabilities</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">calculate_sigma</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="mf">3.28</span><span class="p">,</span><span class="n">rf</span><span class="p">)</span>
<span class="n">sr_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.28</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">sigma_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">calculate_sigma</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="n">rf</span><span class="p">)</span> <span class="k">for</span> <span class="n">sr</span> <span class="ow">in</span> <span class="n">sr_values</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sr_values</span><span class="p">,</span> <span class="n">sigma_values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio (SR)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sigma&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sigma as a function of Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/221e3241dd201e4272aab837b628e20be41ff203f4c21e85e68a44b10ef08101.png" src="../../_images/221e3241dd201e4272aab837b628e20be41ff203f4c21e85e68a44b10ef08101.png" />
</div>
</div>
<ul class="simple">
<li><p>Once you Sharpe Ratio is above 3 (as rare as snow in the winter), risk is unlikely to be the limiting factor</p></li>
<li><p>Wat before then you hit at capacity constraints for your trade since your wealth will be growing so wildly fast</p>
<ul>
<li><p>For SR=3, your wealth grows at <span class="math notranslate nohighlight">\(w\sigma*\frac{\mu}{\sigma}=1*3=300\%\)</span> per year!</p></li>
</ul>
</li>
</ul>
<p><strong>2. How do I allocate across assets</strong></p>
<p>Implicit in our discussion is that you have some desired portfolio with some Sharpe ratio <span class="math notranslate nohighlight">\(SR_p\)</span> and you are deciding how to invest in it.</p>
<p>We can already see that having a large Sharpe ratio is a nice thing to have:</p>
<ul class="simple">
<li><p>Increases the growth of your portfolio per unit of risk</p></li>
<li><p>For the same growth , you need to take less risk</p></li>
<li><p>Expected growth means you are less likely to have large losses</p></li>
</ul>
<p>How to build a portfolio that maximizes you SR?</p>
<p><strong>IF</strong> you know the vectors of expected excess returns across your assets and their variance covariance matrix the answer is trivial</p>
<div class="math notranslate nohighlight">
\[W=w E[R^e]\Sigma_{R}^{-1} \]</div>
<p>where</p>
<ul class="simple">
<li><p>w is a scalar that controls the overall volatility of your portfolio, but does not impact the SR</p></li>
<li><p><span class="math notranslate nohighlight">\(E[R^e]\)</span> is the vector of (FORWARD LOOKING) expected excess returns across assets</p></li>
<li><p><span class="math notranslate nohighlight">\(\Sigma_{R}\)</span> is the variance-covariance matrix</p></li>
</ul>
<p>This portfolio solves the following problems</p>
<ol class="arabic simple">
<li><p><span class="math notranslate nohighlight">\( \max_W E[W'R^e_T]-\gamma Var(W'R^e_T)\)</span>, for <span class="math notranslate nohighlight">\(w=\frac{1}{2\gamma}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\( \max_W E[W'R^e_T]~~~subject~~to~~~Var(W'R^e_T)\leq Vmax \)</span>, for <span class="math notranslate nohighlight">\(w=\sqrt{\frac{Vmax}{E[R^e]\Sigma_{R}^{-1}E[R^e]'}}\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\( \min_W Var(W'R^e_T)~~~subject~~to~~~E[W'R^e_T]\geq Emin \)</span>, for <span class="math notranslate nohighlight">\(w=\frac{Emin}{E[R^e]\Sigma_{R}^{-1}E[R^e]'}\)</span></p></li>
</ol>
<p>Lets apply this to the international portfolio we looked at last class</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/amoreira2/Lectures/main/assets/data/GlobalFinMonthly.csv&quot;</span>
<span class="n">Data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">na_values</span><span class="o">=-</span><span class="mi">99</span><span class="p">)</span>
<span class="c1"># tell python Date is date:</span>
<span class="n">Data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
<span class="c1"># set an an index</span>
<span class="n">Data</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
<span class="n">Rf</span><span class="o">=</span><span class="n">Data</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">]</span>
<span class="n">Data</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MKT</th>
      <th>USA30yearGovBond</th>
      <th>EmergingMarkets</th>
      <th>WorldxUSA</th>
      <th>WorldxUSAGovBond</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1963-02-28</th>
      <td>-0.0238</td>
      <td>-0.004178</td>
      <td>0.095922</td>
      <td>-0.005073</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1963-03-31</th>
      <td>0.0308</td>
      <td>0.001042</td>
      <td>0.011849</td>
      <td>-0.001929</td>
      <td>-0.000387</td>
    </tr>
    <tr>
      <th>1963-04-30</th>
      <td>0.0451</td>
      <td>-0.004343</td>
      <td>-0.149555</td>
      <td>-0.005836</td>
      <td>0.005502</td>
    </tr>
    <tr>
      <th>1963-05-31</th>
      <td>0.0176</td>
      <td>-0.004207</td>
      <td>-0.014572</td>
      <td>-0.002586</td>
      <td>0.002289</td>
    </tr>
    <tr>
      <th>1963-06-30</th>
      <td>-0.0200</td>
      <td>-0.000634</td>
      <td>-0.057999</td>
      <td>-0.013460</td>
      <td>0.000839</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># lets assume the sample moments are the true moments of the distribution</span>


<span class="n">muR</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">muR</span><span class="p">)</span>
<span class="n">SigmaR</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">SigmaR</span><span class="p">)</span>
<span class="c1"># this inverts the variance covariance matrix</span>
<span class="n">display</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">SigmaR</span><span class="p">))</span>
<span class="n">W</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">SigmaR</span><span class="p">)</span> <span class="o">@</span> <span class="n">muR</span>
<span class="n">display</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MKT                 0.005140
USA30yearGovBond    0.002523
EmergingMarkets     0.006923
WorldxUSA           0.004149
WorldxUSAGovBond    0.002054
dtype: float64
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MKT</th>
      <th>USA30yearGovBond</th>
      <th>EmergingMarkets</th>
      <th>WorldxUSA</th>
      <th>WorldxUSAGovBond</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>MKT</th>
      <td>0.001948</td>
      <td>0.000111</td>
      <td>0.001292</td>
      <td>0.001264</td>
      <td>0.000187</td>
    </tr>
    <tr>
      <th>USA30yearGovBond</th>
      <td>0.000111</td>
      <td>0.001227</td>
      <td>-0.000204</td>
      <td>-0.000013</td>
      <td>0.000264</td>
    </tr>
    <tr>
      <th>EmergingMarkets</th>
      <td>0.001292</td>
      <td>-0.000204</td>
      <td>0.003556</td>
      <td>0.001661</td>
      <td>0.000249</td>
    </tr>
    <tr>
      <th>WorldxUSA</th>
      <td>0.001264</td>
      <td>-0.000013</td>
      <td>0.001661</td>
      <td>0.002182</td>
      <td>0.000422</td>
    </tr>
    <tr>
      <th>WorldxUSAGovBond</th>
      <td>0.000187</td>
      <td>0.000264</td>
      <td>0.000249</td>
      <td>0.000422</td>
      <td>0.000407</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 886.9351877 , -163.1566812 , -133.47716321, -463.61463361,
         260.65110274],
       [-163.1566812 , 1029.7603189 ,   83.97391735,  201.95839425,
        -854.35594033],
       [-133.47716321,   83.97391735,  462.95743432, -276.66588761,
          10.81093193],
       [-463.61463361,  201.95839425, -276.66588761, 1113.82507458,
        -904.79801414],
       [ 260.65110274, -854.35594033,   10.81093193, -904.79801414,
        3826.58967227]])
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 1.83533361,  1.42337262,  1.60522251, -1.02642088,  3.36582305])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Can you check that applying the little w above it will indeed solve problems 2 and 3?</p></li>
<li><p>Can you check that the SR of portfolio w*W is invariant to little w?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the range of w values</span>
<span class="n">w_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># Calculate the portfolio returns and volatilities for each w</span>
<span class="n">portfolio_returns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">portfolio_volatilities</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">w_values</span><span class="p">:</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">SigmaR</span><span class="p">)</span> <span class="o">@</span> <span class="n">muR</span>
    <span class="n">portfolio_return</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">@</span> <span class="n">muR</span>
    <span class="n">portfolio_volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights</span> <span class="o">@</span> <span class="n">SigmaR</span> <span class="o">@</span> <span class="n">weights</span><span class="p">)</span>
    
    <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">portfolio_return</span><span class="p">)</span>
    <span class="n">portfolio_volatilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">portfolio_volatility</span><span class="p">)</span>

<span class="c1"># Plot the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">portfolio_volatilities</span><span class="p">,</span> <span class="n">portfolio_returns</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Portfolio Volatility&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Average Return&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Average Return vs. Portfolio Volatility&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e32af4f9e352fefdf1cd06af74e569ebad0029f0a11a674a97037ac3a485b448.png" src="../../_images/e32af4f9e352fefdf1cd06af74e569ebad0029f0a11a674a97037ac3a485b448.png" />
</div>
</div>
<p>What does it mean that the relationship between Expected return and volatility is linear?</p>
<p>Is that what you expect? Is that true in general as you change portfolio weights?</p>
<p><strong>In reality</strong> knowing the true moments of the return distribution is HARD as we discussed a few classes ago</p>
<p><strong>In reality</strong> your portfolio is not all you care about</p>
<p>It is useful to decompose your allocation in terms of “factor bets” and “alpha bets”</p>
<p>We will now focus on the “alpha” aspect of allocation and revisit factor allocation once we introduce multi-factor models</p>
<p>Most fund managers have tight limits on factor exposures anyways, so factor exposure is more of a consequence of your alpha bets that you need to control rather then a form of investing.</p>
<p>Let’s say that you identified N trading strategies</p>
<ul class="simple">
<li><p>You believe their alphas are A (N by 1)</p></li>
<li><p>You estimate their factor Betas B (N by 1)</p></li>
<li><p>And their idio variance <span class="math notranslate nohighlight">\(\Sigma_{\epsilon}\)</span>, which is diagonal. These are idio bets after you remove the factor exposure</p></li>
<li><p>You have a mandate to have zero factor exposure.</p></li>
</ul>
<p>What is your optimal portfolio ( we are focusing now on the composition, lets put the level of risk aside) ?</p>
<ul class="simple">
<li><p>What is your allocation on each trading strategy?</p></li>
<li><p>Assuming you can trade the factor, how much of it you buy/sell directly?</p></li>
</ul>
<p>Examples:</p>
<p>same alpha, same betas, same idio</p>
<p>differnt alpha, same beta , same indio</p>
<p>same alpha, different betas, same idio</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">A</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arrary</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.05</span><span class="p">])</span>
<span class="n">B</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">])</span>
<span class="n">Sigmae</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<p>The solution is <span class="math notranslate nohighlight">\(w*W\)</span> and <span class="math notranslate nohighlight">\(w*W_f\)</span> for any scalar w, where</p>
<p><span class="math notranslate nohighlight">\(W=A\Sigma_{\epsilon}^{=1}\)</span></p>
<p><span class="math notranslate nohighlight">\(W_f=-W'\Beta\)</span></p>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}A\Sigma_{\epsilon}^{=1}=\left[\alpha_1,\alpha_2,...,\alpha_N\right]\left[\begin{array}{ccc}\sigma^2_{\epsilon,1} &amp; 0 &amp; 0\\0 &amp; \sigma^2_{\epsilon,i} &amp; 0\\0&amp;0&amp;\sigma^2_{\epsilon,N}\end{array}\right]^{-1}=\left[\begin{array}{c}\frac{\alpha_1}{\sigma^2_{\epsilon,1} }\\\frac{\alpha_2}{\sigma^2_{\epsilon,2} }\\...\\\frac{\alpha_N}{\sigma^2_{\epsilon,N} }\end{array}\right]\end{split}\]</div>
<p>The fact that all the trading strategies are stripped out of the co-movement leads to a really clean formula</p>
<p>You can rewrite in terms of volatility allocations in each strategy</p>
<div class="math notranslate nohighlight">
\[W_i\sigma_{\epsilon,i}=\frac{\alpha_i}{\sigma_{\epsilon,i}}\]</div>
<p>We refer to <span class="math notranslate nohighlight">\(\frac{\alpha_i}{\sigma{\epsilon,i}}\)</span> as the strategy <strong>Appraisal Ratio</strong>. Sometimes people call this the “information ratio”. It is the “sharpe ratio” of the trading strategy striped out of factor exposure</p>
<ul class="simple">
<li><p>recall that <span class="math notranslate nohighlight">\(\sigma{\epsilon,i}\)</span> is the volatility of the strategy that is long the asset and short the factor in the optimal hedging</p></li>
</ul>
<div class="math notranslate nohighlight">
\[r^e_i-h^if=\alpha_i+\beta_i*f+\epsilon_i+hf\]</div>
<p>so if you set <span class="math notranslate nohighlight">\(h=-\beta_i\)</span></p>
<div class="math notranslate nohighlight">
\[r^e_i-h^if=\alpha_i+\epsilon_i\]</div>
<p>and follows that <span class="math notranslate nohighlight">\(E[r^e_i-h^if]=\alpha_i\)</span> and <span class="math notranslate nohighlight">\(Var(r^e_i-h^if)=\sigma_{\epsilon,i}^2\)</span></p>
<p>This is the optimal if you are certain of you alphas</p>
<p>But of course you don’t really know, so the industry developed many Ad-hoc approaches for <strong>bet sizing</strong></p>
<p><strong>Bet sizing</strong> is one of the great skills in a portfolio manager because it requires instinct for uncertainty</p>
<p>The different Approaches (w is a scalar that controls the overall size of the portfolio )</p>
<ul class="simple">
<li><p><strong>Mean-variance</strong> rule:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[W_i=w \frac{\alpha_i}{\sigma_{\epsilon,i}^2}\]</div>
<ul class="simple">
<li><p>*<em>1/N</em> rule: ignore the magnitude of the alpha and simply bet on the direction of your idea</p></li>
</ul>
<div class="math notranslate nohighlight">
\[W_i=\frac{1}{N}\left((\alpha_i&gt;0)-(\alpha_i&lt;0)\right)\]</div>
<ul class="simple">
<li><p>this is good if you have goo hunches for mispricing, but you don’t get the magnitudes quite right</p></li>
</ul>
<ul class="simple">
<li><p><strong>Proportional</strong> rule: Buy/sell proportional to the alpha</p></li>
</ul>
<div class="math notranslate nohighlight">
\[W_i=w \alpha_i\]</div>
<ul class="simple">
<li><p><strong>Risky-parity</strong> rule: assumes the Appraisal ratio of your different ideas are the same <span class="math notranslate nohighlight">\(\frac{\mu_i}{\sigma_i}=\frac{\mu_j}{\sigma_j}\)</span></p></li>
</ul>
<div class="math notranslate nohighlight">
\[W_i=w \frac{1}{\sigma_{\epsilon,i}}\]</div>
<ul class="simple">
<li><p><strong>Variance shrinkage</strong> rule: you shrink the variance-covariance matrix towards diagonal</p></li>
</ul>
<div class="math notranslate nohighlight">
\[W_i=w (\alpha_i&gt;0)\frac{\mu^{+}_{\alpha}}{\sigma_{\epsilon,i}^2+\sigma_{\alpha}^2}+(\alpha_i&lt;0)\frac{\mu^{-}_{\alpha}}{\sigma_{\epsilon,i}^2+\sigma_{\alpha}^2}\]</div>
<ul class="simple">
<li><p>where <span class="math notranslate nohighlight">\(\tau\)</span> is the shrinkage factor.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mu^{+}_{\alpha}&gt;0\)</span> is your expected average alpha for you long ideas</p></li>
<li><p><span class="math notranslate nohighlight">\(\mu^{-}_{\alpha}&lt;0\)</span> is your expected average alpha for you shirt ideas</p></li>
<li><p>As we grow <span class="math notranslate nohighlight">\(\tau\)</span>, our portfolio converges to the 1/N rule.</p></li>
</ul>
<p><strong>Shrinkage</strong> is a very popular technique and also the lest ad-hoc of the different approaches so it work discussing a bit</p>
<p>The fundamental issue that the mean-variance problem does not deal with is that we are actually quite uncertain about the alphas, but the methods assumes complete certitude</p>
<p>In mathematical terms the MV problem assumes <span class="math notranslate nohighlight">\(A\)</span> is a know constant when in fact it is more like a distribution:</p>
<div class="math notranslate nohighlight">
\[A\sim N(\mu_{\alpha}I,\sigma^2_{\alpha}I)\]</div>
<p>where <span class="math notranslate nohighlight">\(\mu_{\alpha}\)</span> is the expected value . Here we are focused on a manager only with long ideas. The short book is analogous</p>
<p>One could also write $<span class="math notranslate nohighlight">\(A\sim N(\mu_{\alpha}I,\sigma^2_{\alpha}1_{NxN})\)</span>$</p>
<p>Capturing the idea that there is co-movement in your alpha-judgment</p>
<p>Now his/her problem is (I will use the mean-variance problem case but the two other problems have similar solution)</p>
<div class="math notranslate nohighlight">
\[ \max_W E[W'R^e_T]-\gamma Var(W'R^e_T)\]</div>
<div class="math notranslate nohighlight">
\[ \max_W E[W'(A+Bf+U)]-\gamma Var(W'(A+Bf+U))\]</div>
<p>Here I will assume <span class="math notranslate nohighlight">\(E[f]=0\)</span>, so we can simply write the portfolio allocation problem of the <strong>hedged portfolios</strong></p>
<div class="math notranslate nohighlight">
\[ \max_W E[W'(A+U)]-\gamma Var(W'(A+U))\]</div>
<div class="math notranslate nohighlight">
\[ \max_W E[W'A]-\gamma \left(WVar(A)W'+WVar(U)W'\right)\]</div>
<div class="math notranslate nohighlight">
\[\max_W W'I\mu_{\alpha}-\gamma \left(WIW'\sigma^2_{\alpha}+W\Sigma_{\epsilon}W'\right)\]</div>
<p>The Optimality condition for this problem is</p>
<div class="math notranslate nohighlight">
\[I\mu_{\alpha}-2\gamma \left(\sigma^2_{\alpha}+\Sigma_{\epsilon}\right)W'\]</div>
<p>Reorganizing</p>
<div class="math notranslate nohighlight">
\[W=\frac{1}{2\gamma}\mu_{\alpha}\left(I\sigma^2_{\alpha}+\Sigma_{\epsilon}\right)^{-1}\]</div>
<p>In this case where there is no co-movement, the approach ignores alpha information of each idea (you use <span class="math notranslate nohighlight">\(\mu_{\alpha}\)</span> for all) and you “noise up” the returns by <span class="math notranslate nohighlight">\(\sigma^2_{\alpha}\)</span></p>
<p>In case of co-movement , then we have</p>
<div class="math notranslate nohighlight">
\[W=\frac{1}{2\gamma}\mu_{\alpha}\left(1\sigma^2_{\alpha}+\Sigma_{\epsilon}\right)^{-1}\]</div>
<p>Lets get to work</p>
<ul class="simple">
<li><p>Total portfolio with volatility 30%</p></li>
<li><p>vector of alphas [0.3,0.2,0.1,0.1]</p></li>
<li><p>idio vol 0.2</p></li>
<li><p>sigma alpha 0.05</p></li>
<li><p>mu alpha 0.15</p></li>
<li><p>for simplicity beta=0 for each strategy (or alternatively, you are working with hedged portfolios)</p></li>
</ul>
<p>Show the weights under the different allocation rules</p>
<section id="the-rise-of-pod-shops">
<h2>The rise of “pod shops”<a class="headerlink" href="#the-rise-of-pod-shops" title="Link to this heading">#</a></h2>
<p>Hedge funds used to be associated with Principal traders</p>
<ul class="simple">
<li><p>George Soros</p></li>
<li><p>Julian Robertson</p></li>
<li><p>David Tepper</p></li>
<li><p>Paul Tudor Jones</p></li>
<li><p>Steve Cohen</p></li>
<li><p>John Paulson</p></li>
</ul>
<p>Now we have the rise of Citadel and Millenium among a few others</p>
<p>Pod shops are organized totally different</p>
<p>Idea generation are done at the pod level in groups of 5-10 people</p>
<p>Capital is allocated to the pod by the hedge fund principal, who monitors exposures and hedges residual factor risk</p>
<p>Why pod traders work for Citadel and not choose to manager their own fund?</p>
<p><strong>A calculation</strong></p>
<p>Consider a pod shop with N pods with SR sr and total vol <span class="math notranslate nohighlight">\(\sigma\)</span>, what is their alpha? What is their SR?</p>
<div class="math notranslate nohighlight">
\[E[\sum x^*_ir_i]=E[\sum \frac{\alpha_i}{\sigma^2_i}\alpha_i]=N*sr^2\]</div>
<div class="math notranslate nohighlight">
\[Var[\sum x^*_ir_i]=Var[\sum \frac{\alpha_i}{\sigma^2_i}\epsilon_i]=\sum (\frac{\alpha_i}{\sigma^2_i})^2Var[\epsilon_i]\]</div>
<div class="math notranslate nohighlight">
\[Var[\sum x^*_ir_i]=\sum (\frac{\alpha_i}{\sigma^2_i})^2\sigma^2_i=N sr^2\]</div>
<p>so the standard deviation of the pool of pods is</p>
<div class="math notranslate nohighlight">
\[sr_{pool}=\frac{Nsr_{pod}^2}{\sqrt{N}sr_{pod}}=\sqrt{N}sr_{pod}\]</div>
<p>The Sharpe ratio of the pool of pods grows with the number of pods</p>
<p>This means that if managed individually, the average pod will accumulate wealth at rate <span class="math notranslate nohighlight">\(\sigma*sr\)</span></p>
<p>But if managed in a pool structure, the average pod will accumulate as <span class="math notranslate nohighlight">\(\sqrt{N}\sigma*sr\)</span></p>
<p>find a new uncorrelated idea is super valuable!</p>
<p>The marginal change in cash flows are</p>
<div class="math notranslate nohighlight">
\[\frac{\sigma*sr_{pool}}{N}\]</div>
<ul class="simple">
<li><p>decreases in the number of pods</p></li>
<li><p>But always positive–if indeed similar SR and uncorrelated!</p></li>
</ul>
<p>Note that is Under-estimates the value of the pod structure</p>
<ul class="simple">
<li><p>The higher your Sharpe ratio, the more volatility you can take without bearing significant risk of loss (wealth jsut grows too quickly)</p></li>
</ul>
<p>But it also not realistic</p>
<ul class="simple">
<li><p>Your marginal pod is likely to be worse or correlated with the others</p></li>
</ul>
</section>
<section id="volatility-management">
<h2>Volatility Management<a class="headerlink" href="#volatility-management" title="Link to this heading">#</a></h2>
<p>While detecting alpha/risk-premia variation of a strategy in real time is nearly impossible, we learned a few classes ago that we cna detect volatility variation really well.</p>
<p>These ideas together imply that you probably can do better by timing volatility</p>
<p>(here the t subscript denote the distribution of returns for date t+1 as of date t when I make the portfolio allocation)</p>
<p>The crucial necessary condition for this to work is that there is no time-series relationship between alphas and vols</p>
<div class="math notranslate nohighlight">
\[cov(\alpha_{i,t},\sigma^2_{i,t})=0\]</div>
<p>This is key. Might or might not be true. But tends to be true.</p>
<p>(actually we only need that relationship is weak enough)</p>
<p>This is true for example in case alpha is constant, or a the very least, you cannot predict variation in it.</p>
<p>Then your optimal portfolio allocation becomes <span class="math notranslate nohighlight">\(x_i=\frac{\alpha_i}{\sigma_{i,t}^2}\)</span></p>
<p>So the Sharpe ratio is</p>
<div class="math notranslate nohighlight">
\[SR_{\sigma}=\frac{E[x_{i,t}r_{i,t+1}]}{\sqrt{Var(x_{i,t}r_{i,t+1})}}\]</div>
<div class="math notranslate nohighlight">
\[SR_{\sigma}=\frac{E[\frac{\alpha_i}{\sigma_{i,t}^2}r_{i,t+1}]}{\sqrt{Var(\frac{\alpha_i}{\sigma_{i,t}^2}r_{i,t+1})}}\]</div>
<div class="math notranslate nohighlight">
\[SR_{\sigma}=\alpha_i\sqrt{E\left[\frac{1}{\sigma_{i,t}^2}\right]}\]</div>
<p>So it implies</p>
<div class="math notranslate nohighlight">
\[SR_{\sigma}=SR\sqrt{E[\sigma_{i,t}^2E\left[\frac{1}{\sigma_{i,t}^2}\right]}\]</div>
<p>In general <span class="math notranslate nohighlight">\(SR_{\sigma}&gt;SR\)</span> because of jensen inequality (<span class="math notranslate nohighlight">\(E[F(x)]\geqF(E[X])\)</span> if F is  convex)</p>
<p>to get some clean closed formulas lets assum</p>
<p><span class="math notranslate nohighlight">\(\sigma_{t}^2=\sigma^2 e^{\epsilon-\frac{1}{2}\sigma^2_{\sigma}}\)</span>, with <span class="math notranslate nohighlight">\(\epsilon\sim N(0,\sigma^2_{\sigma})\)</span></p>
<p>which satisfied <span class="math notranslate nohighlight">\(E[\sigma_t]=\sigma\)</span></p>
<div class="math notranslate nohighlight">
\[SR_{\sigma}=SR*e^{\frac{1}{4}\sigma^2_{\sigma}}\]</div>
<p>The more volatility variation you can predict, higher <span class="math notranslate nohighlight">\(\sigma_{\sigma}\)</span>, the higher the boost in you Sharpe ratio</p>
</section>
<section id="volatility-managing-the-market">
<h2>Volatility managing the market<a class="headerlink" href="#volatility-managing-the-market" title="Link to this heading">#</a></h2>
<blockquote>
<div><p>ALAN MOREIRA, TYLER MUIR, Volatility-Managed Portfolios, Journal of Finance, August 2017
<a class="reference external" href="https://doi.org/10.1111/jofi.12513">https://doi.org/10.1111/jofi.12513</a></p>
</div></blockquote>
<p>Show that this logic works for the market and many other factors. Since then a huge literature has emerged showing that volatility managing is a great way to boost Sharpe Ratios</p>
<div class="math notranslate nohighlight">
\[x_t=\frac{E[r^e_{t+1}]}{Var_t(r^e_{t+1})}\]</div>
<p>The key is to construct a good measure for <span class="math notranslate nohighlight">\( Var_t(r^e_{t+1})\)</span></p>
<ul>
<li><p>there are many things that you can do here (see our discussion in the estimation class)</p></li>
<li><p>We will do something simple and use past vol as a proxy for future vol</p></li>
<li><p>Of course whether isa good proxy or not depends of how it plays out in the data</p></li>
<li><p>But as we saw there is tons of volatility clustering so it is likely a good proxy even if not perfect</p></li>
<li><p>Using daily data for month t, construct the market return “realized variance” during month t</p>
<div class="math notranslate nohighlight">
\[rv_t=\sum_{d \in days~ in ~month ~t}\frac{(r_d- \overline{r})^2}{N_{days}},\]</div>
</li>
</ul>
<p>where <span class="math notranslate nohighlight">\(\overline{r}\)</span> is the average return within the month</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_factor</span> <span class="o">=</span> <span class="n">get_factors</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\Users\alan.moreira\Anaconda3\lib\site-packages\pandas_datareader\famafrench.py:114: FutureWarning: The argument &#39;date_parser&#39; is deprecated and will be removed in a future version. Please use &#39;date_format&#39; instead, or read your data in as &#39;object&#39; dtype and then call &#39;to_datetime&#39;.
  df = read_csv(StringIO(&quot;Date&quot; + src[start:]), **params)
</pre></div>
</div>
</div>
</div>
</section>
<section id="constructing-monthly-realized-variance-from-daily-data">
<h2><strong>Constructing monthly realized variance from daily data</strong><a class="headerlink" href="#constructing-monthly-realized-variance-from-daily-data" title="Link to this heading">#</a></h2>
<p>You basically use pandas time series function that shifts all dates to the end of the month, so this way you are technically grouping by the end of the month day.</p>
<p>Now  I use groupby <code class="docutils literal notranslate"><span class="pre">endofmonth</span></code> to put  all returns of given “year-month” pair together (i.e. with the same date)</p>
<p>So I can just compute the variance of this group (say 1/1/2020,1/2/2020,…1/31/2020) will all be 1/31/2020</p>
<p>This will return the daily variance in that month</p>
<p>If I multiply by the average number of trading days I get the monthly realized variance</p>
<p>To be more precise I will simply sum the square deviations of the mean (what this adjusts for?)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pandas.tseries.offsets</span><span class="w"> </span><span class="kn">import</span> <span class="n">MonthEnd</span>
<span class="n">endofmonth</span><span class="o">=</span><span class="n">df_factor</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">RV</span><span class="o">=</span><span class="n">df_factor</span><span class="p">[[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">endofmonth</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="c1"># rename column to clarify</span>
<span class="n">RV</span><span class="o">=</span><span class="n">RV</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">:</span><span class="s1">&#39;RV&#39;</span><span class="p">})</span>
<span class="n">RV</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">RV</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>RV</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07-31</th>
      <td>0.000492</td>
    </tr>
    <tr>
      <th>1926-08-31</th>
      <td>0.000878</td>
    </tr>
    <tr>
      <th>1926-09-30</th>
      <td>0.000565</td>
    </tr>
    <tr>
      <th>1926-10-31</th>
      <td>0.001689</td>
    </tr>
    <tr>
      <th>1926-11-30</th>
      <td>0.000336</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../../_images/b8056194ef1aed8ad6df015e25a1c1232861b83347757f3a3f0b8cdf917aee9d.png" src="../../_images/b8056194ef1aed8ad6df015e25a1c1232861b83347757f3a3f0b8cdf917aee9d.png" />
</div>
</div>
<p>Note how clustered volatility is</p>
<p>If variance was high this month, probably will be high next month too</p>
<p>You certainly can do better</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># aggregate daily returns to monthly returns</span>
<span class="n">Ret</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">df_factor</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">endofmonth</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
<span class="c1"># rename columns to clarify</span>
<span class="c1"># Merge Ret (monthly return) with RV (realized variance and weights)</span>
<span class="n">df</span><span class="o">=</span><span class="n">RV</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">Ret</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># construct excess returns</span>

<span class="c1"># lag RV by one month</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;RV_lag&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;RV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RV        0.002429
RF        0.002686
Mkt-RF    0.006849
RV_lag    0.002431
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create quantile groups based on the RV variable</span>


<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Quantile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;RV_lag&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Group by quantile and calculate the mean for each column</span>
<span class="n">quantile_means</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Quantile&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">quantile_means</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">quantile_means</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">left</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>


<span class="n">quantile_means</span> <span class="p">[</span><span class="s1">&#39;priceofrisk&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">quantile_means</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">quantile_means</span><span class="p">[</span><span class="s1">&#39;RV&#39;</span><span class="p">])</span>


<span class="c1"># Display the mean of quantiles for each column</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">((</span><span class="n">quantile_means</span><span class="o">.</span><span class="n">RV</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Realized Variance (RV(t+1)) by RV(t) Quantile &#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Vol(t+1)&#39;</span><span class="p">)</span>

<span class="p">(</span><span class="n">quantile_means</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Market Excess Return (t+1) by RV(t) Quantile&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">)</span>

<span class="n">quantile_means</span><span class="o">.</span><span class="n">priceofrisk</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Price of Risk by Quantile by RV(t) Quantile&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price of Risk&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Quantile&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\alan.moreira\AppData\Local\Temp\ipykernel_9296\1968402388.py:7: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  quantile_means = df.groupby(&#39;Quantile&#39;).mean()
C:\Users\alan.moreira\AppData\Local\Temp\ipykernel_9296\1968402388.py:8: RuntimeWarning: invalid value encountered in scalar power
  quantile_means.index = quantile_means.index.map(lambda x: round((x.left*12)**0.5, 2))
</pre></div>
</div>
<img alt="../../_images/a360d081f910d5af87ae16fbd0f879bf32d184e62c23e745e883cc6517f0bde0.png" src="../../_images/a360d081f910d5af87ae16fbd0f879bf32d184e62c23e745e883cc6517f0bde0.png" />
</div>
</div>
<p>We see that following months of high variance–on the right– you don’t really get higher returns</p>
<p>if you focus on the ratio – the price of risk</p>
<div class="math notranslate nohighlight">
\[E[\frac{r^e_{t+1}}{RV_{t+1}(r^e)}|RV_t]\]</div>
<p>you see that it is massively decreasing with variance</p>
<p>Average returns are not constant–<strong>but are close to</strong>–</p>
<p>so the natural strategy to exploit this pattern is to lever up when vol is low and reduce exposure when vol is high.</p>
<p>Specifically we Buy the market at the closing price of month t according to the rule:</p>
<div class="math notranslate nohighlight">
\[w_t=\frac{c}{rv_t},\]</div>
<p>If W&lt;1, invest in the risk-free rate, if w&gt;1, borrow to fund a bigger position</p>
<p>where <span class="math notranslate nohighlight">\(c\)</span> is some constant.</p>
<ul class="simple">
<li><p>Hold the position for a month</p></li>
<li><p>The returns of the strategy are given by</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ r^{VolTiming}_{t+1}=r_{f,t+1}+\frac{c}{rv_t}r^{MKT-RF}_{t+1}\]</div>
</section>
<section id="from-signal-to-weights">
<h2><strong>From signal to weights</strong><a class="headerlink" href="#from-signal-to-weights" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>weight on the market:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[x_t=c\frac{1}{rv_t}\]</div>
<ul class="simple">
<li><p>weight on the risk-free rate: <span class="math notranslate nohighlight">\(1-x_t\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(c\)</span> controls how levered is the strategy on average.</p></li>
<li><p>As we saw before all timing strategies involved some in and out of the market, but you also need to determine the average position. That is the role of <span class="math notranslate nohighlight">\(c\)</span>.</p></li>
<li><p>There are many ways to choose c</p></li>
<li><p>while c does not impact the strategy Sharpe Ratio, it impacts the amount of leverage that the strategy will take</p></li>
<li><p>Here lets keep it simple and simply choose it so that the position on the market is 1 on average</p></li>
</ul>
<div class="math notranslate nohighlight">
\[E[x_t]=E[c\frac{1}{rv_t}]=1\]</div>
<p>implies <span class="math notranslate nohighlight">\(c=\frac{1}{E[\frac{1}{rv_t}]}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate weights for the risky assets (market)</span>
<span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">df</span><span class="o">.</span><span class="n">RV_lag</span><span class="o">*</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Weight&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">c</span><span class="o">/</span><span class="n">df</span><span class="o">.</span><span class="n">RV_lag</span>

<span class="n">df</span><span class="o">.</span><span class="n">Weight</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">Weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
<img alt="../../_images/84d43b79e360521bb53b9e6dc377b93b21ae0efedc4c75356f983d8564f2cb0e.png" src="../../_images/84d43b79e360521bb53b9e6dc377b93b21ae0efedc4c75356f983d8564f2cb0e.png" />
</div>
</div>
<p>You see that leverage gets really high.</p>
<p>As high as 10!</p>
<p>You can see that in your position in the risk-free rate which exactly mirrors that</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the weights on the risk-free rate</span>
<span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">df</span><span class="o">.</span><span class="n">Weight</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6a8001cf0920a43f16cbfab9a763def912665428cdf198f1b2835cfba8ff56ba.png" src="../../_images/6a8001cf0920a43f16cbfab9a763def912665428cdf198f1b2835cfba8ff56ba.png" />
</div>
</div>
</section>
<section id="construct-strategy-returns">
<h2><strong>Construct strategy returns</strong><a class="headerlink" href="#construct-strategy-returns" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Now to construct the strategy return recall that we use the relaized variance in month t to buy the market at the closing of month t and earn the return accrued in month t+1</p></li>
<li><p>I will call the strategy as <span class="math notranslate nohighlight">\(\textbf{VMS}\)</span> (Volatility Managed Strategy)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># now construct the return of the strategy</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;VMS&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">Weight</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We can see the cumulative returns of the market and the volatility managed strategy</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;VMS&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;Date&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/3b2e30dc335293360fc65c2d0b5240978bd4cff7bc79007d94f36bf09da8966c.png" src="../../_images/3b2e30dc335293360fc65c2d0b5240978bd4cff7bc79007d94f36bf09da8966c.png" />
</div>
</div>
<p><strong>Sharpe ratio</strong></p>
<p>The VMS strategy ends up with a 20% higher Sharpe Ratio</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;VMS&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;VMS&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">*</span><span class="mi">12</span><span class="o">**</span><span class="mf">0.5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mkt-RF    0.445526
VMS       0.548945
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><strong>Tail risk</strong></p>
<p>The VMS bears substantially less tail risk as well</p>
<p>We can look at the the percentile 0.5% of the return distribution</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;VMS&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mkt-RF   -0.181863
VMS      -0.139248
Name: 0.005, dtype: float64
</pre></div>
</div>
</div>
</div>
<p><strong>Things to try</strong></p>
<ul class="simple">
<li><p>How well it works with VIX instead of RV?</p></li>
<li><p>How well it works with standard deviation instead of variance</p></li>
<li><p>How well it works if we put leverage limits</p></li>
<li><p>How well it works if we combine an expected return signal with the volatility signal?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">volmanaged</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">factor</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">name</span>
    <span class="n">endofmonth</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">RV</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">endofmonth</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">Signal</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">RV</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Signal</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;signal&#39;</span>

    <span class="n">Ret</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">endofmonth</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
    <span class="c1"># rename columns to clarify</span>
    <span class="c1"># Merge Ret (monthly return) with RV (realized variance and weights)</span>
    <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Signal</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">Ret</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>



    <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">signal</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Weight&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">c</span><span class="o">/</span><span class="n">df</span><span class="o">.</span><span class="n">signal</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;VMS&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">Weight</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span>
    <span class="n">SR</span><span class="o">=</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">df</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">*</span><span class="mi">12</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">TR</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SR</span><span class="p">,</span><span class="n">TR</span><span class="p">,</span><span class="n">df</span>

<span class="n">volmanaged</span><span class="p">(</span><span class="n">df_factor</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">])</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(RV        1.664722
 Mkt-RF    0.445526
 RV_lag    1.664846
 Weight    3.143894
 VMS       0.514105
 dtype: float64,
 RV        0.000113
 Mkt-RF   -0.181863
 RV_lag    0.000113
 Weight    0.021742
 VMS      -0.139248
 Name: 0.005, dtype: float64,
                   RV    Mkt-RF    RV_lag    Weight       VMS
 Date                                                        
 1926-07-31  0.000492  0.028846       NaN       NaN       NaN
 1926-08-31  0.000878  0.026697  0.000492  1.497461  0.039977
 1926-09-30  0.000565  0.003724  0.000878  0.839167  0.003125
 1926-10-31  0.001689 -0.033011  0.000565  1.304151 -0.043051
 1926-11-30  0.000336  0.025847  0.001689  0.436231  0.011275
 ...              ...       ...       ...       ...       ...
 2024-06-30  0.000329  0.027796  0.000761  0.968390  0.026917
 2024-07-31  0.001757  0.011986  0.000329  2.236833  0.026810
 2024-08-31  0.003530  0.015949  0.001757  0.419311  0.006687
 2024-09-30  0.001580  0.017348  0.003530  0.208700  0.003620
 2024-10-31  0.001086 -0.009699  0.001580  0.466396 -0.004524
 
 [1180 rows x 5 columns])
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-bond-equity-strategic-investment-problem-of-an-international-investor">
<h2>A bond-equity strategic investment problem of an international investor<a class="headerlink" href="#a-bond-equity-strategic-investment-problem-of-an-international-investor" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>we will assume here that the risk-premium is being generated from a constant distribution</p></li>
<li><p>this is wrong, but for large well diversified portfolio not too bad</p></li>
<li><p>under this assumption, our estimation problem amounts to using sample means</p></li>
<li><p>ths risk-free rate is time-varying so we will have to deal with it</p></li>
</ul>
<p>We start by loading out return data</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/amoreira2/Lectures/main/assets/data/GlobalFinMonthly.csv&quot;</span>
<span class="n">Data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">na_values</span><span class="o">=-</span><span class="mi">99</span><span class="p">)</span>
<span class="n">Data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
<span class="n">Data</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
<span class="c1"># the assets are the risk-free rate, the us equity market, the us bond market, the emerging market, the global equity market (without US), and the global bond market (without US)</span>

<span class="n">Data</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="s2">&quot;MKTUS&quot;</span><span class="p">,</span><span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="s2">&quot;BondUS&quot;</span><span class="p">,</span>
                          <span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="s2">&quot;EM&quot;</span><span class="p">,</span><span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="s2">&quot;MKTxUS&quot;</span><span class="p">,</span><span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="s2">&quot;BondxUS&quot;</span> <span class="p">})</span>
<span class="n">Data</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>RF</th>
      <th>MKTUS</th>
      <th>BondUS</th>
      <th>EM</th>
      <th>MKTxUS</th>
      <th>BondxUS</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2016-08-31</th>
      <td>0.0002</td>
      <td>0.0052</td>
      <td>-0.008417</td>
      <td>0.025186</td>
      <td>0.000838</td>
      <td>-0.009552</td>
    </tr>
    <tr>
      <th>2016-09-30</th>
      <td>0.0002</td>
      <td>0.0027</td>
      <td>-0.016417</td>
      <td>0.013153</td>
      <td>0.012736</td>
      <td>0.009979</td>
    </tr>
    <tr>
      <th>2016-10-31</th>
      <td>0.0002</td>
      <td>-0.0200</td>
      <td>-0.049460</td>
      <td>0.002474</td>
      <td>-0.020383</td>
      <td>-0.043476</td>
    </tr>
    <tr>
      <th>2016-11-30</th>
      <td>0.0001</td>
      <td>0.0487</td>
      <td>-0.081636</td>
      <td>-0.045971</td>
      <td>-0.019798</td>
      <td>-0.050359</td>
    </tr>
    <tr>
      <th>2016-12-31</th>
      <td>0.0003</td>
      <td>0.0185</td>
      <td>-0.005296</td>
      <td>0.002904</td>
      <td>0.034383</td>
      <td>-0.023207</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we start by constructing excess returns by subtracting the risk-free rate from the returns of the assets and we drop the risk-free rate column</span>
<span class="n">Re</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># we compute the mean and covariance matrix of the excess returns</span>
<span class="n">ERe</span><span class="o">=</span><span class="n">Re</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ERe</span><span class="p">)</span>
<span class="n">Cove</span><span class="o">=</span><span class="n">Re</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Cove</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MKTUS      0.005140
BondUS     0.002523
EM         0.006923
MKTxUS     0.004149
BondxUS    0.002054
dtype: float64
            MKTUS    BondUS        EM    MKTxUS   BondxUS
MKTUS    0.001948  0.000111  0.001292  0.001264  0.000187
BondUS   0.000111  0.001227 -0.000204 -0.000013  0.000264
EM       0.001292 -0.000204  0.003556  0.001661  0.000249
MKTxUS   0.001264 -0.000013  0.001661  0.002182  0.000422
BondxUS  0.000187  0.000264  0.000249  0.000422  0.000407
</pre></div>
</div>
</div>
</div>
<p>Suppose I want to reconstruct my current estimates of Expected returns and the covariance matrix of returns ( and not excess returns), What do I do?</p>
<p>Simply add the current risk-free rate to you estimate of the expected return</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the risk-free rate to the current value of the 3-month T-bill rate divided by 12 to make it a monthly rate</span>
<span class="n">rf</span><span class="o">=</span><span class="mf">0.0525</span><span class="o">/</span><span class="mi">12</span>
<span class="c1"># add to our estimate of risk-premiumns to get our estimate of expected returns</span>

<span class="n">ER</span><span class="o">=</span><span class="n">ERe</span><span class="o">+</span><span class="n">rf</span>
</pre></div>
</div>
</div>
</div>
<p>What about the covariance piece?</p>
</section>
<section id="numerical-solution">
<h2>Numerical solution<a class="headerlink" href="#numerical-solution" title="Link to this heading">#</a></h2>
<p>Lets start by solving</p>
<p><span class="math notranslate nohighlight">\( \max_X E[X'R_T]\)</span> subject to <span class="math notranslate nohighlight">\(Var(X'R_T)\leq Vmax\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># STEP 1: define the fucntion that computes the portfolio variance and expected returns given a vector of weights X (initially set to equal weights)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">portfolio_variance</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">X</span> <span class="o">@</span> <span class="n">Cove</span> <span class="o">@</span> <span class="n">X</span>

<span class="k">def</span><span class="w"> </span><span class="nf">portfolio_expected_return</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">):</span>
     <span class="k">return</span> <span class="n">X</span> <span class="o">@</span> <span class="n">ER</span>

<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_expected_return</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0007914039297139135
0.0008490361488465391
0.008532889760767246
0.00820649669319938
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># STEP 2: define the constraint functions, </span>

<span class="c1"># here we will have one inequality for the portfolio variance , lets say a volatility of 10% per year. How do we translate this into a monthly variance?</span>

<span class="c1"># and one equality constraint for the weights to sum to one</span>



<span class="n">Vmax</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>
<span class="n">cons</span><span class="o">=</span> <span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span>
          <span class="s1">&#39;fun&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="o">-</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">+</span><span class="n">Vmax</span><span class="p">},</span>
          <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span>
          <span class="s1">&#39;fun&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">})</span>

<span class="c1"># the constraint is normalized so that</span>

<span class="c1">#cons=({&#39;type&#39;: &#39;ineq&#39;,</span>
<span class="c1">#          &#39;fun&#39; : lambda X: F(X)})</span>

<span class="c1">#means F(X)&gt;=0</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Finally we are ready to do our minimization</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">options={'disp':</span> <span class="pre">True}</span></code>: tell python to report intermediary steps so we can check if the algorithm is doing progress towards a solution.</p></li>
<li><p>There is a variety of additional parameters that you can pass to the minimizer.</p></li>
<li><p>see: <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html">https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># STEP 3: solve the minimization problem with constraints and save as `sol`</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimize</span>
<span class="n">X0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="o">-</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="n">X0</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.011929088527573371
            Iterations: 13
            Function evaluations: 78
            Gradient evaluations: 13
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#optimal weights</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="c1"># optimal expected return at the annual frequency</span>
<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span>
<span class="c1"># optimal portfolio volatility at the annual frequenc</span>
<span class="p">(</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 0.65116149  0.38641724  0.83880728 -0.36993912 -0.50644688]
0.14314906233088046
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.20000201016577546
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># below I am plotting the solution weights.</span>
<span class="n">width</span><span class="o">=</span><span class="mf">0.3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">width</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ER</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/70226f2c4c03e77906a060eca77c2483f49d49a004270d09707785a6327979b0.png" src="../../_images/70226f2c4c03e77906a060eca77c2483f49d49a004270d09707785a6327979b0.png" />
</div>
</div>
<p>Here we assumed the portfolio has to be fully invested in risky assets.</p>
<p>There is no leverage (borrowing at the risk-free rate)</p>
<p>but there is shorting (raising additional funds by selling one asset)</p>
<p>Note that is X0+X1=1, if X0&lt;0, then X1&gt;1</p>
</section>
<section id="introducing-a-benchmark">
<h2>Introducing a benchmark<a class="headerlink" href="#introducing-a-benchmark" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>in mutual funds there is often a benchmark, say the S&amp;P 500 and the manager has a mandate to have a tracking error relative to the benchmark that is low enough, say <span class="math notranslate nohighlight">\(Tmax\)</span></p></li>
<li><p>and the manager is compensated only with respect to the returns above this benchmark</p></li>
<li><p>tracking error is the volatility of the portfolio relative to the benchmark: <span class="math notranslate nohighlight">\(\sqrt{var(X'R_T-R^{benchmark}_T)}\)</span></p></li>
</ul>
<p>The manager problem is ro maximize benchmark adjusted returns subject to some tracking error constraint</p>
<p><span class="math notranslate nohighlight">\( \max_X E[X'R_T-R^{benchmark}_T]\)</span> subject to <span class="math notranslate nohighlight">\(Var(X'R_T-R^{benchmark}_T)\leq Tmax\)</span></p>
<p>Assuming benchmark is in set of traded assets, you car write</p>
<p><span class="math notranslate nohighlight">\( \max_X E[X'R_T-1_b'R_T]\)</span> subject to <span class="math notranslate nohighlight">\(Var(X'R_T-1_b'R_T)\leq Tmax\)</span></p>
<p>Which can be written as</p>
<p><span class="math notranslate nohighlight">\( \max_X E[(X-1_b)'R_T]\)</span> subject to <span class="math notranslate nohighlight">\((X-1_b)'Var(R_T)(X-1_b)\leq Tmax\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">portfolio_variance</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span><span class="n">Xbenchmark</span><span class="p">)</span><span class="o">@</span> <span class="n">Cove</span> <span class="o">@</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">Xbenchmark</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">portfolio_expected_return</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])):</span>
     <span class="k">return</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">Xbenchmark</span><span class="p">)</span> <span class="o">@</span> <span class="n">ER</span>


<span class="n">Xb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Vmax</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>
<span class="n">cons</span><span class="o">=</span> <span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span>
          <span class="s1">&#39;fun&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="o">-</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">Xb</span><span class="p">)</span><span class="o">+</span><span class="n">Vmax</span><span class="p">},</span>
          <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span>
          <span class="s1">&#39;fun&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">})</span>

<span class="n">X0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span>
<span class="n">solb</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="o">-</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">Xb</span><span class="p">),</span><span class="n">X0</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.005220575391068462
            Iterations: 15
            Function evaluations: 90
            Gradient evaluations: 15
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">Cove</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="c1">#optimal weights no benchmark</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="c1">#optimal weights with benchmark</span>
<span class="nb">print</span><span class="p">(</span><span class="n">solb</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;MKTUS&#39;, &#39;BondUS&#39;, &#39;EM&#39;, &#39;MKTxUS&#39;, &#39;BondxUS&#39;], dtype=&#39;object&#39;)
[ 0.65116149  0.38641724  0.83880728 -0.36993912 -0.50644688]
[ 1.71916096  0.06129325  0.73328686 -0.28549667 -1.2282444 ]
</pre></div>
</div>
</div>
</div>
<p>What happen here? Why the position in the market went up? Is that what you would expect?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># optimal expected return at the annual frequency</span>
<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">solb</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span>
<span class="c1"># portfolio volatility pf optimal portfolio at the annual frequency</span>
<span class="nb">print</span><span class="p">((</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">solb</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
<span class="c1">#Trackign error</span>
<span class="nb">print</span><span class="p">((</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">solb</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">Xb</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
<span class="c1">#Benchmark adjsuted returns</span>
<span class="nb">print</span><span class="p">((</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">solb</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">Xb</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="information-ratio">
<h2>Information Ratio<a class="headerlink" href="#information-ratio" title="Link to this heading">#</a></h2>
<p>Information ratio is how much you are expected to make in excess of the benchmark, divided by how much risk you are taking relative to the benchmark</p>
<div class="math notranslate nohighlight">
\[InformationRatio=\frac{E[r_p-r_b]}{\sigma(r_p-r_p)}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#The information ratio is the benchmark adjusted return divided by the tracking error</span>
<span class="nb">print</span><span class="p">((</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">Xb</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">Xb</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.31322388844974003
</pre></div>
</div>
</div>
</div>
<p>Other things to do</p>
<p>Trace out how the optimal expected return varies as you change Vmax. In yearly volatility units try 6.5%, 7%, 8% , 10% ,15%,30%. Plot the resulting pairs in the scatter plot with the expected return in the y-axis and the volatility in the x-axis. What do you find?</p>
<p>Add the risk-free rate among the assets. There are different ways to do this. But a simple one is to change the expected return function  <code class="docutils literal notranslate"><span class="pre">X&#64;ER+(1-np.sum(X))*rf</span></code></p>
<ul class="simple">
<li><p>now X is the vector of risky assets only and (1-np.sum(X)) is whatever is the residual</p></li>
<li><p>if this residual is positive you park in cash and earn rf</p></li>
<li><p>if negative you borrow at the rf rate</p></li>
<li><p>now your total weights mechanically add up to 1</p></li>
<li><p>so you need to take out the equality constraint</p></li>
</ul>
<p>Add a shorting constraint, say you can only short equities but not bonds, that is X&gt;0 for certain assets</p>
<p>Add a leverage cap, so that the sum of your risky assets cannot exceed 1 too much, np.sum(X)-1 is called your leverage, so you can limit it to 1, so that for each dollar you have you borrow at most 1 dollar</p>
<p>Modify the expected return function to incorporate practical frictions in trading. For example, when you borrow you typically pay more than what you can invest at, there is a borrowing spread. Analogously if you short a stock, you have to pay an extra fee</p>
</section>
<section id="analytical-solution">
<h2>Analytical solution<a class="headerlink" href="#analytical-solution" title="Link to this heading">#</a></h2>
<p>The analytical solution assumes</p>
<ul class="simple">
<li><p>free borrowing and lending at risk-free rate</p></li>
<li><p>Shorting without any shorting fees</p></li>
</ul>
<p>The optimal weights are</p>
<div class="math notranslate nohighlight">
\[X=\sqrt{\frac{Vmax}{E[R^e]'Var(R^e)^{-1}E[R^e]}}Var(R^e)^{-1}E[R^e]\]</div>
<p>Where Vmax is in monthly variance units</p>
<p>Note that <span class="math notranslate nohighlight">\(\frac{Vmax}{E[R^e]'Var(R^e)^{-1}E[R^e]}\)</span> is a number. Is basically a leverage factor. It leverage up (or down) the portfolio <span class="math notranslate nohighlight">\(Var(R^e)^{-1}E[R^e]\)</span> so that the resulting portfolio has the desired target variance</p>
<p>This portfolio <span class="math notranslate nohighlight">\(Var(R^e)^{-1}E[R^e]\)</span> is quite special because it has the highest Sharpe-ratio among all possible combinations of these assets</p>
</section>
<section id="sharpe-ratio">
<h2>Sharpe-ratio !<a class="headerlink" href="#sharpe-ratio" title="Link to this heading">#</a></h2>
<p>Sharpe ratio is probably the most used concept in money management, it comes in honor of William Sharpe ( the dude that discovered the CAPM). It reflects how much additional expected return you are getting per unit of volatility. Say you have a portfolio with expected returns <span class="math notranslate nohighlight">\(E[r_p]\)</span></p>
<div class="math notranslate nohighlight">
\[SharpeRatio=\frac{E[r_p]-rf}{\sigma(R_p)}\]</div>
<p>So a portfolio that has the highest sharpe ratio is nice because it is efficient.</p>
<p>You take the minimum amount of risk that you need to take to achieve a expected return</p>
<p>or conversely you get the maximum possible expected return for a given level of risk that you are willing to take</p>
<hr class="docutils" />
<p><em>Aside: Matrix inversion</em></p>
<ul class="simple">
<li><p>You only need to understand how to operationaize it and in an conceptual level what it does</p></li>
<li><p>But you don’t need to follow all the mathematical details</p></li>
<li><p>If you are interested. you can look in our linear algebra review in <a class="reference external" href="https://amoreira2.github.io/quantitativeinvesting/chapters/scientific/linear_algebra1.html">https://amoreira2.github.io/quantitativeinvesting/chapters/scientific/linear_algebra1.html</a></p></li>
<li><p>I also provide a summary below</p></li>
<li><p>Note that <span class="math notranslate nohighlight">\((2)^{-1}=1/2=0.5\)</span> (naturally!)</p></li>
<li><p><span class="math notranslate nohighlight">\((Var(R^e))^{-1}\)</span> is just like this</p></li>
<li><p>but more complicated because <span class="math notranslate nohighlight">\(Var(R^e)\)</span> is a N by N matrix and we can’t simply divide over to solve for X</p></li>
<li><p>The definition of the inverse function is <span class="math notranslate nohighlight">\(f(x)=x^{-1}=y\)</span> where <span class="math notranslate nohighlight">\(y*x=1\)</span></p></li>
<li><p>for matrices it is the same: <span class="math notranslate nohighlight">\((Var(R^e))^{-1}Var(R^e)=I\)</span>, but now instead of 1, we have an identity matrix, which is a matrix with 1’s in the diagonal and zero everywhere else</p></li>
</ul>
<p>Thankfully we have a function in python that does just that</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># start with a 2 by 2 matrix</span>
<span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">9</span><span class="p">]])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="c1"># compute the inverse</span>
<span class="n">ainv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> 

<span class="n">ainv</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[3 7]
 [0 9]]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.33333333, -0.25925926],
       [ 0.        ,  0.11111111]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># indeed ainv is the inverse of a because ainv @ a = I</span>
<span class="n">ainv</span> <span class="o">@</span> <span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1., 0.],
       [0., 1.]])
</pre></div>
</div>
</div>
</div>
<p>This portfolio is very special so it has many names</p>
<ol class="arabic simple">
<li><p>maximum sharpe ratio portfolio</p></li>
<li><p>mean-variance efficient portfolio (MVE)</p></li>
<li><p>Tangency portfolio</p></li>
</ol>
<p>Names 1 and 2 are pretty clear. Name 3 will become clear later in the course</p>
</section>
<hr class="docutils" />
<section id="finding-the-mean-variance-efficient-portfolio">
<h2><strong>Finding the Mean-variance efficient portfolio</strong><a class="headerlink" href="#finding-the-mean-variance-efficient-portfolio" title="Link to this heading">#</a></h2>
<p>First lets construct our vector of expected excess returns for our risky two assets US equity market and International equity market</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">assets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MKTUS&#39;</span><span class="p">,</span><span class="s1">&#39;MKTxUS&#39;</span><span class="p">]</span>
<span class="n">e</span><span class="o">=</span><span class="n">ERe</span><span class="p">[</span><span class="n">assets</span><span class="p">]</span>

<span class="n">e</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MKTUS     0.005140
MKTxUS    0.004149
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We start by estimating the covariance matrix from our data <span class="math notranslate nohighlight">\(Var(R^e)\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">=</span><span class="n">Cove</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">assets</span><span class="p">,</span><span class="n">assets</span><span class="p">]</span>

<span class="n">c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MKTUS</th>
      <th>MKTxUS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>MKTUS</th>
      <td>0.001948</td>
      <td>0.001264</td>
    </tr>
    <tr>
      <th>MKTxUS</th>
      <td>0.001264</td>
      <td>0.002182</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We then invert the covariance matrix <span class="math notranslate nohighlight">\(Var(R^e)^{-1}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cinv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> 

<span class="n">cinv</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 822.50792137, -476.49212708],
       [-476.49212708,  734.40580739]])
</pre></div>
</div>
</div>
</div>
<p>we then use the dot product to cross-mulitply our vector of expected excess returns by the inverse of the covariance matrix</p>
<div class="math notranslate nohighlight">
\[Var(R^e)^{-1}E[R^e]\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Wmve</span><span class="o">=</span><span class="n">cinv</span> <span class="o">@</span> <span class="n">e</span>
<span class="n">Wmve</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([2.25099751, 0.597729  ])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vmax</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>
<span class="n">Wmve</span> <span class="o">*</span> <span class="p">(</span><span class="n">Vmax</span><span class="o">/</span><span class="p">(</span><span class="n">e</span> <span class="nd">@cinv</span> <span class="o">@</span> <span class="n">e</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.53401107, 0.14180109])
</pre></div>
</div>
</div>
</div>
<p>Things to try</p>
<p>Verify that indeed the entire class of portfolios that solve the problem for different variance targets Vmax are also MVE ( i.e they all have the max sharpe ratio)</p>
<p>What is the allocation to the risk-free rate? How do you find it? How does it change as you increase/decrease Vmax?</p>
<p>How does max SR change as you go from</p>
<ol class="arabic simple">
<li><p>only investing in the US equity market</p></li>
<li><p>investing in US equities and US bonds</p></li>
<li><p>Invest everywhere except emerging markets</p></li>
<li><p>investing everywhere including emerging markets</p></li>
<li><p>investing only in global equities and global bonds</p></li>
</ol>
<p>Compare the gains of investing domestically ( US equities and bonds)  with investing internationally as well (US equities, US bonds, Global equities, global bonds).</p>
<p>Why the SR is going up ?What properties of the returns moments the mean-variance optimizer are exploiting?</p>
<p>Do we think those are reliable properties? What is the alternative?</p>
<p>For the four investment opportunity sets above, compute the optimal expected returns for the following volatilities 6.5%, 7%, 8% , 10% ,15%,30%. Plot the results in a scatter plot with volatility in the X-axis and expected returns in the y-axis. You should see 5 lines. Why they look like that?</p>
<p>Compare the benefits of a US investor to invest globally and the benefit of an international investor investing in the US ( ignore Emerging markets). Looking at individual assets risk-premiums and volatility explain the benefits of investing across multiple assets</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./chapters/Not used"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-rise-of-pod-shops">The rise of “pod shops”</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#volatility-management">Volatility Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#volatility-managing-the-market">Volatility managing the market</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#constructing-monthly-realized-variance-from-daily-data"><strong>Constructing monthly realized variance from daily data</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#from-signal-to-weights"><strong>From signal to weights</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#construct-strategy-returns"><strong>Construct strategy returns</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-bond-equity-strategic-investment-problem-of-an-international-investor">A bond-equity strategic investment problem of an international investor</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numerical-solution">Numerical solution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introducing-a-benchmark">Introducing a benchmark</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#information-ratio">Information Ratio</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analytical-solution">Analytical solution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sharpe-ratio">Sharpe-ratio !</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-the-mean-variance-efficient-portfolio"><strong>Finding the Mean-variance efficient portfolio</strong></a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alan Moreira
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021 Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0).
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>