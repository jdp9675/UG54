
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Application: Market model &#8212; Quantitative Investing</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/book.css?v=c2893119" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/Finance/Untitled';</script>
    <link rel="canonical" href="https://amoreira2.github.io/Fin418/chapters/Finance/Untitled.html" />
    <link rel="icon" href="../../_static/figuremain2.jpg"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/figuremain2.jpg" class="logo__image only-light" alt="Quantitative Investing - Home"/>
    <script>document.write(`<img src="../../_static/figuremain2.jpg" class="logo__image only-dark" alt="Quantitative Investing - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01/what-is-quant-investing.html">1. What is Quantitative Investing?</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01/statistical-techniques.html">1.1. Statistical Techniques</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/computational-tools.html">1.2. Computational tools</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../02/getting_started.html">2. Getting Started</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02/cloud_setup.html">2.3. Cloud Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/local_install.html">2.4. Local installation</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../essentials/intro.html">3. Python Essentials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../essentials/basics.html">3.1. Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/collections.html">3.2. Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/numpy.html">3.3. Numpy</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../essentials/introtopandas.html">3.4. Pandas</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/the_index.html">3.4.3. Indexing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/timeseries.html">3.4.4. Time-Series</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/reshape.html">3.4.5. Reshape</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/merge.html">3.4.6. Merge</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/groupby.html">3.4.7. Group-by</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/matplotlib.html">3.4.8. Plotting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/data_clean.html">3.4.9. Cleaning data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/storage_formats.html">3.4.10. Data Storage</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/control_flow.html">3.5. Flow control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/functions.html">3.6. Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/plotting.html">3.7. Plotting</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="IntrotoReturns.html">4. Introduction to Asset Returns</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="TheChoiceofFrequency.html">4.4. The Choice of Frequency and Annualization of Returns</a></li>
<li class="toctree-l2"><a class="reference internal" href="UsingAPI.html">4.5. Data APIs</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="FactorModels.html">5. Factor Models</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="PortfolioMath.html">6. Portfolios</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../scientific/linear_algebra1.html">6.5. Linear Algebra Review</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="CapitalAllocationI.html">7. Capital Allocation</a></li>
<li class="toctree-l1"><a class="reference internal" href="FactorModelEstimation.html">8. Factor Model Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="CapitalAllocationII.html">9. Capital Allocation II</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="crosssectionalequitystrategies.html">10. Cross-Sectional Equity Strategies</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="Momentum.html">10.3. Momentum factor</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="Performance_evaluation.html">11. Performance Evaluation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="MultiFactorModels.html">12. Multi Factor Models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="Factors.html">12.9. An overview of factors</a></li>
<li class="toctree-l2"><a class="reference internal" href="InterpretingFactorModels.html">12.10. ðŸ“Š Interpreting Factor Models</a></li>


</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="MachineLearning.html">13. Machine Learning in Finance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/additional.html">14. Additional Statistics Material</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Assignments/Assignments.html">15. Assignments</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment0.html">15.1. Assigment 0</a></li>




<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment1.html">15.6. Assignment 1</a></li>


<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment2.html">15.9. Assignment 2</a></li>


<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment3.html">15.12. Assignment 3</a></li>


<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment4.html">15.15. Assignment 4</a></li>


</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/amoreira2/Fin418/blob/main/chapters/Finance/Untitled.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/amoreira2/Fin418" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/amoreira2/Fin418/issues/new?title=Issue%20on%20page%20%2Fchapters/Finance/Untitled.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/chapters/Finance/Untitled.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Application: Market model</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Application: Market model</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#application-minimum-variance-investing">Application: Minimum-variance investing</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#a-bond-equity-strategic-investment-problem-of-an-international-investor">A bond-equity strategic investment problem of an international investor</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#numerical-solution">Numerical solution</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introducing-a-benchmark">Introducing a benchmark</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#information-ratio">Information Ratio</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#analytical-solution">Analytical solution</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#sharpe-ratio">Sharpe-ratio !</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-the-mean-variance-efficient-portfolio"><strong>Finding the Mean-variance efficient portfolio</strong></a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">wrds</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas_datareader.data</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">web</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">wrds</span><span class="o">.</span><span class="n">Connection</span><span class="p">()</span>
<span class="n">sp500</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        select a.*, b.date, b.ret</span>
<span class="s2">                        from crsp.msp500list as a,</span>
<span class="s2">                        crsp.msf as b</span>
<span class="s2">                        where a.permno=b.permno</span>
<span class="s2">                        and b.date &gt;= a.start and b.date&lt;= a.ending</span>
<span class="s2">                        and b.date&gt;=&#39;01/01/2000&#39;</span>
<span class="s2">                        order by date;</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">date_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;ending&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WRDS recommends setting up a .pgpass file.
Created .pgpass file successfully.
You can create this file yourself at any time with the create_pgpass_file() function.
Loading library list...
Done
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sp500</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permno</th>
      <th>start</th>
      <th>ending</th>
      <th>date</th>
      <th>ret</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>77178</td>
      <td>1999-07-22</td>
      <td>2023-12-29</td>
      <td>2000-01-31</td>
      <td>-0.278921</td>
    </tr>
    <tr>
      <th>1</th>
      <td>48485</td>
      <td>1976-07-01</td>
      <td>2006-03-31</td>
      <td>2000-01-31</td>
      <td>-0.139194</td>
    </tr>
    <tr>
      <th>2</th>
      <td>19502</td>
      <td>1979-10-11</td>
      <td>2023-12-29</td>
      <td>2000-01-31</td>
      <td>-0.044872</td>
    </tr>
    <tr>
      <th>3</th>
      <td>28847</td>
      <td>1986-12-18</td>
      <td>2002-05-14</td>
      <td>2000-01-31</td>
      <td>-0.311891</td>
    </tr>
    <tr>
      <th>4</th>
      <td>56573</td>
      <td>1986-02-13</td>
      <td>2023-12-29</td>
      <td>2000-01-31</td>
      <td>-0.134135</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>144482</th>
      <td>22111</td>
      <td>1973-05-31</td>
      <td>2023-12-29</td>
      <td>2023-12-29</td>
      <td>0.013449</td>
    </tr>
    <tr>
      <th>144483</th>
      <td>44206</td>
      <td>2009-03-17</td>
      <td>2023-12-29</td>
      <td>2023-12-29</td>
      <td>0.050244</td>
    </tr>
    <tr>
      <th>144484</th>
      <td>23473</td>
      <td>1997-12-18</td>
      <td>2023-12-29</td>
      <td>2023-12-29</td>
      <td>0.013815</td>
    </tr>
    <tr>
      <th>144485</th>
      <td>77274</td>
      <td>2004-07-01</td>
      <td>2023-12-29</td>
      <td>2023-12-29</td>
      <td>0.067363</td>
    </tr>
    <tr>
      <th>144486</th>
      <td>10138</td>
      <td>1999-10-13</td>
      <td>2023-12-29</td>
      <td>2023-12-29</td>
      <td>0.087686</td>
    </tr>
  </tbody>
</table>
<p>144487 rows Ã— 5 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="o">=</span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
<span class="n">df2</span><span class="o">=</span><span class="n">ds</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
<span class="n">df3</span><span class="o">=</span><span class="n">ds</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
<span class="n">df1</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;returns&#39;</span>
<span class="n">df2</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nfirms&#39;</span>
<span class="n">df3</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;size&#39;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df1</span><span class="p">,</span><span class="n">df2</span><span class="p">,</span><span class="n">df3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">=</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;level_1&#39;</span><span class="p">:</span><span class="s1">&#39;industry&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../../assets/data/49_Industry_Portfolios.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="application-market-model">
<h1>Application: Market model<a class="headerlink" href="#application-market-model" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Create a date parser function that will allow pandas to read the dates in the format we have them</span>
<span class="n">date_parser</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;%Y%m&quot;</span><span class="p">)</span>
<span class="c1"># our 50 stock returns data</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/amoreira2/Fin418/main/assets/data/Retuns50stocks.csv&quot;</span>

<span class="c1"># Use pd.read_csv with the date_parser</span>
<span class="n">df</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">date_parser</span><span class="o">=</span><span class="n">date_parser</span><span class="p">)</span>
<span class="c1"># Set the date column as the index</span>

<span class="c1"># first, create the DataFrame</span>
<span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># put the returns in percentage format</span>
<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">/</span><span class="mi">100</span>
<span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
DatetimeIndex: 180 entries, 2000-01-01 to 2014-12-01
Data columns (total 51 columns):
 #   Column  Non-Null Count  Dtype  
---  ------  --------------  -----  
 0   CTL     180 non-null    float64
 1   T       180 non-null    float64
 2   CSCO    180 non-null    float64
 3   FCX     180 non-null    float64
 4   XL      180 non-null    float64
 5   IVZ     180 non-null    float64
 6   AMT     180 non-null    float64
 7   WHR     180 non-null    float64
 8   IR      180 non-null    float64
 9   WFT     180 non-null    float64
 10  YUM     180 non-null    float64
 11  CVS     180 non-null    float64
 12  GD      180 non-null    float64
 13  TYC     180 non-null    float64
 14  EL      180 non-null    float64
 15  MUR     180 non-null    float64
 16  CTAS    180 non-null    float64
 17  CBSA    180 non-null    float64
 18  SNV     180 non-null    float64
 19  CAM     180 non-null    float64
 20  DLTR    180 non-null    float64
 21  CAH     180 non-null    float64
 22  DTE     180 non-null    float64
 23  SSP     180 non-null    float64
 24  PSA     180 non-null    float64
 25  EXC     180 non-null    float64
 26  TKR     180 non-null    float64
 27  CMA     180 non-null    float64
 28  ORCL    180 non-null    float64
 29  MS      180 non-null    float64
 30  RSG     180 non-null    float64
 31  ACAS    180 non-null    float64
 32  AGN     180 non-null    float64
 33  MMM     180 non-null    float64
 34  ETFC    180 non-null    float64
 35  CAR     180 non-null    float64
 36  MDR     180 non-null    float64
 37  NOV     180 non-null    float64
 38  PCH     180 non-null    float64
 39  BAX     180 non-null    float64
 40  JCI     180 non-null    float64
 41  SWK     180 non-null    float64
 42  DVN     180 non-null    float64
 43  TMO     180 non-null    float64
 44  PEP     180 non-null    float64
 45  LNC     180 non-null    float64
 46  EMR     180 non-null    float64
 47  MLM     180 non-null    float64
 48  CCI     180 non-null    float64
 49  NU      180 non-null    float64
 50  Market  180 non-null    float64
dtypes: float64(51)
memory usage: 73.1 KB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load regression library</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>
<span class="c1"># add a constant to the independent variable</span>
<span class="n">x</span><span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Market&#39;</span><span class="p">])</span>
<span class="c1"># set the dependent variable to be the &#39;CTL&#39; return</span>
<span class="n">y</span><span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CTL&#39;</span><span class="p">]</span>
<span class="c1"># run the regression</span>
<span class="n">results</span><span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">results</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>           <td>CTL</td>       <th>  R-squared:         </th> <td>   0.171</td>
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th> <td>   0.167</td>
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th> <td>   36.81</td>
</tr>
<tr>
  <th>Date:</th>             <td>Mon, 29 Jan 2024</td> <th>  Prob (F-statistic):</th> <td>7.62e-09</td>
</tr>
<tr>
  <th>Time:</th>                 <td>18:02:15</td>     <th>  Log-Likelihood:    </th> <td>  214.56</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td>   180</td>      <th>  AIC:               </th> <td>  -425.1</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td>   178</td>      <th>  BIC:               </th> <td>  -418.7</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>     1</td>      <th>                     </th>     <td> </td>   
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>     <td> </td>   
</tr>
</table>
<table class="simpletable">
<tr>
     <td></td>       <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>const</th>  <td>    0.0019</td> <td>    0.006</td> <td>    0.340</td> <td> 0.734</td> <td>   -0.009</td> <td>    0.013</td>
</tr>
<tr>
  <th>Market</th> <td>    0.7269</td> <td>    0.120</td> <td>    6.068</td> <td> 0.000</td> <td>    0.491</td> <td>    0.963</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>43.729</td> <th>  Durbin-Watson:     </th> <td>   2.264</td>
</tr>
<tr>
  <th>Prob(Omnibus):</th> <td> 0.000</td> <th>  Jarque-Bera (JB):  </th> <td> 394.038</td>
</tr>
<tr>
  <th>Skew:</th>          <td> 0.524</td> <th>  Prob(JB):          </th> <td>2.73e-86</td>
</tr>
<tr>
  <th>Kurtosis:</th>      <td>10.172</td> <th>  Cond. No.          </th> <td>    21.8</td>
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</div></div>
</div>
<p>Interpretation:</p>
<p>The coefficient on the market estimates the exposure <span class="math notranslate nohighlight">\(b_{CTL}\)</span>. It is 0.72 and well estimate</p>
<ul class="simple">
<li><p>we see that the standard errors allow us to reject both zero (easy) and one (not as easy simnce the typical stock must have a beta of 1)</p></li>
</ul>
<p>We see that the R-squared is 17% so the asset specific risk is sizable</p>
<ul class="simple">
<li><p>what fraction of CTL risk is due to the factor?</p></li>
<li><p>how large is the non-factor component?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to get the residual volatility, we need to get the residuals and compute it&#39;s volatility</span>
<span class="n">u</span><span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resid</span>
<span class="nb">print</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="mi">12</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.25520301676928053
</pre></div>
</div>
</div>
</div>
<p>Lets now estimate the covariance matrix of these 50 stocks using this single-factor model</p>
<ol class="arabic simple">
<li><p>Run regression stock by stock</p></li>
<li><p>save betas, save residual variance</p></li>
<li><p>Use formula to construct variance matrix</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;CTL&#39;, &#39;T&#39;, &#39;CSCO&#39;, &#39;FCX&#39;, &#39;XL&#39;, &#39;IVZ&#39;, &#39;AMT&#39;, &#39;WHR&#39;, &#39;IR&#39;, &#39;WFT&#39;,
       &#39;YUM&#39;, &#39;CVS&#39;, &#39;GD&#39;, &#39;TYC&#39;, &#39;EL&#39;, &#39;MUR&#39;, &#39;CTAS&#39;, &#39;CBSA&#39;, &#39;SNV&#39;, &#39;CAM&#39;,
       &#39;DLTR&#39;, &#39;CAH&#39;, &#39;DTE&#39;, &#39;SSP&#39;, &#39;PSA&#39;, &#39;EXC&#39;, &#39;TKR&#39;, &#39;CMA&#39;, &#39;ORCL&#39;, &#39;MS&#39;,
       &#39;RSG&#39;, &#39;ACAS&#39;, &#39;AGN&#39;, &#39;MMM&#39;, &#39;ETFC&#39;, &#39;CAR&#39;, &#39;MDR&#39;, &#39;NOV&#39;, &#39;PCH&#39;, &#39;BAX&#39;,
       &#39;JCI&#39;, &#39;SWK&#39;, &#39;DVN&#39;, &#39;TMO&#39;, &#39;PEP&#39;, &#39;LNC&#39;, &#39;EMR&#39;, &#39;MLM&#39;, &#39;CCI&#39;, &#39;NU&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Results</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Beta&#39;</span><span class="p">,</span><span class="s1">&#39;VarU&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">Factor</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Market&#39;</span><span class="p">]</span>
<span class="n">Assets</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Market&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x</span><span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">Factor</span><span class="p">)</span>
<span class="k">for</span> <span class="n">stocki</span> <span class="ow">in</span> <span class="n">Assets</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="c1"># set the dependent variable to be the &#39;CTL&#39; return</span>
    <span class="n">y</span><span class="o">=</span> <span class="n">Assets</span><span class="p">[</span><span class="n">stocki</span><span class="p">]</span>
    <span class="c1"># run the regression</span>
    <span class="n">results</span><span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">Results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">stocki</span><span class="p">,</span><span class="s1">&#39;Beta&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">stocki</span><span class="p">,</span><span class="s1">&#39;VarU&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>

<span class="n">Results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Beta</th>
      <th>VarU</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>CTL</th>
      <td>0.726946</td>
      <td>0.005427</td>
    </tr>
    <tr>
      <th>T</th>
      <td>0.529153</td>
      <td>0.004093</td>
    </tr>
    <tr>
      <th>CSCO</th>
      <td>1.530779</td>
      <td>0.006403</td>
    </tr>
    <tr>
      <th>FCX</th>
      <td>1.569894</td>
      <td>0.011742</td>
    </tr>
    <tr>
      <th>XL</th>
      <td>1.438681</td>
      <td>0.011752</td>
    </tr>
    <tr>
      <th>IVZ</th>
      <td>2.036247</td>
      <td>0.004851</td>
    </tr>
    <tr>
      <th>AMT</th>
      <td>1.352478</td>
      <td>0.027122</td>
    </tr>
    <tr>
      <th>WHR</th>
      <td>1.442238</td>
      <td>0.008598</td>
    </tr>
    <tr>
      <th>IR</th>
      <td>1.461150</td>
      <td>0.005901</td>
    </tr>
    <tr>
      <th>WFT</th>
      <td>1.513599</td>
      <td>0.010939</td>
    </tr>
    <tr>
      <th>YUM</th>
      <td>0.701920</td>
      <td>0.004836</td>
    </tr>
    <tr>
      <th>CVS</th>
      <td>0.647671</td>
      <td>0.004854</td>
    </tr>
    <tr>
      <th>GD</th>
      <td>0.833312</td>
      <td>0.003792</td>
    </tr>
    <tr>
      <th>TYC</th>
      <td>1.331555</td>
      <td>0.006221</td>
    </tr>
    <tr>
      <th>EL</th>
      <td>0.918557</td>
      <td>0.004550</td>
    </tr>
    <tr>
      <th>MUR</th>
      <td>0.873364</td>
      <td>0.005601</td>
    </tr>
    <tr>
      <th>CTAS</th>
      <td>0.845109</td>
      <td>0.005044</td>
    </tr>
    <tr>
      <th>CBSA</th>
      <td>1.705297</td>
      <td>0.006981</td>
    </tr>
    <tr>
      <th>SNV</th>
      <td>0.980521</td>
      <td>0.009233</td>
    </tr>
    <tr>
      <th>CAM</th>
      <td>1.287322</td>
      <td>0.006415</td>
    </tr>
    <tr>
      <th>DLTR</th>
      <td>0.789608</td>
      <td>0.008543</td>
    </tr>
    <tr>
      <th>CAH</th>
      <td>0.544862</td>
      <td>0.004334</td>
    </tr>
    <tr>
      <th>DTE</th>
      <td>0.334819</td>
      <td>0.002472</td>
    </tr>
    <tr>
      <th>SSP</th>
      <td>1.510001</td>
      <td>0.012559</td>
    </tr>
    <tr>
      <th>PSA</th>
      <td>0.528390</td>
      <td>0.003389</td>
    </tr>
    <tr>
      <th>EXC</th>
      <td>0.299122</td>
      <td>0.003815</td>
    </tr>
    <tr>
      <th>TKR</th>
      <td>1.484943</td>
      <td>0.006822</td>
    </tr>
    <tr>
      <th>CMA</th>
      <td>0.810631</td>
      <td>0.005133</td>
    </tr>
    <tr>
      <th>ORCL</th>
      <td>1.269003</td>
      <td>0.007420</td>
    </tr>
    <tr>
      <th>MS</th>
      <td>1.687285</td>
      <td>0.005518</td>
    </tr>
    <tr>
      <th>RSG</th>
      <td>0.495615</td>
      <td>0.004677</td>
    </tr>
    <tr>
      <th>ACAS</th>
      <td>1.452933</td>
      <td>0.015387</td>
    </tr>
    <tr>
      <th>AGN</th>
      <td>0.569430</td>
      <td>0.004983</td>
    </tr>
    <tr>
      <th>MMM</th>
      <td>0.695088</td>
      <td>0.002467</td>
    </tr>
    <tr>
      <th>ETFC</th>
      <td>2.391465</td>
      <td>0.015546</td>
    </tr>
    <tr>
      <th>CAR</th>
      <td>3.353010</td>
      <td>0.030258</td>
    </tr>
    <tr>
      <th>MDR</th>
      <td>1.468548</td>
      <td>0.025389</td>
    </tr>
    <tr>
      <th>NOV</th>
      <td>1.398243</td>
      <td>0.010767</td>
    </tr>
    <tr>
      <th>PCH</th>
      <td>0.990190</td>
      <td>0.003758</td>
    </tr>
    <tr>
      <th>BAX</th>
      <td>0.485301</td>
      <td>0.004654</td>
    </tr>
    <tr>
      <th>JCI</th>
      <td>1.292524</td>
      <td>0.005156</td>
    </tr>
    <tr>
      <th>SWK</th>
      <td>1.100645</td>
      <td>0.004248</td>
    </tr>
    <tr>
      <th>DVN</th>
      <td>0.957763</td>
      <td>0.006943</td>
    </tr>
    <tr>
      <th>TMO</th>
      <td>0.958138</td>
      <td>0.003878</td>
    </tr>
    <tr>
      <th>PEP</th>
      <td>0.351366</td>
      <td>0.001890</td>
    </tr>
    <tr>
      <th>LNC</th>
      <td>1.826397</td>
      <td>0.009519</td>
    </tr>
    <tr>
      <th>EMR</th>
      <td>1.035139</td>
      <td>0.002380</td>
    </tr>
    <tr>
      <th>MLM</th>
      <td>0.871716</td>
      <td>0.005100</td>
    </tr>
    <tr>
      <th>CCI</th>
      <td>1.672453</td>
      <td>0.014393</td>
    </tr>
    <tr>
      <th>NU</th>
      <td>0.446771</td>
      <td>0.002182</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="arabic simple">
<li><p>How do we compute the share of factor risk in each asset?</p></li>
<li><p>Say I have a portfolio holding 50% in CSCO and 50% in CCI what is the share of factor risk in the portfolio?</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Assuming Results is your DataFrame and &#39;Beta&#39; is your column</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">Results</span><span class="p">[</span><span class="s1">&#39;Beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="c1"># make sure beta is a column vector (and not di)</span>
<span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Compute the outer product of the &#39;Beta&#39; column with itself</span>
<span class="n">beta_matrix</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">@</span> <span class="n">beta</span><span class="o">.</span><span class="n">T</span>
<span class="nb">print</span><span class="p">(</span><span class="n">beta_matrix</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">beta_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># the unsystematic component is a diagonal matrix with the variance of the residuals on the diagonal</span>
<span class="n">CovU</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Results</span><span class="p">[</span><span class="s1">&#39;VarU&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">CovU</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">CovU</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># construct the covariance matrix by adding the systematic and unsystematic components</span>
<span class="n">Cov_F</span><span class="o">=</span><span class="n">beta_matrix</span><span class="o">*</span><span class="n">Factor</span><span class="o">.</span><span class="n">var</span><span class="p">()</span><span class="o">+</span><span class="n">CovU</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Cov_F</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">Cov_F</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[0.52845028 0.38466559 1.11279362 ... 0.63369045 1.21578277 0.32477868]
 [0.38466559 0.28000291 0.81001644 ... 0.46127124 0.88498354 0.23641048]
 [1.11279362 0.81001644 2.34328505 ... 1.334405   2.5601563  0.68390851]
 ...
 [0.63369045 0.46127124 1.334405   ... 0.75988907 1.4579043  0.38945793]
 [1.21578277 0.88498354 2.5601563  ... 1.4579043  2.79709901 0.74720431]
 [0.32477868 0.23641048 0.68390851 ... 0.38945793 0.74720431 0.19960476]]
(50, 50)
[[0.00542738 0.         0.         ... 0.         0.         0.        ]
 [0.         0.00409277 0.         ... 0.         0.         0.        ]
 [0.         0.         0.00640331 ... 0.         0.         0.        ]
 ...
 [0.         0.         0.         ... 0.00510028 0.         0.        ]
 [0.         0.         0.         ... 0.         0.01439288 0.        ]
 [0.         0.         0.         ... 0.         0.         0.00218208]]
(50, 50)
[[0.0065499  0.0008171  0.00236376 ... 0.00134607 0.00258253 0.00068989]
 [0.0008171  0.00468754 0.00172061 ... 0.00097982 0.00187986 0.00050218]
 [0.00236376 0.00172061 0.01138085 ... 0.0028345  0.00543821 0.00145274]
 ...
 [0.00134607 0.00097982 0.0028345  ... 0.00671441 0.00309684 0.00082727]
 [0.00258253 0.00187986 0.00543821 ... 0.00309684 0.0203344  0.00158719]
 [0.00068989 0.00050218 0.00145274 ... 0.00082727 0.00158719 0.00260607]]
(50, 50)
</pre></div>
</div>
</div>
</div>
</section>
<section id="application-minimum-variance-investing">
<h1>Application: Minimum-variance investing<a class="headerlink" href="#application-minimum-variance-investing" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>it is mean-variance investing under the assumption that all assets have same expected returns, but uses covariance matrix to minimize risk</p></li>
<li><p>The idea is that expected returns signals are pure noise so we might as well assume there are no signals and all expected returns are the same</p></li>
<li><p>For example this is behind Minimum volatility investing for example, [<a class="reference external" href="https://investor.vanguard.com/mutual-funds/profile/VMVFX">https://investor.vanguard.com/mutual-funds/profile/VMVFX</a>]</p></li>
<li><p>Assumes all assets have the same expected return</p></li>
</ul>
<div class="math notranslate nohighlight">
\[Min~ X'Var(R)X~ subject~ to~ \mathbf{1}'X=1\]</div>
<p>The result of this problem is a vector of weights proportional to</p>
<div class="math notranslate nohighlight">
\[W_{minvariance}\propto Var(R)^{-1}\mathbf{1}\]</div>
<p>We then impose the constraint that the weights have to add-up to 1.</p>
<div class="math notranslate nohighlight">
\[X_{minvariance}=\frac{Var(R)^{-1}\mathbf{1}}{\mathbf{1}^TVar(R)^{-1}\mathbf{1}}\]</div>
<ul class="simple">
<li><p>I use this technique in â€œhedging-risk factorsâ€, a recent academic paper, to construct portfolios with Sharpe-ratios of 0.8 at the yearly horizon, which is very large</p></li>
</ul>
<blockquote>
<div><p>Why this might make sense?</p>
</div></blockquote>
<p>So you see here that the problem is really identical to the mean-variance problem. We simply substituted the vector or Expected returns by a vector of ones.</p>
<p>The end result is that now the solution is the portfolio that minimizes variance while being fully invested as the constraint <span class="math notranslate nohighlight">\(\mathbf{1}'W=1\)</span> means <span class="math notranslate nohighlight">\(\sum_i^I w_i*1=1\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># minimum variance portfolio using the factor-based covariance matrix</span>
<span class="n">ones</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">X_minvarFactor</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Cov_F</span><span class="p">)</span><span class="o">@</span> <span class="n">ones</span><span class="o">/</span><span class="p">(</span><span class="n">ones</span><span class="o">.</span><span class="n">T</span> <span class="nd">@np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Cov_F</span><span class="p">)</span><span class="o">@</span> <span class="n">ones</span><span class="p">)</span>
<span class="c1"># minimum variance portfolio using the unrestricted stock covariance matrix</span>
<span class="n">Cov</span><span class="o">=</span><span class="n">Assets</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="n">X_minvar</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Cov</span><span class="p">)</span><span class="o">@</span> <span class="n">ones</span><span class="o">/</span><span class="p">(</span><span class="n">ones</span><span class="o">.</span><span class="n">T</span> <span class="nd">@np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Cov</span><span class="p">)</span><span class="o">@</span> <span class="n">ones</span><span class="p">)</span>

<span class="c1"># plot the weights against each other</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X_minvar</span><span class="p">,</span><span class="n">X_minvar</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_minvar</span><span class="p">,</span><span class="n">X_minvarFactor</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.PathCollection at 0x1a6a0497760&gt;
</pre></div>
</div>
<img alt="../../_images/9e984f0bab3fad0115cc832209e4a58f252c5136cb231b6543b16162282c883d.png" src="../../_images/9e984f0bab3fad0115cc832209e4a58f252c5136cb231b6543b16162282c883d.png" />
</div>
</div>
<ul class="simple">
<li><p>What do you notice about the weights?</p></li>
<li><p>How do we construct the returns of the strategy?</p></li>
<li><p>What do we need to evaluate performance of the Factor-based approach vs the unrestricted approach?</p>
<ul>
<li><p>Why canâ€™t we simply calculate Sharpe Ratios in the same data?</p></li>
</ul>
</li>
</ul>
<p><strong>Factor Bets</strong></p>
<ul class="simple">
<li><p>Can I allocate freely across factors?</p>
<ul>
<li><p>for principals obviously yes, but the effect of a factor in your portfolio might not fully describe itâ€™s risk</p>
<ul>
<li><p>for example, you might be more likely to lose your job when the market is down, making you more averse to market risk then other risks</p></li>
</ul>
</li>
<li><p>Active managers are often subject to factor exposure limits</p></li>
</ul>
</li>
</ul>
<p>It is not obvious that maximizing your SR is the only guide for factor investing
Somebody has to bear the aggregate risk and the key question is whether you are the best holder of that risk</p>
<p>For example,</p>
<ul class="simple">
<li><p>if your labor income is insensitive to recessions you might have comparative advantadge in taking market risk</p></li>
<li><p>you might be a bankruptcy lawyerâ€“your income actually goes up when the market is down!</p></li>
<li><p>Managers with mediocre alpha, might not have better alternatives then harvest market risk-premium</p></li>
<li><p>Managers with â€œgreatâ€ alpha will try to avoid it as factor investing reduces their overall SR making their portfolio riskier or less growth.</p></li>
</ul>
<p><strong>Factor Hedging</strong></p>
<p>You might want to invest in factors even if they donâ€™t earn a risk-premium because they might be helpful in hedging. In this case, not having a risk-premium is a plus!</p>
<p>It allow you to enhance your sharpe ratio even more than hedging factors with premia</p>
<p>This hedging can also come from non-portfolio factorsâ€“say your human capital is heavily specialized in tech and you might choose to short tech to have lower volatility in your overall networth.</p>
<p>A mutual fund manager might want to hedge portfolio flowsâ€“invest in factors that do well when investors flow out of their fund, for exampleâ€“or a hedge fund manager might want to hedge funding conditionsâ€“ say invest in factors that do well when borrowing is harder.</p>
<p><strong>Factor Investing</strong></p>
</section>
<section id="a-bond-equity-strategic-investment-problem-of-an-international-investor">
<h1>A bond-equity strategic investment problem of an international investor<a class="headerlink" href="#a-bond-equity-strategic-investment-problem-of-an-international-investor" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>we will assume here that the risk-premium is being generated from a constant distribution</p></li>
<li><p>this is wrong, but for large well diversified portfolio not too bad</p></li>
<li><p>under this assumption, our estimation problem amounts to using sample means</p></li>
<li><p>ths risk-free rate is time-varying so we will have to deal with it</p></li>
</ul>
<p>We start by loading out return data</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/amoreira2/Lectures/main/assets/data/GlobalFinMonthly.csv&quot;</span>
<span class="n">Data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">na_values</span><span class="o">=-</span><span class="mi">99</span><span class="p">)</span>
<span class="n">Data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
<span class="n">Data</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
<span class="c1"># the assets are the risk-free rate, the us equity market, the us bond market, the emerging market, the global equity market (without US), and the global bond market (without US)</span>

<span class="n">Data</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="s2">&quot;MKTUS&quot;</span><span class="p">,</span><span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="s2">&quot;BondUS&quot;</span><span class="p">,</span>
                          <span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="s2">&quot;EM&quot;</span><span class="p">,</span><span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="s2">&quot;MKTxUS&quot;</span><span class="p">,</span><span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="s2">&quot;BondxUS&quot;</span> <span class="p">})</span>
<span class="n">Data</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>RF</th>
      <th>MKTUS</th>
      <th>BondUS</th>
      <th>EM</th>
      <th>MKTxUS</th>
      <th>BondxUS</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2016-08-31</th>
      <td>0.0002</td>
      <td>0.0052</td>
      <td>-0.008417</td>
      <td>0.025186</td>
      <td>0.000838</td>
      <td>-0.009552</td>
    </tr>
    <tr>
      <th>2016-09-30</th>
      <td>0.0002</td>
      <td>0.0027</td>
      <td>-0.016417</td>
      <td>0.013153</td>
      <td>0.012736</td>
      <td>0.009979</td>
    </tr>
    <tr>
      <th>2016-10-31</th>
      <td>0.0002</td>
      <td>-0.0200</td>
      <td>-0.049460</td>
      <td>0.002474</td>
      <td>-0.020383</td>
      <td>-0.043476</td>
    </tr>
    <tr>
      <th>2016-11-30</th>
      <td>0.0001</td>
      <td>0.0487</td>
      <td>-0.081636</td>
      <td>-0.045971</td>
      <td>-0.019798</td>
      <td>-0.050359</td>
    </tr>
    <tr>
      <th>2016-12-31</th>
      <td>0.0003</td>
      <td>0.0185</td>
      <td>-0.005296</td>
      <td>0.002904</td>
      <td>0.034383</td>
      <td>-0.023207</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we start by constructing excess returns by subtracting the risk-free rate from the returns of the assets and we drop the risk-free rate column</span>
<span class="n">Re</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># we compute the mean and covariance matrix of the excess returns</span>
<span class="n">ERe</span><span class="o">=</span><span class="n">Re</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ERe</span><span class="p">)</span>
<span class="n">Cove</span><span class="o">=</span><span class="n">Re</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Cove</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MKTUS      0.005140
BondUS     0.002523
EM         0.006923
MKTxUS     0.004149
BondxUS    0.002054
dtype: float64
            MKTUS    BondUS        EM    MKTxUS   BondxUS
MKTUS    0.001948  0.000111  0.001292  0.001264  0.000187
BondUS   0.000111  0.001227 -0.000204 -0.000013  0.000264
EM       0.001292 -0.000204  0.003556  0.001661  0.000249
MKTxUS   0.001264 -0.000013  0.001661  0.002182  0.000422
BondxUS  0.000187  0.000264  0.000249  0.000422  0.000407
</pre></div>
</div>
</div>
</div>
<p>Suppose I want to reconstruct my current estimates of Expected returns and the covariance matrix of returns ( and not excess returns), What do I do?</p>
<p>Simply add the current risk-free rate to you estimate of the expected return</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the risk-free rate to the current value of the 3-month T-bill rate divided by 12 to make it a monthly rate</span>
<span class="n">rf</span><span class="o">=</span><span class="mf">0.0525</span><span class="o">/</span><span class="mi">12</span>
<span class="c1"># add to our estimate of risk-premiumns to get our estimate of expected returns</span>

<span class="n">ER</span><span class="o">=</span><span class="n">ERe</span><span class="o">+</span><span class="n">rf</span>
</pre></div>
</div>
</div>
</div>
<p>What about the covariance piece?</p>
</section>
<section id="numerical-solution">
<h1>Numerical solution<a class="headerlink" href="#numerical-solution" title="Link to this heading">#</a></h1>
<p>Lets start by solving</p>
<p><span class="math notranslate nohighlight">\( \max_X E[X'R_T]\)</span> subject to <span class="math notranslate nohighlight">\(Var(X'R_T)\leq Vmax\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># STEP 1: define the fucntion that computes the portfolio variance and expected returns given a vector of weights X (initially set to equal weights)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">portfolio_variance</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">X</span> <span class="o">@</span> <span class="n">Cove</span> <span class="o">@</span> <span class="n">X</span>

<span class="k">def</span><span class="w"> </span><span class="nf">portfolio_expected_return</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">):</span>
     <span class="k">return</span> <span class="n">X</span> <span class="o">@</span> <span class="n">ER</span>

<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_expected_return</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0007914039297139135
0.0008490361488465391
0.008532889760767246
0.00820649669319938
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># STEP 2: define the constraint functions, </span>

<span class="c1"># here we will have one inequality for the portfolio variance , lets say a volatility of 10% per year. How do we translate this into a monthly variance?</span>

<span class="c1"># and one equality constraint for the weights to sum to one</span>



<span class="n">Vmax</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>
<span class="n">cons</span><span class="o">=</span> <span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span>
          <span class="s1">&#39;fun&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="o">-</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">+</span><span class="n">Vmax</span><span class="p">},</span>
          <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span>
          <span class="s1">&#39;fun&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">})</span>

<span class="c1"># the constraint is normalized so that</span>

<span class="c1">#cons=({&#39;type&#39;: &#39;ineq&#39;,</span>
<span class="c1">#          &#39;fun&#39; : lambda X: F(X)})</span>

<span class="c1">#means F(X)&gt;=0</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Finally we are ready to do our minimization</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">options={'disp':</span> <span class="pre">True}</span></code>: tell python to report intermediary steps so we can check if the algorithm is doing progress towards a solution.</p></li>
<li><p>There is a variety of additional parameters that you can pass to the minimizer.</p></li>
<li><p>see: <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html">https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># STEP 3: solve the minimization problem with constraints and save as `sol`</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimize</span>
<span class="n">X0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="o">-</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="n">X0</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.011929088527573371
            Iterations: 13
            Function evaluations: 78
            Gradient evaluations: 13
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#optimal weights</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="c1"># optimal expected return at the annual frequency</span>
<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span>
<span class="c1"># optimal portfolio volatility at the annual frequenc</span>
<span class="p">(</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 0.65116149  0.38641724  0.83880728 -0.36993912 -0.50644688]
0.14314906233088046
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.20000201016577546
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># below I am plotting the solution weights.</span>
<span class="n">width</span><span class="o">=</span><span class="mf">0.3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">width</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ER</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/70226f2c4c03e77906a060eca77c2483f49d49a004270d09707785a6327979b0.png" src="../../_images/70226f2c4c03e77906a060eca77c2483f49d49a004270d09707785a6327979b0.png" />
</div>
</div>
<p>Here we assumed the portfolio has to be fully invested in risky assets.</p>
<p>There is no leverage (borrowing at the risk-free rate)</p>
<p>but there is shorting (raising additional funds by selling one asset)</p>
<p>Note that is X0+X1=1, if X0&lt;0, then X1&gt;1</p>
</section>
<section id="introducing-a-benchmark">
<h1>Introducing a benchmark<a class="headerlink" href="#introducing-a-benchmark" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>in mutual funds there is often a benchmark, say the S&amp;P 500 and the manager has a mandate to have a tracking error relative to the benchmark that is low enough, say <span class="math notranslate nohighlight">\(Tmax\)</span></p></li>
<li><p>and the manager is compensated only with respect to the returns above this benchmark</p></li>
<li><p>tracking error is the volatility of the portfolio relative to the benchmark: <span class="math notranslate nohighlight">\(\sqrt{var(X'R_T-R^{benchmark}_T)}\)</span></p></li>
</ul>
<p>The manager problem is ro maximize benchmark adjusted returns subject to some tracking error constraint</p>
<p><span class="math notranslate nohighlight">\( \max_X E[X'R_T-R^{benchmark}_T]\)</span> subject to <span class="math notranslate nohighlight">\(Var(X'R_T-R^{benchmark}_T)\leq Tmax\)</span></p>
<p>Assuming benchmark is in set of traded assets, you car write</p>
<p><span class="math notranslate nohighlight">\( \max_X E[X'R_T-1_b'R_T]\)</span> subject to <span class="math notranslate nohighlight">\(Var(X'R_T-1_b'R_T)\leq Tmax\)</span></p>
<p>Which can be written as</p>
<p><span class="math notranslate nohighlight">\( \max_X E[(X-1_b)'R_T]\)</span> subject to <span class="math notranslate nohighlight">\((X-1_b)'Var(R_T)(X-1_b)\leq Tmax\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">portfolio_variance</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span><span class="n">Xbenchmark</span><span class="p">)</span><span class="o">@</span> <span class="n">Cove</span> <span class="o">@</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">Xbenchmark</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">portfolio_expected_return</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])):</span>
     <span class="k">return</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">Xbenchmark</span><span class="p">)</span> <span class="o">@</span> <span class="n">ER</span>


<span class="n">Xb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">Vmax</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>
<span class="n">cons</span><span class="o">=</span> <span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span>
          <span class="s1">&#39;fun&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="o">-</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">Xb</span><span class="p">)</span><span class="o">+</span><span class="n">Vmax</span><span class="p">},</span>
          <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span>
          <span class="s1">&#39;fun&#39;</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">})</span>

<span class="n">X0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span>
<span class="n">solb</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">X</span><span class="p">:</span> <span class="o">-</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">Xb</span><span class="p">),</span><span class="n">X0</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization terminated successfully    (Exit mode 0)
            Current function value: -0.005220575391068462
            Iterations: 15
            Function evaluations: 90
            Gradient evaluations: 15
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">Cove</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="c1">#optimal weights no benchmark</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="c1">#optimal weights with benchmark</span>
<span class="nb">print</span><span class="p">(</span><span class="n">solb</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;MKTUS&#39;, &#39;BondUS&#39;, &#39;EM&#39;, &#39;MKTxUS&#39;, &#39;BondxUS&#39;], dtype=&#39;object&#39;)
[ 0.65116149  0.38641724  0.83880728 -0.36993912 -0.50644688]
[ 1.71916096  0.06129325  0.73328686 -0.28549667 -1.2282444 ]
</pre></div>
</div>
</div>
</div>
<p>What happen here? Why the position in the market went up? Is that what you would expect?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># optimal expected return at the annual frequency</span>
<span class="nb">print</span><span class="p">(</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">solb</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span>
<span class="c1"># portfolio volatility pf optimal portfolio at the annual frequency</span>
<span class="nb">print</span><span class="p">((</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">solb</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
<span class="c1">#Trackign error</span>
<span class="nb">print</span><span class="p">((</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">solb</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">Xb</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
<span class="c1">#Benchmark adjsuted returns</span>
<span class="nb">print</span><span class="p">((</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">solb</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">Xb</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="information-ratio">
<h1>Information Ratio<a class="headerlink" href="#information-ratio" title="Link to this heading">#</a></h1>
<p>Information ratio is how much you are expected to make in excess of the benchmark, divided by how much risk you are taking relative to the benchmark</p>
<div class="math notranslate nohighlight">
\[InformationRatio=\frac{E[r_p-r_b]}{\sigma(r_p-r_p)}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#The information ratio is the benchmark adjusted return divided by the tracking error</span>
<span class="nb">print</span><span class="p">((</span><span class="n">portfolio_expected_return</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">Xb</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">Xbenchmark</span><span class="o">=</span><span class="n">Xb</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.31322388844974003
</pre></div>
</div>
</div>
</div>
<p>Other things to do</p>
<p>Trace out how the optimal expected return varies as you change Vmax. In yearly volatility units try 6.5%, 7%, 8% , 10% ,15%,30%. Plot the resulting pairs in the scatter plot with the expected return in the y-axis and the volatility in the x-axis. What do you find?</p>
<p>Add the risk-free rate among the assets. There are different ways to do this. But a simple one is to change the expected return function  <code class="docutils literal notranslate"><span class="pre">X&#64;ER+(1-np.sum(X))*rf</span></code></p>
<ul class="simple">
<li><p>now X is the vector of risky assets only and (1-np.sum(X)) is whatever is the residual</p></li>
<li><p>if this residual is positive you park in cash and earn rf</p></li>
<li><p>if negative you borrow at the rf rate</p></li>
<li><p>now your total weights mechanically add up to 1</p></li>
<li><p>so you need to take out the equality constraint</p></li>
</ul>
<p>Add a shorting constraint, say you can only short equities but not bonds, that is X&gt;0 for certain assets</p>
<p>Add a leverage cap, so that the sum of your risky assets cannot exceed 1 too much, np.sum(X)-1 is called your leverage, so you can limit it to 1, so that for each dollar you have you borrow at most 1 dollar</p>
<p>Modify the expected return function to incorporate practical frictions in trading. For example, when you borrow you typically pay more than what you can invest at, there is a borrowing spread. Analogously if you short a stock, you have to pay an extra fee</p>
</section>
<section id="analytical-solution">
<h1>Analytical solution<a class="headerlink" href="#analytical-solution" title="Link to this heading">#</a></h1>
<p>The analytical solution assumes</p>
<ul class="simple">
<li><p>free borrowing and lending at risk-free rate</p></li>
<li><p>Shorting without any shorting fees</p></li>
</ul>
<p>The optimal weights are</p>
<div class="math notranslate nohighlight">
\[X=\sqrt{\frac{Vmax}{E[R^e]'Var(R^e)^{-1}E[R^e]}}Var(R^e)^{-1}E[R^e]\]</div>
<p>Where Vmax is in monthly variance units</p>
<p>Note that <span class="math notranslate nohighlight">\(\frac{Vmax}{E[R^e]'Var(R^e)^{-1}E[R^e]}\)</span> is a number. Is basically a leverage factor. It leverage up (or down) the portfolio <span class="math notranslate nohighlight">\(Var(R^e)^{-1}E[R^e]\)</span> so that the resulting portfolio has the desired target variance</p>
<p>This portfolio <span class="math notranslate nohighlight">\(Var(R^e)^{-1}E[R^e]\)</span> is quite special because it has the highest Sharpe-ratio among all possible combinations of these assets</p>
</section>
<section id="sharpe-ratio">
<h1>Sharpe-ratio !<a class="headerlink" href="#sharpe-ratio" title="Link to this heading">#</a></h1>
<p>Sharpe ratio is probably the most used concept in money management, it comes in honor of William Sharpe ( the dude that discovered the CAPM). It reflects how much additional expected return you are getting per unit of volatility. Say you have a portfolio with expected returns <span class="math notranslate nohighlight">\(E[r_p]\)</span></p>
<div class="math notranslate nohighlight">
\[SharpeRatio=\frac{E[r_p]-rf}{\sigma(R_p)}\]</div>
<p>So a portfolio that has the highest sharpe ratio is nice because it is efficient.</p>
<p>You take the minimum amount of risk that you need to take to achieve a expected return</p>
<p>or conversely you get the maximum possible expected return for a given level of risk that you are willing to take</p>
<hr class="docutils" />
<p><em>Aside: Matrix inversion</em></p>
<ul class="simple">
<li><p>You only need to understand how to operationaize it and in an conceptual level what it does</p></li>
<li><p>But you donâ€™t need to follow all the mathematical details</p></li>
<li><p>If you are interested. you can look in our linear algebra review in <a class="reference external" href="https://amoreira2.github.io/quantitativeinvesting/chapters/scientific/linear_algebra1.html">https://amoreira2.github.io/quantitativeinvesting/chapters/scientific/linear_algebra1.html</a></p></li>
<li><p>I also provide a summary below</p></li>
<li><p>Note that <span class="math notranslate nohighlight">\((2)^{-1}=1/2=0.5\)</span> (naturally!)</p></li>
<li><p><span class="math notranslate nohighlight">\((Var(R^e))^{-1}\)</span> is just like this</p></li>
<li><p>but more complicated because <span class="math notranslate nohighlight">\(Var(R^e)\)</span> is a N by N matrix and we canâ€™t simply divide over to solve for X</p></li>
<li><p>The definition of the inverse function is <span class="math notranslate nohighlight">\(f(x)=x^{-1}=y\)</span> where <span class="math notranslate nohighlight">\(y*x=1\)</span></p></li>
<li><p>for matrices it is the same: <span class="math notranslate nohighlight">\((Var(R^e))^{-1}Var(R^e)=I\)</span>, but now instead of 1, we have an identity matrix, which is a matrix with 1â€™s in the diagonal and zero everywhere else</p></li>
</ul>
<p>Thankfully we have a function in python that does just that</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># start with a 2 by 2 matrix</span>
<span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">9</span><span class="p">]])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="c1"># compute the inverse</span>
<span class="n">ainv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> 

<span class="n">ainv</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[3 7]
 [0 9]]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.33333333, -0.25925926],
       [ 0.        ,  0.11111111]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># indeed ainv is the inverse of a because ainv @ a = I</span>
<span class="n">ainv</span> <span class="o">@</span> <span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1., 0.],
       [0., 1.]])
</pre></div>
</div>
</div>
</div>
<p>This portfolio is very special so it has many names</p>
<ol class="arabic simple">
<li><p>maximum sharpe ratio portfolio</p></li>
<li><p>mean-variance efficient portfolio (MVE)</p></li>
<li><p>Tangency portfolio</p></li>
</ol>
<p>Names 1 and 2 are pretty clear. Name 3 will become clear later in the course</p>
<hr class="docutils" />
</section>
<section id="finding-the-mean-variance-efficient-portfolio">
<h1><strong>Finding the Mean-variance efficient portfolio</strong><a class="headerlink" href="#finding-the-mean-variance-efficient-portfolio" title="Link to this heading">#</a></h1>
<p>First lets construct our vector of expected excess returns for our risky two assets US equity market and International equity market</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">assets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MKTUS&#39;</span><span class="p">,</span><span class="s1">&#39;MKTxUS&#39;</span><span class="p">]</span>
<span class="n">e</span><span class="o">=</span><span class="n">ERe</span><span class="p">[</span><span class="n">assets</span><span class="p">]</span>

<span class="n">e</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MKTUS     0.005140
MKTxUS    0.004149
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We start by estimating the covariance matrix from our data <span class="math notranslate nohighlight">\(Var(R^e)\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">=</span><span class="n">Cove</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">assets</span><span class="p">,</span><span class="n">assets</span><span class="p">]</span>

<span class="n">c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MKTUS</th>
      <th>MKTxUS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>MKTUS</th>
      <td>0.001948</td>
      <td>0.001264</td>
    </tr>
    <tr>
      <th>MKTxUS</th>
      <td>0.001264</td>
      <td>0.002182</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We then invert the covariance matrix <span class="math notranslate nohighlight">\(Var(R^e)^{-1}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cinv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> 

<span class="n">cinv</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 822.50792137, -476.49212708],
       [-476.49212708,  734.40580739]])
</pre></div>
</div>
</div>
</div>
<p>we then use the dot product to cross-mulitply our vector of expected excess returns by the inverse of the covariance matrix</p>
<div class="math notranslate nohighlight">
\[Var(R^e)^{-1}E[R^e]\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Wmve</span><span class="o">=</span><span class="n">cinv</span> <span class="o">@</span> <span class="n">e</span>
<span class="n">Wmve</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([2.25099751, 0.597729  ])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vmax</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>
<span class="n">Wmve</span> <span class="o">*</span> <span class="p">(</span><span class="n">Vmax</span><span class="o">/</span><span class="p">(</span><span class="n">e</span> <span class="nd">@cinv</span> <span class="o">@</span> <span class="n">e</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.53401107, 0.14180109])
</pre></div>
</div>
</div>
</div>
<p>Things to try</p>
<p>Verify that indeed the entire class of portfolios that solve the problem for different variance targets Vmax are also MVE ( i.e they all have the max sharpe ratio)</p>
<p>What is the allocation to the risk-free rate? How do you find it? How does it change as you increase/decrease Vmax?</p>
<p>How does max SR change as you go from</p>
<ol class="arabic simple">
<li><p>only investing in the US equity market</p></li>
<li><p>investing in US equities and US bonds</p></li>
<li><p>Invest everywhere except emerging markets</p></li>
<li><p>investing everywhere including emerging markets</p></li>
<li><p>investing only in global equities and global bonds</p></li>
</ol>
<p>Compare the gains of investing domestically ( US equities and bonds)  with investing internationally as well (US equities, US bonds, Global equities, global bonds).</p>
<p>Why the SR is going up ?What properties of the returns moments the mean-variance optimizer are exploiting?</p>
<p>Do we think those are reliable properties? What is the alternative?</p>
<p>For the four investment opportunity sets above, compute the optimal expected returns for the following volatilities 6.5%, 7%, 8% , 10% ,15%,30%. Plot the results in a scatter plot with volatility in the X-axis and expected returns in the y-axis. You should see 5 lines. Why they look like that?</p>
<p>Compare the benefits of a US investor to invest globally and the benefit of an international investor investing in the US ( ignore Emerging markets). Looking at individual assets risk-premiums and volatility explain the benefits of investing across multiple assets</p>
<p><strong>An Aside: Combining Factors and Alphas</strong></p>
<p>Suppose you also think of market exposure as purely investment thing. That is , all you care about is your final Sharpe Ratio.</p>
<p>How do you combine you alpha portfolio and your factor portfolio?</p>
<p>We learned than when assets are uncorrelated then</p>
<div class="math notranslate nohighlight">
\[W_i\sigma_{\epsilon,i}=w \frac{\alpha_i}{\sigma_{\epsilon,i}}=SR_i\]</div>
<p>Turns out that the market is uncorrelated with the the hedged portfolios! We build them that way.</p>
<p>So the market is also uncorrelated with our optimal combo!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sr_mkt</span><span class="o">=</span><span class="n">df_ff6</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">df_ff6</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="mi">12</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">vol_mkt</span><span class="o">=</span><span class="n">df_ff6</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="mi">12</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">vol_alpha</span><span class="o">=</span><span class="p">(</span><span class="n">W_alpha</span><span class="nd">@Sigma_e@W_alpha</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

<span class="n">sr_alpha</span><span class="o">/</span><span class="n">vol_alpha</span>

<span class="n">Alpha_mkt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Alpha</span><span class="p">,</span><span class="n">df_ff6</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Alpha_mkt</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span>
<span class="n">Sigma_mkt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">Sigma_e</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">))],[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)),</span><span class="n">df_ff6</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()]])</span>
<span class="nb">print</span><span class="p">((</span><span class="n">Sigma_mkt</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">Beta_mkt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Beta</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Beta_mkt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.00565215 0.04340806 0.04082549 0.04305824 0.08436363 0.06964076]
[[0.10100102 0.         0.         0.         0.         0.        ]
 [0.         0.10153812 0.         0.         0.         0.        ]
 [0.         0.         0.07537267 0.         0.         0.        ]
 [0.         0.         0.         0.06688336 0.         0.        ]
 [0.         0.         0.         0.         0.14320141 0.        ]
 [0.         0.         0.         0.         0.         0.15513658]]
[ 0.20050922 -0.13683445 -0.09207115 -0.16721034 -0.15908574  1.        ]
</pre></div>
</div>
</div>
</div>
<p><strong>Shrinkage</strong> is a very popular technique and also the lest ad-hoc of the different approaches so it work discussing a bit</p>
<p>The fundamental issue that the mean-variance problem does not deal with is that we are actually quite uncertain about the alphas, but the methods assumes complete certitude</p>
<p>In mathematical terms the MV problem assumes <span class="math notranslate nohighlight">\(A\)</span> is a know constant when in fact it is more like a distribution:</p>
<div class="math notranslate nohighlight">
\[A\sim N(\mu_{\alpha}I,\sigma^2_{\alpha}I)\]</div>
<p>where <span class="math notranslate nohighlight">\(\mu_{\alpha}\)</span> is the expected value . Here we are focused on a manager only with long ideas. The short book is analogous</p>
<p>One could also write $<span class="math notranslate nohighlight">\(A\sim N(\mu_{\alpha}I,\sigma^2_{\alpha}1_{NxN})\)</span>$</p>
<p>Capturing the idea that there is co-movement in your alpha-judgment</p>
<p>Now his/her problem is (I will use the mean-variance problem case but the two other problems have similar solution)</p>
<div class="math notranslate nohighlight">
\[ \max_W E[W'R^e_T]-\gamma Var(W'R^e_T)\]</div>
<div class="math notranslate nohighlight">
\[ \max_W E[W'(A+Bf+U)]-\gamma Var(W'(A+Bf+U))\]</div>
<p>Here I will assume <span class="math notranslate nohighlight">\(E[f]=0\)</span>, so we can simply write the portfolio allocation problem of the <strong>hedged portfolios</strong></p>
<div class="math notranslate nohighlight">
\[ \max_W E[W'(A+U)]-\gamma Var(W'(A+U))\]</div>
<div class="math notranslate nohighlight">
\[ \max_W E[W'A]-\gamma \left(WVar(A)W'+WVar(U)W'\right)\]</div>
<div class="math notranslate nohighlight">
\[\max_W W'I\mu_{\alpha}-\gamma \left(WIW'\sigma^2_{\alpha}+W\Sigma_{\epsilon}W'\right)\]</div>
<p>The Optimality condition for this problem is</p>
<div class="math notranslate nohighlight">
\[I\mu_{\alpha}-2\gamma \left(\sigma^2_{\alpha}+\Sigma_{\epsilon}\right)W'\]</div>
<p>Reorganizing</p>
<div class="math notranslate nohighlight">
\[W=\frac{1}{2\gamma}\mu_{\alpha}\left(I\sigma^2_{\alpha}+\Sigma_{\epsilon}\right)^{-1}\]</div>
<p>In this case where there is no co-movement, the approach ignores alpha information of each idea (you use <span class="math notranslate nohighlight">\(\mu_{\alpha}\)</span> for all) and you â€œnoise upâ€ the returns by <span class="math notranslate nohighlight">\(\sigma^2_{\alpha}\)</span></p>
<p>In case of co-movement , then we have</p>
<div class="math notranslate nohighlight">
\[W=\frac{1}{2\gamma}\mu_{\alpha}\left(1\sigma^2_{\alpha}+\Sigma_{\epsilon}\right)^{-1}\]</div>
<p>Why should you care about your portfolio risk?</p>
<ul class="simple">
<li><p>suppose you have 1M per year vol , what is the most money you expect to loose with 5% probability?</p></li>
</ul>
<p>First lets assume it is normally distributed.</p>
<p>(we often will do that because make it easier to think, but you should always keep in mind that is an approximation)</p>
<div class="math notranslate nohighlight">
\[Prob(r&lt;X)=5\%\]</div>
<p>IT is convenient to transform into a stantard normal so we get a clean formula</p>
<div class="math notranslate nohighlight">
\[Prob\left(\frac{r-E[r]}{std(r)}&lt;\frac{X-E[r]}{std(r)}\right)=5\%\]</div>
<p>This is just the CDF of standard formal distribution. Let <span class="math notranslate nohighlight">\(F(x)=Prob(z&lt;x)\)</span> where <span class="math notranslate nohighlight">\(z\sim N(0,1)\)</span></p>
<div class="math notranslate nohighlight">
\[F\left(\frac{X-E[r]}{std(r)}\right)=5\%\]</div>
<p>Then we can use the inverse CDF, which is the quantile function</p>
<div class="math notranslate nohighlight">
\[F^{âˆ’1}(p)=min\{xâˆ£F(x)â‰¥p\}\]</div>
<p>It gives use the lowest value x that is consistent with the probability being higher then a given value</p>
<div class="math notranslate nohighlight">
\[\frac{X-E[r]}{std(r)}=F^{-1}(5\%)\]</div>
<p>Then</p>
<div class="math notranslate nohighlight">
\[X=F^{-1}(5\%)*std(r)+E[r]\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>
<span class="n">x</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.6448536269514729
</pre></div>
</div>
</div>
</div>
<p>First lets do the unhedged.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prob</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">mu</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">mu_f</span><span class="o">+</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="mi">252</span>
<span class="n">sig</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">var_r</span><span class="o">*</span><span class="mi">252</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span><span class="o">+</span><span class="n">mu</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.8761656953451189
</pre></div>
</div>
</div>
</div>
<p>How do you interpret this value?</p>
<p>It means that there is a 5% probability that you will lose more than 800 thousand dollars</p>
<p>Lets do the hedged</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prob</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">mu</span><span class="o">=</span><span class="n">xe</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="mi">252</span>
<span class="n">sig</span><span class="o">=</span><span class="n">xe</span><span class="o">*</span><span class="p">(</span><span class="n">var_e</span><span class="o">*</span><span class="mi">252</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span><span class="o">+</span><span class="n">mu</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.0443405970988286
</pre></div>
</div>
</div>
</div>
<p>Why are you risking a worse loss in the case of the hedged?</p>
<p>Lets suppose</p>
<p>MVE theory</p>
<ul class="simple">
<li><p>We  learned that the portfolio that  has the highest sharpe ratio among the set of assets have the following form</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ W^*=wVar(R^e)^{-1}E[R^e], \forall w&gt;0\]</div>
<ul class="simple">
<li><p>I.e., the equation above defines <span class="math notranslate nohighlight">\(W^*\)</span>, the weights of the mean-variance efficient portfolio</p></li>
<li><p>We can rewrite as</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ Var(R^e)W^*=wE[R^e]\]</div>
<p>Note that the left term is really the covariance of the asset returns with the MVE portfolio <span class="math notranslate nohighlight">\(r^*=(W^*)'R^e\)</span></p>
<div class="math notranslate nohighlight">
\[Var(R^e)W^*=Cov(R^e,r^*)\]</div>
<ul class="simple">
<li><p>This means that the expected return of an asset must be proportional to the covariance between the return of the asset and the return of the mean-variance efficient portfolio</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ E[R^e]= \frac{1}{w} Cov(R^e,r^*) \]</div>
<ul class="simple">
<li><p>This holds for all assets in your investment opportunity set (i.e. the assets included in the minimization problem that the mean-variance efficient portfolio solves)</p></li>
<li><p>This means that for any assets <span class="math notranslate nohighlight">\(j\)</span> and <span class="math notranslate nohighlight">\(i\)</span> we have</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\frac{E[r^e_i]}{Cov(r^e_i,R^*)}= \frac{E[r^e_j]}{Cov(R^e_j,R^*)} \]</div>
<ul class="simple">
<li><p>All assets have the same expected return per-unit of covariance with the mean-variance efficient portoflio</p></li>
<li><p>We can also apply this to the mean-variance efficient portfolio itself</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ E[R^*]=1/w \times Cov(R^*,R^*) \]</div>
<ul class="simple">
<li><p>Which means that <span class="math notranslate nohighlight">\(1/w=\frac{E[R^*]}{Var(R^*)}\)</span></p></li>
<li><p>Plugging back in the original and we get that for any asset <span class="math notranslate nohighlight">\(j\)</span></p></li>
</ul>
<div class="math notranslate nohighlight">
\[ E[r^e_j]=\frac{E[r^*]}{Var(r^*)} Cov(r^e_j,r^*) =\frac{Cov(r^e_j,r^*)}{Var(r^*)}E[r^*]=\beta_{j,*}E[r^*] \]</div>
<div class="math notranslate nohighlight">
\[ E[r^e_j]=\beta_{j,*}E[r^*] \]</div>
<ul class="simple">
<li><p>All the information about the cross-sectional of expected returnsâ€“all the assetsâ€“ can be summarized by the expected return of the mean-variance efficient portfolio and the beta of each asset with respect to the mean-variance efficient portfolio</p></li>
<li><p>Once you have the right definition of risk, the reward to risk is the same across assets (no free lunch)</p></li>
<li><p>If you have alpha, then you get a â€œfree lunchâ€</p></li>
</ul>
<blockquote>
<div><h4 class="rubric" id="id1"></h4>
<ul class="simple">
<li><p>Add random noise to signals (some fraction of vol.) to slightly distort rankings and recompute Sharpe.</p></li>
<li><p>How robust are slight perturbations in the cross-sectional rankings?</p></li>
<li><p>Calculate the Sharpe ratio for a strategy that always eliminates the top 2% long and short positions (which are most likely error prone).</p></li>
<li><p>Look at small perturbations ( say change horizon, skip a month)</p></li>
</ul>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>

<span class="k">def</span><span class="w"> </span><span class="nf">analyze_notebook</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">notebook</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">cell_counts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;markdown&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">total_lines</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">notebook</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">cell_type</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cell_type&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">total_lines</span> <span class="o">+=</span> <span class="n">lines</span>

        <span class="k">if</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="n">cell_counts</span><span class="p">:</span>
            <span class="n">cell_counts</span><span class="p">[</span><span class="n">cell_type</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cell_counts</span><span class="p">[</span><span class="s2">&quot;other&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">notebook_path</span><span class="p">),</span>
        <span class="s2">&quot;code_cells&quot;</span><span class="p">:</span> <span class="n">cell_counts</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">],</span>
        <span class="s2">&quot;markdown_cells&quot;</span><span class="p">:</span> <span class="n">cell_counts</span><span class="p">[</span><span class="s2">&quot;markdown&quot;</span><span class="p">],</span>
        <span class="s2">&quot;other_cells&quot;</span><span class="p">:</span> <span class="n">cell_counts</span><span class="p">[</span><span class="s2">&quot;other&quot;</span><span class="p">],</span>
        <span class="s2">&quot;total_lines&quot;</span><span class="p">:</span> <span class="n">total_lines</span><span class="p">,</span>
    <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">analyze_all_notebooks</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
    <span class="n">notebook_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ipynb&quot;</span><span class="p">):</span>
                <span class="n">notebook_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analyze_notebook</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">notebook_data</span>

<span class="k">def</span><span class="w"> </span><span class="nf">export_to_csv</span><span class="p">(</span><span class="n">notebook_data</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;code_cells&quot;</span><span class="p">,</span> <span class="s2">&quot;markdown_cells&quot;</span><span class="p">,</span> <span class="s2">&quot;other_cells&quot;</span><span class="p">,</span> <span class="s2">&quot;total_lines&quot;</span><span class="p">]</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">notebook</span> <span class="ow">in</span> <span class="n">notebook_data</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">notebook</span><span class="p">)</span>

<span class="c1"># Specify the folder containing your notebooks and the output CSV file</span>
<span class="n">folder_path</span> <span class="o">=</span> <span class="s2">&quot;C:/Users/Alan.Moreira/Documents/GitHub/Lecturesv24/chapters/Finance&quot;</span>
<span class="n">output_csv</span> <span class="o">=</span> <span class="s2">&quot;notebook_analysis.csv&quot;</span>

<span class="c1"># Analyze notebooks and export results</span>
<span class="n">notebooks</span> <span class="o">=</span> <span class="n">analyze_all_notebooks</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
<span class="n">export_to_csv</span><span class="p">(</span><span class="n">notebooks</span><span class="p">,</span> <span class="n">output_csv</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./chapters/Finance"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Application: Market model</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#application-minimum-variance-investing">Application: Minimum-variance investing</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#a-bond-equity-strategic-investment-problem-of-an-international-investor">A bond-equity strategic investment problem of an international investor</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#numerical-solution">Numerical solution</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introducing-a-benchmark">Introducing a benchmark</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#information-ratio">Information Ratio</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#analytical-solution">Analytical solution</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#sharpe-ratio">Sharpe-ratio !</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-the-mean-variance-efficient-portfolio"><strong>Finding the Mean-variance efficient portfolio</strong></a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alan Moreira
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2021 Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0).
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>