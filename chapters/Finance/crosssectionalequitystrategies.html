
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>10. Cross-Sectional Trading strategies &#8212; Quantitative Investing</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/book.css?v=c2893119" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/Finance/crosssectionalequitystrategies';</script>
    <link rel="canonical" href="https://amoreira2.github.io/Fin418/chapters/Finance/crosssectionalequitystrategies.html" />
    <link rel="icon" href="../../_static/figuremain2.jpg"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="10.3. Signal Construction" href="Momentum.html" />
    <link rel="prev" title="9.2. Volatility Timing" href="Volatilitytiming.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/figuremain2.jpg" class="logo__image only-light" alt="Quantitative Investing - Home"/>
    <script>document.write(`<img src="../../_static/figuremain2.jpg" class="logo__image only-dark" alt="Quantitative Investing - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01/what-is-quant-investing.html">1. What is Data Driven Investing?</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01/statistical-techniques.html">1.1. Statistical Techniques</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/computational-tools.html">1.2. Computational tools</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../02/getting_started.html">2. Getting Started</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02/cloud_setup.html">2.3. Cloud Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/local_install.html">2.4. Local installation</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../essentials/intro.html">3. Python Essentials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../essentials/basics.html">3.1. Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/collections.html">3.2. Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/numpy.html">3.3. Numpy</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../essentials/introtopandas.html">3.4. Pandas</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/the_index.html">3.4.3. Indexing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/timeseries.html">3.4.4. Time-Series</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/reshape.html">3.4.5. Reshape</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/merge.html">3.4.6. Merge</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/groupby.html">3.4.7. Group-by</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/matplotlib.html">3.4.8. Plotting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/data_clean.html">3.4.9. Cleaning data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/storage_formats.html">3.4.10. Data Storage</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/control_flow.html">3.5. Flow control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/functions.html">3.6. Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/plotting.html">3.7. Plotting</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="IntrotoReturns.html">4. Introduction to Asset Returns</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="TheChoiceofFrequency.html">4.5. The Choice of Frequency and Annualization of Returns</a></li>
<li class="toctree-l2"><a class="reference internal" href="UsingAPI.html">4.6. Data APIs</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="FactorModels.html">5. Factor Models</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="PortfolioMath.html">6. Portfolios</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../scientific/linear_algebra1.html">6.5. Linear Algebra Review</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="CapitalAllocationI.html">7. Capital Allocation</a></li>
<li class="toctree-l1"><a class="reference internal" href="FactorModelEstimation.html">8. Factor Model Estimation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="Timing.html">9. Timing Strategies</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="MarketTiming.html">9.1. Expected Returns Timing</a></li>
<li class="toctree-l2"><a class="reference internal" href="Volatilitytiming.html">9.2. Volatility Timing</a></li>

</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="current reference internal" href="#">10. Cross-Sectional Equity Strategies</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="Momentum.html">10.3. Momentum factor</a></li>
<li class="toctree-l2"><a class="reference internal" href="Factors.html">10.4. An overview of factors</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="CapitalAllocationII.html">11. Capital Allocation II</a></li>
<li class="toctree-l1"><a class="reference internal" href="Performance_evaluation.html">12. Performance Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="MachineLearning.html">13. Machine Learning in Finance</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="MultiFactorModels.html">14. Multi Factor Models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="InterpretingFactorModels.html">14.6. 📊 Interpreting Factor Models</a></li>


</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="RiskManagement.html">15. Risk Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="TradingCosts.html">16. Liquidity and Trading Cost Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="LeverageandShorting.html">17. Leverage, Shorting, and Limits to Arbitrage</a></li>
<li class="toctree-l1"><a class="reference internal" href="GenAIandLLMsinFinance.html">18. Gen AI and LLMs in Finance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/additional.html">19. Additional Statistics Material</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Assignments/Assignments.html">20. Assignments</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment1.html">20.1. Assignment 1</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/amoreira2/Fin418/blob/main/chapters/Finance/crosssectionalequitystrategies.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/amoreira2/Fin418" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/amoreira2/Fin418/issues/new?title=Issue%20on%20page%20%2Fchapters/Finance/crosssectionalequitystrategies.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/chapters/Finance/crosssectionalequitystrategies.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Cross-Sectional Trading strategies</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-market-cap-weighted-strategy">10.1. The Market-Cap Weighted strategy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stacked-datasets">10.1.1. Stacked Datasets</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#characteristic-based-strategies">10.2. Characteristic-Based Strategies</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-value-investing">10.2.1. Example: Value investing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-the-recipe">10.2.2. Implementing the recipe</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#our-characteristic-data">10.2.2.1. Our Characteristic  data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#what-are-these-characteristics">10.2.2.2. What are these characteristics?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#group-assets-by-signal">10.2.2.3. Group assets by signal</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell tag_hide-cell docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell content</p>
<p class="expanded admonition-title">Hide code cell content</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!pip install wrds</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psycopg2</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">wrds</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas_datareader.data</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">web</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_factors</span><span class="p">(</span><span class="n">factors</span><span class="o">=</span><span class="s1">&#39;CAPM&#39;</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">):</span>   
    
    <span class="k">if</span> <span class="n">freq</span><span class="o">==</span><span class="s1">&#39;monthly&#39;</span><span class="p">:</span>
        <span class="n">freq_label</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">freq_label</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">freq</span>


    <span class="k">if</span> <span class="n">factors</span><span class="o">==</span><span class="s1">&#39;CAPM&#39;</span><span class="p">:</span>
        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_Factors&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
     
        <span class="n">df_factor</span> <span class="o">=</span> <span class="n">daily_data</span><span class="p">[[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]]</span> 
    <span class="k">elif</span> <span class="n">factors</span><span class="o">==</span><span class="s1">&#39;FF3&#39;</span><span class="p">:</span>
        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_Factors&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_factor</span> <span class="o">=</span> <span class="n">daily_data</span><span class="p">[[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span><span class="s1">&#39;HML&#39;</span><span class="p">]]</span>
    <span class="k">elif</span> <span class="n">factors</span><span class="o">==</span><span class="s1">&#39;FF5&#39;</span><span class="p">:</span>

        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_Factors&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_factor</span> <span class="o">=</span> <span class="n">daily_data</span><span class="p">[[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span><span class="s1">&#39;HML&#39;</span><span class="p">]]</span>
        <span class="n">fama_french2</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_5_Factors_2x3&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data2</span> <span class="o">=</span> <span class="n">fama_french2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_factor2</span> <span class="o">=</span> <span class="n">daily_data2</span><span class="p">[[</span><span class="s1">&#39;RMW&#39;</span><span class="p">,</span><span class="s1">&#39;CMA&#39;</span><span class="p">]]</span>
        <span class="n">df_factor</span><span class="o">=</span><span class="n">df_factor</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_factor2</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>    
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_Factors&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_factor</span> <span class="o">=</span> <span class="n">daily_data</span><span class="p">[[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span><span class="s1">&#39;HML&#39;</span><span class="p">]]</span>
        <span class="n">fama_french2</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_5_Factors_2x3&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data2</span> <span class="o">=</span> <span class="n">fama_french2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_factor2</span> <span class="o">=</span> <span class="n">daily_data2</span><span class="p">[[</span><span class="s1">&#39;RMW&#39;</span><span class="p">,</span><span class="s1">&#39;CMA&#39;</span><span class="p">]]</span>
        <span class="n">df_factor</span><span class="o">=</span><span class="n">df_factor</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_factor2</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>   
        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Momentum_Factor&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">df_factor</span><span class="o">=</span><span class="n">df_factor</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
        <span class="n">df_factor</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span><span class="s1">&#39;HML&#39;</span><span class="p">,</span><span class="s1">&#39;RMW&#39;</span><span class="p">,</span><span class="s1">&#39;CMA&#39;</span><span class="p">,</span><span class="s1">&#39;MOM&#39;</span><span class="p">]</span>    
    <span class="k">if</span> <span class="n">freq</span><span class="o">==</span><span class="s1">&#39;monthly&#39;</span><span class="p">:</span>
        <span class="n">df_factor</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_factor</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_factor</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_factor</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        


    <span class="k">return</span> <span class="n">df_factor</span><span class="o">/</span><span class="mi">100</span>
</pre></div>
</div>
</div>
</details>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="cross-sectional-trading-strategies">
<h1><span class="section-number">10. </span>Cross-Sectional Trading strategies<a class="headerlink" href="#cross-sectional-trading-strategies" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<p><strong>🎯 Learning Objectives</strong></p>
<ol class="arabic simple">
<li><p><strong>Contrast timing vs. cross-sectional approaches</strong><br />
Recognize that characteristic-based strategies keep aggregate market exposure roughly constant and instead shift weight across individual stocks according to firm-level signals.</p></li>
<li><p><strong>Master the four-step portfolio recipe</strong><br />
<em>Build a signal</em> → <em>sort stocks each month</em> → <em>weight within buckets (equal or market-cap)</em> → <em>form the long-short spread (top – bottom)</em>, always using information that is known on the trade date.</p></li>
<li><p><strong>Construct the market-cap-weighted benchmark correctly</strong><br />
Compute market capitalizations from lagged price × shares-outstanding and show how to aggregate them to the total-market portfolio, avoiding look-ahead bias.</p></li>
<li><p><strong>Organize large equity data sets efficiently</strong><br />
Work with “stacked” (date-firm) data frames, merge CRSP returns with characteristics, and reshape the grouped returns so they are ready for analysis and plotting.</p></li>
<li><p><strong>Code a reusable function that maps any signal to portfolios</strong><br />
Generalize the recipe into a single function that takes a signal (<code class="docutils literal notranslate"><span class="pre">X</span></code>), number of groups, and weighting choice, and then delivers decile returns, cumulative-return plots, and the long-short series.</p></li>
<li><p><strong>Develop empirical intuition about trade-offs</strong><br />
Explore how the number of groups, the dispersion of the signal, and the choice of weights influence the return spread, volatility, and diversification of the resulting portfolios.</p></li>
</ol>
<hr class="docutils" />
<section id="the-market-cap-weighted-strategy">
<h2><span class="section-number">10.1. </span>The Market-Cap Weighted strategy<a class="headerlink" href="#the-market-cap-weighted-strategy" title="Link to this heading">#</a></h2>
<p>As a warm up for you first factor construction we will construct the returns on the market portfolio</p>
<ul class="simple">
<li><p>In some way that is the most important strategy ever</p></li>
<li><p>It completely revolutionized Wall Street leading to the rise of index funds</p></li>
</ul>
<p>How to do it?</p>
<ul class="simple">
<li><p>start with a vector of market capitalization for all relevant assets <span class="math notranslate nohighlight">\(M_t=[m_t^{AAPL},m_t^{GOOG},m_t^{TSLA},..]\)</span></p></li>
</ul>
<div class="math notranslate nohighlight">
\[m_t^{AAPL}=P^{AAPL}_t\times SharesOutstanding^{AAPL}\]</div>
<p>The strategy then set the weights simply to</p>
<div class="math notranslate nohighlight">
\[X_t=\frac{M_t}{\sum_i^Im^i_t}\]</div>
<p>So at end of month <strong>t</strong> you look at the market caps, construct the weights, and buy the assets with weights <span class="math notranslate nohighlight">\(X_t\)</span> (at prices <span class="math notranslate nohighlight">\(P_t\)</span>) to earn</p>
<div class="math notranslate nohighlight">
\[R^{mcap}_{t+1}=X_tR_{t+1}\]</div>
<p>at the end of the next month.</p>
<p>That is you pay <span class="math notranslate nohighlight">\(P_t\)</span> and get back <span class="math notranslate nohighlight">\(P_{t+1}+D_{t+1}\)</span>, hence return <span class="math notranslate nohighlight">\(R_{t+1}=\frac{P_{t+1}+D_{t+1}}{P_t}\)</span></p>
<p>This portfolio has nice properties</p>
<ol class="arabic simple">
<li><p>This portfolio is very easy to trade. It does not require re-balancing as your weights naturally go up if the stock rallies and go down if the stock crashes</p></li>
<li><p>You can implement this approach to any subset of firms (for example SP500 or Russel2000) are market cap indexes that track a particular universe of stocks and we will be using it in our characteristic-based portfolios shortly</p></li>
<li><p>By buying proportionally to market cap you never have to build a huge position in a tiny stock–so this is much easier to trade!</p>
<ul class="simple">
<li><p>Equal weighted portfolio tend to be very hard to trade and the alphas that you get there are mostly a mirrage, unless you focus on large caps</p></li>
</ul>
</li>
</ol>
<blockquote>
<div><p><strong>Steps</strong></p>
<ol class="arabic simple">
<li><p>Get firm level monthly return data with market capitalizations</p></li>
<li><p>clean up/organize the data set</p></li>
<li><p>Make sure to lag the market cap signal so that we use prices from last month to trade at the start of this month ( we could also skip another month to be extra sure)</p></li>
<li><p>Construct the weighted average of returns across stocks for each date</p></li>
</ol>
</div></blockquote>
<section id="stacked-datasets">
<h3><span class="section-number">10.1.1. </span>Stacked Datasets<a class="headerlink" href="#stacked-datasets" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>We will now work with large data sets</p></li>
<li><p>Data sets that include all US stocks</p></li>
<li><p>Because there are many stocks, we have to work with it stacked</p></li>
</ul>
</div></blockquote>
<p><strong>Organizing the data</strong></p>
<p>The objective here is to have a data set with</p>
<ul class="simple">
<li><p>Security identifier</p></li>
<li><p>Date of the information</p></li>
<li><p>Monthly return of the firm in that month</p></li>
<li><p>Market capitalization of the firm in that month</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span><span class="o">=</span><span class="n">wrds</span><span class="o">.</span><span class="n">Connection</span><span class="p">()</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WRDS recommends setting up a .pgpass file.
Created .pgpass file successfully.
You can create this file yourself at any time with the create_pgpass_file() function.
Loading library list...
Done
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dateutil.relativedelta</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandas.tseries.offsets</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="c1">###################</span>



<span class="n">crsp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                      select a.permno,a.permco, a.date, b.shrcd, b.exchcd,b.ticker,</span>
<span class="s2">                      a.ret, a.shrout, a.prc,a.retx</span>
<span class="s2">                      from crsp.msf as a</span>
<span class="s2">                      left join crsp.msenames as b</span>
<span class="s2">                      on a.permno=b.permno</span>
<span class="s2">                      and b.namedt&lt;=a.date</span>
<span class="s2">                      and a.date&lt;=b.nameendt</span>
<span class="s2">                      where a.date between &#39;01/31/2015&#39; and &#39;12/31/2024&#39;</span>
<span class="s2">                      and b.exchcd between 1 and 3</span>
<span class="s2">                      and b.shrcd between 10 and 11</span>
<span class="s2">                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">date_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span> 


<span class="c1"># this saves it</span>
<span class="n">crsp</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;../../assets/data/crspm.pkl&#39;</span><span class="p">)</span>
<span class="c1"># variables downloaded</span>

<span class="c1"># 1. Permno-- are unique indentifier to a security </span>
<span class="c1"># (for exmaple a stock that has multiple types of stocks will have multiple permnos)</span>

<span class="c1"># 2. shrco is the type of share: common share, ADR, ETF, ....</span>
<span class="c1"># we will focus on common shares</span>

<span class="c1"># 3. exchcd is the code of the exchange where the stock was originally listed</span>
<span class="c1"># we will focus on stock listed in the 3 major stock exchanges ( basically the whole market)</span>

<span class="c1"># 4. ret,retx, shrout,  prc, are the stock return, the stock return excluding dividends, number of shares outstanding, and price</span>

<span class="c1"># 5. date is the trading date of the return</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p><em>If you don’t want to deal with that you can simply get the data by running the code below</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;https://github.com/amoreira2/Fin418/blob/main/assets/data/crspm20022016.pkl?raw=true&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">crsp</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;https://github.com/amoreira2/Fin418/blob/main/assets/data/crspm20022016.pkl?raw=true&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;pd&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permco&#39;</span><span class="p">,</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span><span class="s1">&#39;shrout&#39;</span><span class="p">,</span><span class="s1">&#39;prc&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># change variable format to int</span>
<span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Line up date to be end of month </span>
<span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># calculate market equity</span>
<span class="c1"># why do we use absolute value of price?</span>
<span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">*</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;shrout&#39;</span><span class="p">]</span> 

<span class="c1"># sort by permno and date and also drop duplicates</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

<span class="n">crsp</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permco</th>
      <th>permno</th>
      <th>ticker</th>
      <th>date</th>
      <th>ret</th>
      <th>shrout</th>
      <th>prc</th>
      <th>me</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>60</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2015-02-28</td>
      <td>0.035898</td>
      <td>10488.0</td>
      <td>10.10</td>
      <td>105928.80</td>
    </tr>
    <tr>
      <th>61</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2015-03-31</td>
      <td>-0.000495</td>
      <td>10452.0</td>
      <td>9.96</td>
      <td>104101.92</td>
    </tr>
    <tr>
      <th>62</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2015-04-30</td>
      <td>0.011044</td>
      <td>10452.0</td>
      <td>10.07</td>
      <td>105251.64</td>
    </tr>
    <tr>
      <th>63</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2015-05-31</td>
      <td>-0.006951</td>
      <td>10488.0</td>
      <td>10.00</td>
      <td>104880.00</td>
    </tr>
    <tr>
      <th>64</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2015-06-30</td>
      <td>0.030000</td>
      <td>10493.0</td>
      <td>10.30</td>
      <td>108077.90</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pandas.tseries.offsets</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permco&#39;</span><span class="p">,</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span><span class="s1">&#39;shrout&#39;</span><span class="p">,</span><span class="s1">&#39;prc&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># change variable format to int</span>
<span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permco&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permco&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="c1"># Line up date to be end of month </span>
<span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># calculate market equity</span>
<span class="c1"># why do we use absolute value of price?</span>
<span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">*</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;shrout&#39;</span><span class="p">]</span> 
<span class="c1"># drop price and shareoustandng since we won&#39;t need it anymore</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;prc&#39;</span><span class="p">,</span><span class="s1">&#39;shrout&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">crsp_me</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;permco&#39;</span><span class="p">])[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>


<span class="c1"># largest mktcap within a permco/date</span>
<span class="n">crsp_maxme</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;permco&#39;</span><span class="p">])[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># join by jdate/maxme to find the permno</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span> <span class="n">crsp_maxme</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;permco&#39;</span><span class="p">,</span><span class="s1">&#39;me&#39;</span><span class="p">])</span>

<span class="c1"># drop me column and replace with the sum me</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;me&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># join with sum of me to get the correct market cap info</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span> <span class="n">crsp_me</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;permco&#39;</span><span class="p">])</span>

<span class="c1"># sort by permno and date and also drop duplicates</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

<span class="n">crsp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permco</th>
      <th>permno</th>
      <th>ticker</th>
      <th>date</th>
      <th>ret</th>
      <th>me</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>550</th>
      <td>7953</td>
      <td>10001</td>
      <td>EWST</td>
      <td>2002-01-31</td>
      <td>-0.013100</td>
      <td>28995.8000</td>
    </tr>
    <tr>
      <th>551</th>
      <td>7953</td>
      <td>10001</td>
      <td>EWST</td>
      <td>2002-02-28</td>
      <td>-0.053097</td>
      <td>27488.3000</td>
    </tr>
    <tr>
      <th>552</th>
      <td>7953</td>
      <td>10001</td>
      <td>EWST</td>
      <td>2002-03-31</td>
      <td>-0.015888</td>
      <td>26738.4000</td>
    </tr>
    <tr>
      <th>553</th>
      <td>7953</td>
      <td>10001</td>
      <td>EWST</td>
      <td>2002-04-30</td>
      <td>-0.043269</td>
      <td>25581.4500</td>
    </tr>
    <tr>
      <th>554</th>
      <td>7953</td>
      <td>10001</td>
      <td>EWST</td>
      <td>2002-05-31</td>
      <td>0.014824</td>
      <td>25960.6725</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<blockquote>
<div><p>Take time to note the stacked structure of the data set</p>
<ul class="simple">
<li><p>Before with a “rectangular” data set  we need two coordinates, row and column, to identify the return of an asset in a particular date</p></li>
<li><p>It was easier to manipulate but we would need one dataframe for each different firm variable: In this case one for return and one for market equity</p></li>
<li><p>As we work with many signals, this becomes intractable because we would need many dataframes</p></li>
<li><p>As we work with many asset, this would become intractable because we would need dataframes with many columns with most locations empty. This is very inefficient and hard to manipulate</p></li>
</ul>
<h3 class="rubric" id="stacked-data-sets">Stacked data sets</h3>
<ul class="simple">
<li><p>Now we need two coordinates both in columns, “date” and “permco”, to identify one firm-date observation, and then a third coordinate, the column names to identify the particular variable for that firm-date pair</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><p><strong>Lagging the market cap signal</strong></p>
<ul class="simple">
<li><p>We use the method <code class="docutils literal notranslate"><span class="pre">.shift(d)</span></code> which “lags” the data by d periods.</p></li>
<li><p>It is important that we have our data set sorted by date</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shift(d)</span></code> simply shifts the rows. So you have to make sure that it is actually lagging by date.</p></li>
</ul>
<p>The way to do that is to  <code class="docutils literal notranslate"><span class="pre">groupby</span></code> security and applying the shift within security.</p>
</div></blockquote>
<blockquote>
<div><p>Why this is important?</p>
<ul class="simple">
<li><p>Because the data set is stacked so when you shift the first month of security n, it will end up returning the last month of security n-1.</p></li>
<li><p>By “grouping by” we correctly assign a missing value there since we don’t have the data</p></li>
</ul>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sort by permno and date and set as index</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;me_l1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">me</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permco</th>
      <th>permno</th>
      <th>ticker</th>
      <th>date</th>
      <th>ret</th>
      <th>shrout</th>
      <th>prc</th>
      <th>me</th>
      <th>me_l1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>60</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2015-02-28</td>
      <td>0.035898</td>
      <td>10488.0</td>
      <td>10.10000</td>
      <td>1.059288e+05</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>61</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2015-03-31</td>
      <td>-0.000495</td>
      <td>10452.0</td>
      <td>9.96000</td>
      <td>1.041019e+05</td>
      <td>1.059288e+05</td>
    </tr>
    <tr>
      <th>62</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2015-04-30</td>
      <td>0.011044</td>
      <td>10452.0</td>
      <td>10.07000</td>
      <td>1.052516e+05</td>
      <td>1.041019e+05</td>
    </tr>
    <tr>
      <th>63</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2015-05-31</td>
      <td>-0.006951</td>
      <td>10488.0</td>
      <td>10.00000</td>
      <td>1.048800e+05</td>
      <td>1.052516e+05</td>
    </tr>
    <tr>
      <th>64</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2015-06-30</td>
      <td>0.030000</td>
      <td>10493.0</td>
      <td>10.30000</td>
      <td>1.080779e+05</td>
      <td>1.048800e+05</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>456021</th>
      <td>53453</td>
      <td>93436</td>
      <td>TSLA</td>
      <td>2024-08-31</td>
      <td>-0.077391</td>
      <td>3194640.0</td>
      <td>214.11000</td>
      <td>6.840044e+08</td>
      <td>7.413801e+08</td>
    </tr>
    <tr>
      <th>456022</th>
      <td>53453</td>
      <td>93436</td>
      <td>TSLA</td>
      <td>2024-09-30</td>
      <td>0.221942</td>
      <td>3207000.0</td>
      <td>261.63000</td>
      <td>8.390474e+08</td>
      <td>6.840044e+08</td>
    </tr>
    <tr>
      <th>456023</th>
      <td>53453</td>
      <td>93436</td>
      <td>TSLA</td>
      <td>2024-10-31</td>
      <td>-0.045025</td>
      <td>3210060.0</td>
      <td>249.85001</td>
      <td>8.020335e+08</td>
      <td>8.390474e+08</td>
    </tr>
    <tr>
      <th>456024</th>
      <td>53453</td>
      <td>93436</td>
      <td>TSLA</td>
      <td>2024-11-30</td>
      <td>0.381469</td>
      <td>3210060.0</td>
      <td>345.16000</td>
      <td>1.107984e+09</td>
      <td>8.020335e+08</td>
    </tr>
    <tr>
      <th>456025</th>
      <td>53453</td>
      <td>93436</td>
      <td>TSLA</td>
      <td>2024-12-31</td>
      <td>0.170008</td>
      <td>3210060.0</td>
      <td>403.84000</td>
      <td>1.296351e+09</td>
      <td>1.107984e+09</td>
    </tr>
  </tbody>
</table>
<p>457062 rows × 9 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permco</th>
      <th>permno</th>
      <th>ticker</th>
      <th>date</th>
      <th>ret</th>
      <th>shrout</th>
      <th>prc</th>
      <th>me</th>
      <th>me_l1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>302</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2016-10-31</td>
      <td>0.619948</td>
      <td>10520.0</td>
      <td>12.350</td>
      <td>129922.00</td>
      <td>80657.72</td>
    </tr>
    <tr>
      <th>303</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2016-11-30</td>
      <td>0.012146</td>
      <td>10520.0</td>
      <td>12.500</td>
      <td>131500.00</td>
      <td>129922.00</td>
    </tr>
    <tr>
      <th>304</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2016-12-31</td>
      <td>0.010000</td>
      <td>10520.0</td>
      <td>12.550</td>
      <td>132026.00</td>
      <td>131500.00</td>
    </tr>
    <tr>
      <th>305</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2017-01-31</td>
      <td>0.007968</td>
      <td>10520.0</td>
      <td>12.650</td>
      <td>133078.00</td>
      <td>132026.00</td>
    </tr>
    <tr>
      <th>306</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2017-02-28</td>
      <td>0.000000</td>
      <td>10520.0</td>
      <td>12.650</td>
      <td>133078.00</td>
      <td>133078.00</td>
    </tr>
    <tr>
      <th>307</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2017-03-31</td>
      <td>0.009881</td>
      <td>10520.0</td>
      <td>12.700</td>
      <td>133604.00</td>
      <td>133078.00</td>
    </tr>
    <tr>
      <th>308</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2017-04-30</td>
      <td>-0.015748</td>
      <td>10520.0</td>
      <td>12.500</td>
      <td>131500.00</td>
      <td>133604.00</td>
    </tr>
    <tr>
      <th>309</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2017-05-31</td>
      <td>0.016000</td>
      <td>10520.0</td>
      <td>12.700</td>
      <td>133604.00</td>
      <td>131500.00</td>
    </tr>
    <tr>
      <th>310</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2017-06-30</td>
      <td>0.023622</td>
      <td>10520.0</td>
      <td>12.925</td>
      <td>135971.00</td>
      <td>133604.00</td>
    </tr>
    <tr>
      <th>311</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2017-07-31</td>
      <td>0.001934</td>
      <td>10520.0</td>
      <td>12.950</td>
      <td>136234.00</td>
      <td>135971.00</td>
    </tr>
    <tr>
      <th>1010</th>
      <td>7975</td>
      <td>10025</td>
      <td>AEPI</td>
      <td>2015-02-28</td>
      <td>0.010976</td>
      <td>5083.0</td>
      <td>50.660</td>
      <td>257504.78</td>
      <td>136234.00</td>
    </tr>
    <tr>
      <th>1011</th>
      <td>7975</td>
      <td>10025</td>
      <td>AEPI</td>
      <td>2015-03-31</td>
      <td>0.086459</td>
      <td>5083.0</td>
      <td>55.040</td>
      <td>279768.32</td>
      <td>257504.78</td>
    </tr>
    <tr>
      <th>1012</th>
      <td>7975</td>
      <td>10025</td>
      <td>AEPI</td>
      <td>2015-04-30</td>
      <td>-0.089753</td>
      <td>5103.0</td>
      <td>50.100</td>
      <td>255660.30</td>
      <td>279768.32</td>
    </tr>
    <tr>
      <th>1013</th>
      <td>7975</td>
      <td>10025</td>
      <td>AEPI</td>
      <td>2015-05-31</td>
      <td>-0.001397</td>
      <td>5103.0</td>
      <td>50.030</td>
      <td>255303.09</td>
      <td>255660.30</td>
    </tr>
    <tr>
      <th>1014</th>
      <td>7975</td>
      <td>10025</td>
      <td>AEPI</td>
      <td>2015-06-30</td>
      <td>0.103338</td>
      <td>5103.0</td>
      <td>55.200</td>
      <td>281685.60</td>
      <td>255303.09</td>
    </tr>
    <tr>
      <th>1015</th>
      <td>7975</td>
      <td>10025</td>
      <td>AEPI</td>
      <td>2015-07-31</td>
      <td>-0.124094</td>
      <td>5103.0</td>
      <td>48.350</td>
      <td>246730.05</td>
      <td>281685.60</td>
    </tr>
    <tr>
      <th>1016</th>
      <td>7975</td>
      <td>10025</td>
      <td>AEPI</td>
      <td>2015-08-31</td>
      <td>0.126163</td>
      <td>5103.0</td>
      <td>54.450</td>
      <td>277858.35</td>
      <td>246730.05</td>
    </tr>
    <tr>
      <th>1017</th>
      <td>7975</td>
      <td>10025</td>
      <td>AEPI</td>
      <td>2015-09-30</td>
      <td>0.052893</td>
      <td>5103.0</td>
      <td>57.330</td>
      <td>292554.99</td>
      <td>277858.35</td>
    </tr>
    <tr>
      <th>1018</th>
      <td>7975</td>
      <td>10025</td>
      <td>AEPI</td>
      <td>2015-10-31</td>
      <td>0.395430</td>
      <td>5103.0</td>
      <td>80.000</td>
      <td>408240.00</td>
      <td>292554.99</td>
    </tr>
    <tr>
      <th>1019</th>
      <td>7975</td>
      <td>10025</td>
      <td>AEPI</td>
      <td>2015-11-30</td>
      <td>0.139750</td>
      <td>5103.0</td>
      <td>91.180</td>
      <td>465291.54</td>
      <td>408240.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;me_l1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">me</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">change_idx</span> <span class="o">=</span> <span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
<span class="n">crsp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">]</span>
<span class="c1"># did it get fixed?</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permco</th>
      <th>permno</th>
      <th>ticker</th>
      <th>date</th>
      <th>ret</th>
      <th>shrout</th>
      <th>prc</th>
      <th>me</th>
      <th>me_l1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1030</th>
      <td>7975</td>
      <td>10025</td>
      <td>AEPI</td>
      <td>2016-10-31</td>
      <td>0.003932</td>
      <td>5114.0</td>
      <td>109.55</td>
      <td>560238.70</td>
      <td>559318.18</td>
    </tr>
    <tr>
      <th>1031</th>
      <td>7975</td>
      <td>10025</td>
      <td>AEPI</td>
      <td>2016-11-30</td>
      <td>0.075764</td>
      <td>5114.0</td>
      <td>117.85</td>
      <td>602684.90</td>
      <td>560238.70</td>
    </tr>
    <tr>
      <th>1032</th>
      <td>7975</td>
      <td>10025</td>
      <td>AEPI</td>
      <td>2016-12-31</td>
      <td>-0.014849</td>
      <td>5114.0</td>
      <td>116.10</td>
      <td>593735.40</td>
      <td>602684.90</td>
    </tr>
    <tr>
      <th>756</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2015-02-28</td>
      <td>0.031288</td>
      <td>18688.0</td>
      <td>101.19</td>
      <td>1891038.72</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>757</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2015-03-31</td>
      <td>0.058010</td>
      <td>18689.0</td>
      <td>106.70</td>
      <td>1994116.30</td>
      <td>1891038.72</td>
    </tr>
    <tr>
      <th>758</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2015-04-30</td>
      <td>-0.022212</td>
      <td>18691.0</td>
      <td>104.33</td>
      <td>1950032.03</td>
      <td>1994116.30</td>
    </tr>
    <tr>
      <th>759</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2015-05-31</td>
      <td>0.033260</td>
      <td>18691.0</td>
      <td>107.80</td>
      <td>2014889.80</td>
      <td>1950032.03</td>
    </tr>
    <tr>
      <th>760</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2015-06-30</td>
      <td>0.029963</td>
      <td>18692.0</td>
      <td>110.67</td>
      <td>2068643.64</td>
      <td>2014889.80</td>
    </tr>
    <tr>
      <th>761</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2015-07-31</td>
      <td>0.069486</td>
      <td>18699.0</td>
      <td>118.36</td>
      <td>2213213.64</td>
      <td>2068643.64</td>
    </tr>
    <tr>
      <th>762</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2015-08-31</td>
      <td>-0.037175</td>
      <td>18699.0</td>
      <td>113.96</td>
      <td>2130938.04</td>
      <td>2213213.64</td>
    </tr>
    <tr>
      <th>763</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2015-09-30</td>
      <td>0.000527</td>
      <td>18676.0</td>
      <td>113.66</td>
      <td>2122714.16</td>
      <td>2130938.04</td>
    </tr>
    <tr>
      <th>764</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2015-10-31</td>
      <td>0.080327</td>
      <td>18676.0</td>
      <td>122.79</td>
      <td>2293226.04</td>
      <td>2122714.16</td>
    </tr>
    <tr>
      <th>765</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2015-11-30</td>
      <td>-0.049760</td>
      <td>18686.0</td>
      <td>116.68</td>
      <td>2180282.48</td>
      <td>2293226.04</td>
    </tr>
    <tr>
      <th>766</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2015-12-31</td>
      <td>0.003257</td>
      <td>18677.0</td>
      <td>116.67</td>
      <td>2179045.59</td>
      <td>2180282.48</td>
    </tr>
    <tr>
      <th>767</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2016-01-31</td>
      <td>-0.074484</td>
      <td>18686.0</td>
      <td>107.98</td>
      <td>2017714.28</td>
      <td>2179045.59</td>
    </tr>
    <tr>
      <th>768</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2016-02-29</td>
      <td>0.026023</td>
      <td>18686.0</td>
      <td>110.79</td>
      <td>2070221.94</td>
      <td>2017714.28</td>
    </tr>
    <tr>
      <th>769</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2016-03-31</td>
      <td>-0.019135</td>
      <td>18617.0</td>
      <td>108.28</td>
      <td>2015848.76</td>
      <td>2070221.94</td>
    </tr>
    <tr>
      <th>770</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2016-04-30</td>
      <td>-0.066033</td>
      <td>18619.0</td>
      <td>101.13</td>
      <td>1882939.47</td>
      <td>2015848.76</td>
    </tr>
    <tr>
      <th>771</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2016-05-31</td>
      <td>0.043212</td>
      <td>18619.0</td>
      <td>105.50</td>
      <td>1964304.50</td>
      <td>1882939.47</td>
    </tr>
    <tr>
      <th>772</th>
      <td>7976</td>
      <td>10026</td>
      <td>JJSF</td>
      <td>2016-06-30</td>
      <td>0.134218</td>
      <td>18618.0</td>
      <td>119.27</td>
      <td>2220568.86</td>
      <td>1964304.50</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Rmkt</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="o">.</span><span class="n">ret</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">me_l1</span><span class="o">/</span><span class="n">x</span><span class="o">.</span><span class="n">me_l1</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">groupby(['date'])</span></code> method groups the data by month so we obtain the return of the portfolio in that month</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(x.me/x.me.sum())</span></code> has the weights in a given date, which for each date will return a vector that adds up to one.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(x.ret*(x.me/x.me.sum())</span></code> multiplies the return of each asset by the weight</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(x.ret*(x.me/x.me.sum())).sum()</span></code>  sum all up to get the reutrn of the portfolio</p></li>
</ul>
</div></blockquote>
<p>Lets compare our factor with the one ken french website</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Lets look at the cumulative return</span>
<span class="n">df</span><span class="o">=</span><span class="n">get_factors</span><span class="p">(</span><span class="s1">&#39;CAPM&#39;</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">)</span>

<span class="p">(</span><span class="n">Rmkt</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])[</span><span class="s1">&#39;2015&#39;</span><span class="p">:</span><span class="s1">&#39;2024&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\Users\alan.moreira\Anaconda3\lib\site-packages\pandas_datareader\famafrench.py:114: FutureWarning: The argument &#39;date_parser&#39; is deprecated and will be removed in a future version. Please use &#39;date_format&#39; instead, or read your data in as &#39;object&#39; dtype and then call &#39;to_datetime&#39;.
  df = read_csv(StringIO(&quot;Date&quot; + src[start:]), **params)
c:\Users\alan.moreira\Anaconda3\lib\site-packages\pandas_datareader\famafrench.py:114: FutureWarning: The argument &#39;date_parser&#39; is deprecated and will be removed in a future version. Please use &#39;date_format&#39; instead, or read your data in as &#39;object&#39; dtype and then call &#39;to_datetime&#39;.
  df = read_csv(StringIO(&quot;Date&quot; + src[start:]), **params)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;Date&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/1224c734b5634d49ce43998d9ab6c69be313355317aa67e3bff1e28a69147a9a.png" src="../../_images/1224c734b5634d49ce43998d9ab6c69be313355317aa67e3bff1e28a69147a9a.png" />
</div>
</div>
<p><strong>Things to try</strong></p>
<ul class="simple">
<li><p>Suppose you wanted to construct something “like” the SP500? I.e. do market cap weights but only for the 500 largest firms in a given month. How would you do that?</p></li>
<li><p>Suppose you lag market cap 2 months instead of 1 does it make any difference? Do you expect there is any difference</p></li>
<li><p>Suppose you drop the stocks with “negative” prices, does it make a difference?</p></li>
</ul>
</section>
</section>
<section id="characteristic-based-strategies">
<h2><span class="section-number">10.2. </span>Characteristic-Based Strategies<a class="headerlink" href="#characteristic-based-strategies" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>So far we have looked at strategies that go in and out of a particular asset according to a signal.</p></li>
<li><p>Now we will look at strategies that trade of asset characteristics</p></li>
</ul>
<p><strong>The  recipe</strong></p>
<ol class="arabic simple">
<li><p>Construct a characteristic for each stock.</p>
<ul class="simple">
<li><p>It can be based on accounting data (aka fundamentals), return data, textual data from earning calls, twitter activity, ownership, shorting activity, satellite images–</p></li>
<li><p>You can do for anything</p></li>
<li><p>What is important is that for each stock in each date you have a value for this characteristic</p></li>
<li><p>And you have a sense/theory of how this chracteristic relates to expected returns</p></li>
</ul>
</li>
<li><p>On a given date sort stocks by this characteristic.</p>
<ul class="simple">
<li><p>It is key that this characteristic is in fact known at sorting date!</p></li>
<li><p>Extremely careful not to introduce “look-ahead” bias</p></li>
</ul>
</li>
<li><p>Construct portfolios by dividing stocks in deciles/quintiles and “10” form portfolios of stocks that have similar characteristic</p>
<ul class="simple">
<li><p>You can either equal weight or value weight within portfolio</p></li>
<li><p>Value-weighed portfolios are easier to trade, but if you are focused on large caps, you can go with either</p></li>
<li><p>But what is important is that each portfolio will have stocks of have very different characteristic values</p></li>
</ul>
</li>
<li><p>Construct the long-short where you go long portfolio “10” and short portfolio “1” (or vice versa) but the point is to take a bet on the characteristic spread</p></li>
</ol>
<blockquote>
<div><p><strong>The goal here is to produce alpha</strong></p>
</div></blockquote>
<blockquote>
<div><ul class="simple">
<li><p>this is a simple and algorithimic  way to implement your idea in a way that harvest the benefits of diversification</p></li>
<li><p>Instead of betting on Apple because it is exposed to tariffs, build a tariff exposure “characteristic”</p></li>
</ul>
</div></blockquote>
<p><strong>From “names”  to characteristics</strong></p>
<ul class="simple">
<li><p>The  sorting by date keeps the stocks inside the portfolios with similar characteristics</p></li>
<li><p>This sorting will “work” if these chracteristics are good proxies for the behavior of the stock returns</p></li>
<li><p>Indeed, the key is that each portfolio has stocks of vastly different characterisitcs and keeps churning as firms change</p>
<ul>
<li><p>Let’s take MSFT (microsoft) as an example:</p></li>
<li><p>MSFT transitioned from being small in the 80’s to be gigantic in the 90’s, as a result, it moved up from the small portfolio to the big portfolio</p></li>
<li><p>During the Tech boom when MSFT had a huge valuation relative to it’s book value, it went to the low BM portfolio</p></li>
<li><p>But then MSFT transtioned back to the high BM portfolio once it’s market valuation collapsed in the aftermath of the techbubble</p></li>
<li><p>Now with AI, MSFT is back into the low BM portfolio</p></li>
<li><p>During these 80 years MSFT changed dramatically and the characteristic changed with it…</p></li>
</ul>
</li>
<li><p>The key is that firms’ characteristics change over time, by constructing  portfolios, we hope to estimate some stable parameters (for example, alpha and beta)</p></li>
<li><p>But it doesn’t work always, if you use the first letter of stock ticker to construct 26 portfolios you are unlikely to get spread in average returns and most likely each portfolio will resemble the market portfolio but with much more volatility.</p></li>
<li><p>The characteristics have to capture the right economics/market dynamics</p></li>
</ul>
<section id="example-value-investing">
<h3><span class="section-number">10.2.1. </span>Example: Value investing<a class="headerlink" href="#example-value-investing" title="Link to this heading">#</a></h3>
<p>Wall street talks a lot in terms of earnings</p>
</section>
<section id="implementing-the-recipe">
<h3><span class="section-number">10.2.2. </span>Implementing the recipe<a class="headerlink" href="#implementing-the-recipe" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>We will start with a constructed characteristic <span class="math notranslate nohighlight">\(c_{i,t}\)</span></p></li>
<li><p>Produce 10 portfolios based on this characteristic</p>
<ul class="simple">
<li><p>Members of portfolio 1 in date t have the bottom 10% value of the characteristics in date t</p></li>
<li><p>Members of portfolio 2 in date t have characteristic between 10% and 20% of the characteristics in date t</p></li>
</ul>
</li>
<li><p>Given these memberships for each date we will the construct return by buying at the closing price of date t and selling at the closing on date t+1</p>
<ul class="simple">
<li><p>We will typically work with monthly data, so this should read as the closing of the last date of months t and t+1</p></li>
</ul>
</li>
</ol>
<p>We start by loading a dataset where you have many signals</p>
<section id="our-characteristic-data">
<h4><span class="section-number">10.2.2.1. </span>Our Characteristic  data<a class="headerlink" href="#our-characteristic-data" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/amoreira2/Fin418/blob/main/assets/data/characteristics20022016.pkl?raw=true&quot;</span>

<span class="n">df_X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">df_X</span><span class="o">=</span><span class="n">df_X</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_X</span><span class="o">.</span><span class="n">date</span><span class="o">=</span><span class="n">df_X</span><span class="o">.</span><span class="n">date</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">MonthEnd</span><span class="p">()</span>
<span class="n">df_X</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>permno</th>
      <th>re</th>
      <th>rf</th>
      <th>rme</th>
      <th>size</th>
      <th>value</th>
      <th>prof</th>
      <th>fscore</th>
      <th>debtiss</th>
      <th>...</th>
      <th>momrev</th>
      <th>valuem</th>
      <th>nissm</th>
      <th>strev</th>
      <th>ivol</th>
      <th>betaarb</th>
      <th>indrrev</th>
      <th>price</th>
      <th>age</th>
      <th>shvol</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>163913</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>...</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
      <td>163913.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>2009-07-17 14:37:46.612166400</td>
      <td>60452.050222</td>
      <td>0.007979</td>
      <td>0.001032</td>
      <td>0.005875</td>
      <td>15.550336</td>
      <td>-0.912667</td>
      <td>-1.556057</td>
      <td>4.933819</td>
      <td>0.362827</td>
      <td>...</td>
      <td>0.057370</td>
      <td>-0.948673</td>
      <td>0.700911</td>
      <td>0.014663</td>
      <td>0.015696</td>
      <td>1.032455</td>
      <td>0.006188</td>
      <td>3.664508</td>
      <td>5.512095</td>
      <td>1.057609</td>
    </tr>
    <tr>
      <th>min</th>
      <td>2002-01-31 00:00:00</td>
      <td>10026.000000</td>
      <td>-0.870345</td>
      <td>0.000000</td>
      <td>-0.172300</td>
      <td>11.501877</td>
      <td>-8.756389</td>
      <td>-10.213809</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>-3.055986</td>
      <td>-8.818536</td>
      <td>0.329881</td>
      <td>-0.868645</td>
      <td>0.000463</td>
      <td>0.241380</td>
      <td>-0.820129</td>
      <td>0.570980</td>
      <td>3.637586</td>
      <td>0.003904</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>2005-10-31 00:00:00</td>
      <td>35238.000000</td>
      <td>-0.040199</td>
      <td>0.000000</td>
      <td>-0.018300</td>
      <td>14.676361</td>
      <td>-1.351522</td>
      <td>-2.087953</td>
      <td>4.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>-0.053707</td>
      <td>-1.384280</td>
      <td>0.682923</td>
      <td>-0.035392</td>
      <td>0.009952</td>
      <td>0.851590</td>
      <td>-0.033465</td>
      <td>3.258097</td>
      <td>5.003946</td>
      <td>0.748381</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>2009-06-30 00:00:00</td>
      <td>73139.000000</td>
      <td>0.008931</td>
      <td>0.000200</td>
      <td>0.009200</td>
      <td>15.293713</td>
      <td>-0.850813</td>
      <td>-1.346370</td>
      <td>5.000000</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.072849</td>
      <td>-0.900369</td>
      <td>0.694412</td>
      <td>0.013158</td>
      <td>0.013612</td>
      <td>1.003569</td>
      <td>0.002659</td>
      <td>3.679082</td>
      <td>5.575949</td>
      <td>0.999129</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>2013-03-31 00:00:00</td>
      <td>84168.000000</td>
      <td>0.056648</td>
      <td>0.001500</td>
      <td>0.032300</td>
      <td>16.240260</td>
      <td>-0.378992</td>
      <td>-0.875085</td>
      <td>6.000000</td>
      <td>1.000000</td>
      <td>...</td>
      <td>0.191116</td>
      <td>-0.417606</td>
      <td>0.701702</td>
      <td>0.061674</td>
      <td>0.019028</td>
      <td>1.178665</td>
      <td>0.040915</td>
      <td>4.063370</td>
      <td>6.165418</td>
      <td>1.312665</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2016-12-31 00:00:00</td>
      <td>93436.000000</td>
      <td>1.597907</td>
      <td>0.004400</td>
      <td>0.113500</td>
      <td>20.388632</td>
      <td>2.370495</td>
      <td>0.837982</td>
      <td>8.000000</td>
      <td>1.000000</td>
      <td>...</td>
      <td>3.302411</td>
      <td>2.329125</td>
      <td>2.711109</td>
      <td>2.596567</td>
      <td>0.218682</td>
      <td>2.350102</td>
      <td>2.134880</td>
      <td>11.631769</td>
      <td>6.555357</td>
      <td>4.319359</td>
    </tr>
    <tr>
      <th>std</th>
      <td>NaN</td>
      <td>27258.977322</td>
      <td>0.094412</td>
      <td>0.001368</td>
      <td>0.041751</td>
      <td>1.161036</td>
      <td>0.782885</td>
      <td>0.965714</td>
      <td>1.290275</td>
      <td>0.480817</td>
      <td>...</td>
      <td>0.259801</td>
      <td>0.784227</td>
      <td>0.060812</td>
      <td>0.095684</td>
      <td>0.008647</td>
      <td>0.251549</td>
      <td>0.077490</td>
      <td>0.685092</td>
      <td>0.726630</td>
      <td>0.435991</td>
    </tr>
  </tbody>
</table>
<p>8 rows × 34 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_colwidth&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">df_X</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
      <th>std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>date</th>
      <td>163913</td>
      <td>2009-07-17 14:37:46.612166400</td>
      <td>2002-01-31 00:00:00</td>
      <td>2005-10-31 00:00:00</td>
      <td>2009-06-30 00:00:00</td>
      <td>2013-03-31 00:00:00</td>
      <td>2016-12-31 00:00:00</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>permno</th>
      <td>163913.0</td>
      <td>60452.050222</td>
      <td>10026.0</td>
      <td>35238.0</td>
      <td>73139.0</td>
      <td>84168.0</td>
      <td>93436.0</td>
      <td>27258.977322</td>
    </tr>
    <tr>
      <th>re</th>
      <td>163913.0</td>
      <td>0.007979</td>
      <td>-0.870345</td>
      <td>-0.040199</td>
      <td>0.008931</td>
      <td>0.056648</td>
      <td>1.597907</td>
      <td>0.094412</td>
    </tr>
    <tr>
      <th>rf</th>
      <td>163913.0</td>
      <td>0.001032</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0002</td>
      <td>0.0015</td>
      <td>0.0044</td>
      <td>0.001368</td>
    </tr>
    <tr>
      <th>rme</th>
      <td>163913.0</td>
      <td>0.005875</td>
      <td>-0.1723</td>
      <td>-0.0183</td>
      <td>0.0092</td>
      <td>0.0323</td>
      <td>0.1135</td>
      <td>0.041751</td>
    </tr>
    <tr>
      <th>size</th>
      <td>163913.0</td>
      <td>15.550336</td>
      <td>11.501877</td>
      <td>14.676361</td>
      <td>15.293713</td>
      <td>16.24026</td>
      <td>20.388632</td>
      <td>1.161036</td>
    </tr>
    <tr>
      <th>value</th>
      <td>163913.0</td>
      <td>-0.912667</td>
      <td>-8.756389</td>
      <td>-1.351522</td>
      <td>-0.850813</td>
      <td>-0.378992</td>
      <td>2.370495</td>
      <td>0.782885</td>
    </tr>
    <tr>
      <th>prof</th>
      <td>163913.0</td>
      <td>-1.556057</td>
      <td>-10.213809</td>
      <td>-2.087953</td>
      <td>-1.34637</td>
      <td>-0.875085</td>
      <td>0.837982</td>
      <td>0.965714</td>
    </tr>
    <tr>
      <th>fscore</th>
      <td>163913.0</td>
      <td>4.933819</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>5.0</td>
      <td>6.0</td>
      <td>8.0</td>
      <td>1.290275</td>
    </tr>
    <tr>
      <th>debtiss</th>
      <td>163913.0</td>
      <td>0.362827</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.480817</td>
    </tr>
    <tr>
      <th>repurch</th>
      <td>163913.0</td>
      <td>0.650784</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.476724</td>
    </tr>
    <tr>
      <th>nissa</th>
      <td>163913.0</td>
      <td>0.701982</td>
      <td>0.329881</td>
      <td>0.683511</td>
      <td>0.694598</td>
      <td>0.702139</td>
      <td>4.265005</td>
      <td>0.062679</td>
    </tr>
    <tr>
      <th>growth</th>
      <td>163913.0</td>
      <td>0.108029</td>
      <td>-2.535166</td>
      <td>0.008043</td>
      <td>0.069293</td>
      <td>0.156135</td>
      <td>4.030048</td>
      <td>0.220803</td>
    </tr>
    <tr>
      <th>aturnover</th>
      <td>163913.0</td>
      <td>-0.525027</td>
      <td>-9.784996</td>
      <td>-0.983022</td>
      <td>-0.351011</td>
      <td>0.113567</td>
      <td>2.578508</td>
      <td>0.991602</td>
    </tr>
    <tr>
      <th>gmargins</th>
      <td>163913.0</td>
      <td>0.424387</td>
      <td>0.001052</td>
      <td>0.247732</td>
      <td>0.385029</td>
      <td>0.585019</td>
      <td>1.0</td>
      <td>0.225407</td>
    </tr>
    <tr>
      <th>ep</th>
      <td>163913.0</td>
      <td>0.040381</td>
      <td>-3.820301</td>
      <td>0.03121</td>
      <td>0.049545</td>
      <td>0.067294</td>
      <td>0.677732</td>
      <td>0.114934</td>
    </tr>
    <tr>
      <th>sgrowth</th>
      <td>163913.0</td>
      <td>0.745931</td>
      <td>0.098861</td>
      <td>0.695602</td>
      <td>0.732543</td>
      <td>0.778532</td>
      <td>8.217025</td>
      <td>0.140543</td>
    </tr>
    <tr>
      <th>lev</th>
      <td>163913.0</td>
      <td>0.075147</td>
      <td>-3.810427</td>
      <td>-0.619852</td>
      <td>-0.011205</td>
      <td>0.687159</td>
      <td>4.520271</td>
      <td>1.022683</td>
    </tr>
    <tr>
      <th>roaa</th>
      <td>163913.0</td>
      <td>0.051826</td>
      <td>-4.83761</td>
      <td>0.018625</td>
      <td>0.048987</td>
      <td>0.086154</td>
      <td>0.578345</td>
      <td>0.082937</td>
    </tr>
    <tr>
      <th>roea</th>
      <td>163913.0</td>
      <td>0.000175</td>
      <td>-0.029224</td>
      <td>0.000069</td>
      <td>0.000121</td>
      <td>0.000186</td>
      <td>0.336472</td>
      <td>0.00302</td>
    </tr>
    <tr>
      <th>sp</th>
      <td>163913.0</td>
      <td>0.001009</td>
      <td>0.0</td>
      <td>0.000346</td>
      <td>0.000632</td>
      <td>0.00114</td>
      <td>0.036622</td>
      <td>0.001362</td>
    </tr>
    <tr>
      <th>mom</th>
      <td>163913.0</td>
      <td>0.05646</td>
      <td>-3.034658</td>
      <td>-0.053369</td>
      <td>0.069856</td>
      <td>0.184213</td>
      <td>2.029381</td>
      <td>0.239901</td>
    </tr>
    <tr>
      <th>indmom</th>
      <td>163913.0</td>
      <td>24.522405</td>
      <td>1.0</td>
      <td>14.0</td>
      <td>24.0</td>
      <td>35.0</td>
      <td>49.0</td>
      <td>12.98161</td>
    </tr>
    <tr>
      <th>mom12</th>
      <td>163913.0</td>
      <td>0.100258</td>
      <td>-3.475013</td>
      <td>-0.049678</td>
      <td>0.115646</td>
      <td>0.270788</td>
      <td>3.519333</td>
      <td>0.318652</td>
    </tr>
    <tr>
      <th>momrev</th>
      <td>163913.0</td>
      <td>0.05737</td>
      <td>-3.055986</td>
      <td>-0.053707</td>
      <td>0.072849</td>
      <td>0.191116</td>
      <td>3.302411</td>
      <td>0.259801</td>
    </tr>
    <tr>
      <th>valuem</th>
      <td>163913.0</td>
      <td>-0.948673</td>
      <td>-8.818536</td>
      <td>-1.38428</td>
      <td>-0.900369</td>
      <td>-0.417606</td>
      <td>2.329125</td>
      <td>0.784227</td>
    </tr>
    <tr>
      <th>nissm</th>
      <td>163913.0</td>
      <td>0.700911</td>
      <td>0.329881</td>
      <td>0.682923</td>
      <td>0.694412</td>
      <td>0.701702</td>
      <td>2.711109</td>
      <td>0.060812</td>
    </tr>
    <tr>
      <th>strev</th>
      <td>163913.0</td>
      <td>0.014663</td>
      <td>-0.868645</td>
      <td>-0.035392</td>
      <td>0.013158</td>
      <td>0.061674</td>
      <td>2.596567</td>
      <td>0.095684</td>
    </tr>
    <tr>
      <th>ivol</th>
      <td>163913.0</td>
      <td>0.015696</td>
      <td>0.000463</td>
      <td>0.009952</td>
      <td>0.013612</td>
      <td>0.019028</td>
      <td>0.218682</td>
      <td>0.008647</td>
    </tr>
    <tr>
      <th>betaarb</th>
      <td>163913.0</td>
      <td>1.032455</td>
      <td>0.24138</td>
      <td>0.85159</td>
      <td>1.003569</td>
      <td>1.178665</td>
      <td>2.350102</td>
      <td>0.251549</td>
    </tr>
    <tr>
      <th>indrrev</th>
      <td>163913.0</td>
      <td>0.006188</td>
      <td>-0.820129</td>
      <td>-0.033465</td>
      <td>0.002659</td>
      <td>0.040915</td>
      <td>2.13488</td>
      <td>0.07749</td>
    </tr>
    <tr>
      <th>price</th>
      <td>163913.0</td>
      <td>3.664508</td>
      <td>0.57098</td>
      <td>3.258097</td>
      <td>3.679082</td>
      <td>4.06337</td>
      <td>11.631769</td>
      <td>0.685092</td>
    </tr>
    <tr>
      <th>age</th>
      <td>163913.0</td>
      <td>5.512095</td>
      <td>3.637586</td>
      <td>5.003946</td>
      <td>5.575949</td>
      <td>6.165418</td>
      <td>6.555357</td>
      <td>0.72663</td>
    </tr>
    <tr>
      <th>shvol</th>
      <td>163913.0</td>
      <td>1.057609</td>
      <td>0.003904</td>
      <td>0.748381</td>
      <td>0.999129</td>
      <td>1.312665</td>
      <td>4.319359</td>
      <td>0.435991</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="what-are-these-characteristics">
<h4><span class="section-number">10.2.2.2. </span>What are these characteristics?<a class="headerlink" href="#what-are-these-characteristics" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>They are based on various accounting and market based information</p></li>
<li><p>Each characteristic is constructed differently–we will discuss in detail a handful of them</p></li>
<li><p>The construction of each signal is full of painful details and there are many details that matter</p></li>
<li><p>Observation:</p>
<ul>
<li><p>size is log market cap</p></li>
<li><p>Value is Book-to-market (Why is this called value?)</p></li>
</ul>
</li>
</ul>
</section>
<section id="group-assets-by-signal">
<h4><span class="section-number">10.2.2.3. </span>Group assets by signal<a class="headerlink" href="#group-assets-by-signal" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>We select our characteristic</p></li>
<li><p>We now need to assign groups to each stocks. These groups will identify which portfolio each stock belongs in a particular date according to the position of the characteristic in that date</p></li>
<li><p>We will do this by applying the function <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.qcut.html">pd.qcut</a>  to the chosen characteristic. This will “cut” the signal distribution in the chosen number of groups.</p></li>
<li><p>The important aspects is that we will applying this date by date. This make the strategy cross-sectional because you are using the distribution of the signal as given date to the grouping– Very much like curved grades by cohort</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>Details</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">duplicates='drop'</span></code>: In case there are two stocks with exactly the same signal that are exactly in the cutoff of the groups, we drop one of the observations</p></li>
<li><p><code class="docutils literal notranslate"> <span class="pre">labels=False</span></code>: The method simply label the groups with numbers. For example if <code class="docutils literal notranslate"><span class="pre">ngroups=10</span></code> then it will assign <code class="docutils literal notranslate"><span class="pre">0</span></code> to the stocks with the  bottom 10% returns in a given date, <code class="docutils literal notranslate"><span class="pre">1</span></code> to stocks with returns in between 10% and 20% of the signal distribution on a given date, …, and 9 for stocks in the top 10% (signal in between 90% and 100% of the return distribution on a given date) .</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">=</span><span class="s1">&#39;value&#39;</span>
<span class="n">ngroups</span><span class="o">=</span><span class="mi">10</span>
<span class="n">df_X</span><span class="p">[</span><span class="s1">&#39;X_group&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_X</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">X</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ngroups</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">duplicates</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">))</span>
<span class="n">df_X</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="s1">&#39;X_group&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>permno</th>
      <th>value</th>
      <th>X_group</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2002-01-31</td>
      <td>10078</td>
      <td>-2.471709</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2002-01-31</td>
      <td>10104</td>
      <td>-3.183480</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2002-01-31</td>
      <td>10107</td>
      <td>-1.696643</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2002-01-31</td>
      <td>10108</td>
      <td>-1.461118</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2002-01-31</td>
      <td>10119</td>
      <td>-0.521094</td>
      <td>7</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>163908</th>
      <td>2016-12-31</td>
      <td>93420</td>
      <td>1.049163</td>
      <td>9</td>
    </tr>
    <tr>
      <th>163909</th>
      <td>2016-12-31</td>
      <td>93422</td>
      <td>0.829353</td>
      <td>9</td>
    </tr>
    <tr>
      <th>163910</th>
      <td>2016-12-31</td>
      <td>93423</td>
      <td>-2.128977</td>
      <td>1</td>
    </tr>
    <tr>
      <th>163911</th>
      <td>2016-12-31</td>
      <td>93429</td>
      <td>-3.001095</td>
      <td>0</td>
    </tr>
    <tr>
      <th>163912</th>
      <td>2016-12-31</td>
      <td>93436</td>
      <td>-3.328269</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>163913 rows × 4 columns</p>
</div></div></div>
</div>
<blockquote>
<div><p><strong>Portfolio formation tradeoffs: Diversification vs Signal Strengh</strong></p>
<ul class="simple">
<li><p>We will start by constructing Equal weighted portfolios within each signal bucket</p></li>
<li><p>Why not sort in 100 groups instead on only 10? This way your top portfolio would have much higher average characteristics</p></li>
<li><p>Why no simply focus on the stock with the highest characteristic?</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><ol class="arabic simple">
<li><p>Individual stocks have <span class="math notranslate nohighlight">\(\sigma\)</span> = 40 − 80%, so <span class="math notranslate nohighlight">\(\sigma/\sqrt{T}\)</span> makes it nearly impossible to accurately measure E(R). Portfolios have lower <span class="math notranslate nohighlight">\(\sigma\)</span> by diversification.</p></li>
<li><p>So  you have to trade-off strengh of the signal against benefits of diversification</p></li>
</ol>
</div></blockquote>
<p><strong>Calculate the portfolio return</strong></p>
<p>We will do market cap weights, but you could do Equal weight or even sginal weights</p>
<div class="math notranslate nohighlight">
\[\sum_i^I w_{it} r_{it}\]</div>
<p>Where the weights must add up to 1.</p>
<p>Before forming portfolios we will use the risk-free rate so we form fully invested portfolios. So the ouput will be returns and not excess returns</p>
<p><strong>Equal weighted returns</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret_byX_ew</span> <span class="o">=</span><span class="n">df_X</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;X_group&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">re</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">ret_byX_ew</span><span class="o">=</span><span class="n">ret_byX_ew</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="n">ret_byX_ew</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;date&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/b5f0cd54a261b862a08c2958b9360c839072958f2b0bf54f019d90772e9fe41e.png" src="../../_images/b5f0cd54a261b862a08c2958b9360c839072958f2b0bf54f019d90772e9fe41e.png" />
</div>
</div>
<p><strong>Market cap weighted returns</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df_X</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span> 
<span class="nb">print</span><span class="p">(</span><span class="n">df_X</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0         17.748484
1         18.481351
2         19.789216
3         15.902263
4         14.275648
            ...    
163908    14.337515
163909    15.256946
163910    15.502888
163911    15.504722
163912    17.262975
Name: size, Length: 163913, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_X</span><span class="p">[</span><span class="s1">&#39;me_l1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">df_X</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
<span class="n">ret_byX_vw</span> <span class="o">=</span><span class="n">df_X</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;X_group&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="o">.</span><span class="n">re</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">me_l1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">x</span><span class="o">.</span><span class="n">me_l1</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="n">ret_byX_vw</span><span class="o">=</span><span class="n">ret_byX_vw</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="n">ret_byX_vw</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\alan.moreira\AppData\Local\Temp\ipykernel_24324\2208835029.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  ret_byX_vw =df_X.groupby([&#39;date&#39;,&#39;X_group&#39;]).apply(lambda x:(x.re*x.me_l1).sum()/x.me_l1.sum())
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;date&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/5fc262617f6037edb3469c3c80432b7abf4c1b761dbe35b16b5b00a4f47307ef.png" src="../../_images/5fc262617f6037edb3469c3c80432b7abf4c1b761dbe35b16b5b00a4f47307ef.png" />
</div>
</div>
<p>If we focus on a particular stock, we can see how it’s portfolio membership changed over time.</p>
<p>You can check you that some characteristics are fairly persistent and change only slowly over time</p>
<p>While others, like momentum change very frequently.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_temp</span><span class="o">=</span><span class="n">df_X</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
<span class="n">top</span><span class="o">=</span><span class="n">_temp</span><span class="p">[</span><span class="n">_temp</span><span class="o">.</span><span class="n">date</span><span class="o">==</span><span class="s1">&#39;2002-01-31&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">permno</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">top</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[77418, 21936, 70519, 11850, 10107]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">firm</span> <span class="ow">in</span> <span class="n">top</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">df_X</span><span class="p">[</span><span class="n">df_X</span><span class="o">.</span><span class="n">permno</span><span class="o">==</span><span class="n">firm</span><span class="p">][[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;X_group&#39;</span><span class="p">]]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;X_group&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">firm</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Portfolio Membership (X_group)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Portfolio Membership Over Time for Top  Firms&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/32caef11011905c5c7848c91c4feaad888ff2544d071b1f08c6341c5358163e1.png" src="../../_images/32caef11011905c5c7848c91c4feaad888ff2544d071b1f08c6341c5358163e1.png" />
</div>
</div>
<blockquote>
<div><p>Things to try</p>
<ul class="simple">
<li><p>Play with different number of groups, how the spread in X across portfolios change? How the volatility of the individual portfolios change?</p></li>
<li><p>Look at different characteristics. Which ones create higher spread in average returns</p></li>
<li><p>Construct the long-short portfolio that goes long the high portfolio and short the low portfolio. What are the properties of this portfolio?</p></li>
<li><p>Which ones have alpha relative to the market in the sample? What do their betas look like</p></li>
<li><p>When they perform poorly?</p></li>
<li><p>How correlated are the returns of the long-shorts of different characteristics?</p></li>
</ul>
</div></blockquote>
<hr class="docutils" />
<p><strong>📝 Key Takeaways</strong></p>
<ul class="simple">
<li><p><strong>Stacked data frames are the backbone</strong> when working with thousands of stocks and multiple characteristics.</p></li>
<li><p><strong>Lagged market-cap weights should be the default</strong>: they minimize turnover, reflect realistic trading capacity, and eliminate look-ahead bias.</p></li>
<li><p><strong>Characteristic-sorted portfolios isolate cross-sectional spreads</strong> in the signal; the long-short “top minus bottom” position delivers a clean test of the signal’s pricing power.</p></li>
<li><p><strong>Portfolio design choices matter</strong>: more groups widen the average-return spread but shrink the number of stocks per bucket; equal-weighting boosts the influence of small caps, while value-weighting is closer to how real money is run.</p></li>
<li><p><strong>A single, well-structured function automates experimentation</strong> across different signals, making it easy to investigate which characteristics generate higher alpha, when they underperform, and how their long-short returns co-move.</p></li>
<li><p><strong>The core tension is signal strength versus diversification</strong>: stronger signals often come with higher concentration and trading costs, so practical implementation always balances these forces.</p></li>
</ul>
</section>
</section>
</section>
<hr class="docutils" />
<div class="toctree-wrapper compound">
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./chapters/Finance"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Volatilitytiming.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">9.2. </span>Volatility Timing</p>
      </div>
    </a>
    <a class="right-next"
       href="Momentum.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">10.3. </span>Signal Construction</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-market-cap-weighted-strategy">10.1. The Market-Cap Weighted strategy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stacked-datasets">10.1.1. Stacked Datasets</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#characteristic-based-strategies">10.2. Characteristic-Based Strategies</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-value-investing">10.2.1. Example: Value investing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-the-recipe">10.2.2. Implementing the recipe</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#our-characteristic-data">10.2.2.1. Our Characteristic  data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#what-are-these-characteristics">10.2.2.2. What are these characteristics?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#group-assets-by-signal">10.2.2.3. Group assets by signal</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alan Moreira
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021 Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0).
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>