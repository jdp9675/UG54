
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Trading Strategies &#8212; Quantitative Investing</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/book.css?v=c2893119" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/Finance/TradingStrategies';</script>
    <link rel="canonical" href="https://amoreira2.github.io/Fin418/chapters/Finance/TradingStrategies.html" />
    <link rel="icon" href="../../_static/figuremain2.jpg"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/figuremain2.jpg" class="logo__image only-light" alt="Quantitative Investing - Home"/>
    <script>document.write(`<img src="../../_static/figuremain2.jpg" class="logo__image only-dark" alt="Quantitative Investing - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01/what-is-quant-investing.html">1. What is Quantitative Investing?</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01/statistical-techniques.html">1.1. Statistical Techniques</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/computational-tools.html">1.2. Computational tools</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../02/getting_started.html">2. Getting Started</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02/local_install.html">2.3. Local installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/cloud_setup.html">2.4. Cloud Setup</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../essentials/intro.html">3. Python Essentials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../essentials/basics.html">3.1. Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/collections.html">3.2. Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/numpy.html">3.3. Numpy</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../essentials/introtopandas.html">3.4. Pandas</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/the_index.html">3.4.3. Indexing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/timeseries.html">3.4.4. Time-Series</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/reshape.html">3.4.5. Reshape</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/merge.html">3.4.6. Merge</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/groupby.html">3.4.7. Group-by</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/matplotlib.html">3.4.8. Plotting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/data_clean.html">3.4.9. Cleaning data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/storage_formats.html">3.4.10. Data Storage</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/control_flow.html">3.5. Flow control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/functions.html">3.6. Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/plotting.html">3.7. Plotting</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="Returns_working.html">4. Asset Returns</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="UsingAPI.html">4.5. Data APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="TheChoiceofFrequency.html">4.6. The Choice of Frequency and Annualization of Returns</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scientific/randomness1.html">4.7. Modeling randomness</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="FactorModels.html">5. Factor Models</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="PortfolioMath.html">6. Portfolios</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="LeverageandShorting.html">6.8. Leverage and Shorting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scientific/linear_algebra1.html">6.9. Linear Algebra Review</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="FactorModelEstimation.html">7. Factor Model Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="CapitalAllocation.html">8. Capital Allocation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Performance_evaluation.html">9. Performance Evaluation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="crosssectionalequitystrategies.html">10. Cross-Sectional Equity Strategies</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="Momentum.html">10.3. Momentum factor</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="MultiFactorModels.html">11. Multi Factor Models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="Factors.html">11.9. An overview of factors</a></li>
<li class="toctree-l2"><a class="reference internal" href="InterpretingFactorModels.html">11.10. Interpreting Factor Models</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="MachineLearning.html">12. Machine Learning in Finance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/additional.html">13. Additional Statistics Material</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Assignments/Assignments.html">14. Assignments</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment0.html">14.1. Assigment 0</a></li>




<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment1.html">14.6. Assignment 1</a></li>


</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/amoreira2/Fin418/blob/main/chapters/Finance/TradingStrategies.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/amoreira2/Fin418" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/amoreira2/Fin418/issues/new?title=Issue%20on%20page%20%2Fchapters/Finance/TradingStrategies.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/chapters/Finance/TradingStrategies.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Trading Strategies</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quantitative-trading-strategies"><strong>Quantitative trading strategies</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#our-first-quantitative-strategy"><strong>Our First Quantitative Strategy</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#garbage-in-garbage-out">Garbage in, Garbage out</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimation-uncertainty">Estimation uncertainty</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sensitivity-of-optimal-weights-to-uncertainty">Sensitivity of optimal weights to uncertainty</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#covariance-estimation-with-a-large-cross-sectional-of-assets">Covariance estimation with a large cross-sectional of assets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-to-do">What to do?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#shrinking-the-covariance-matrix">Shrinking the Covariance Matrix</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="c1">#GlobalFinMonthly</span>
<span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/amoreira2/Fin418/main/assets/data/GlobalFinMonthly.csv&quot;</span>
<span class="n">Data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">na_values</span><span class="o">=-</span><span class="mi">99</span><span class="p">)</span>
<span class="n">Data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
<span class="n">Data</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
<span class="n">Data</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="s2">&quot;MKTUS&quot;</span><span class="p">,</span><span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="s2">&quot;BondUS&quot;</span><span class="p">,</span>
                          <span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="s2">&quot;EM&quot;</span><span class="p">,</span><span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="s2">&quot;MKTxUS&quot;</span><span class="p">,</span><span class="n">Data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="s2">&quot;BondxUS&quot;</span> <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="trading-strategies">
<h1>Trading Strategies<a class="headerlink" href="#trading-strategies" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>A trading strategy is a procedure that maps any information known up to time t, into a set of trading instructions for time  <span class="math notranslate nohighlight">\(T&gt;t\)</span>.</p>
<ul>
<li><p>the mean-variance analysis we did so far was <strong>not</strong> a valid trading strategy:</p></li>
<li><p>we used data of the whole sample to estimate the weights of our strategy and evaluated the strategy in the same sample</p></li>
</ul>
</li>
<li><p>It is very important that the trading strategy only uses information that is known at the time of the trade</p></li>
<li><p>– you obviously cannot trade on info that you don’t know</p></li>
<li><p>The weights of a trading strategy must either:</p>
<ul>
<li><p>Add up to 1. So it describes what you do with your entire capital.</p></li>
<li><p>Or add up to 0. So the strategy is self-financing. For example, borrow 1 dollar at the risk-free rate and buy 1 dollar worth of the market portfolio</p></li>
<li><p>Every time you trade on the excess returns, you can think of the weights “adding up to zero”, because it is a long-short portfolio.</p></li>
<li><p>In practice all strategies demand some capital as no bank allow us to borrow without putting some capital in, but these self financed strategies are quite convenient to work with as they are all in the “Excess Return Space” since they have zero cost.</p></li>
</ul>
</li>
</ul>
<p><strong>Examples</strong></p>
<ul class="simple">
<li><p>Example of a VALID trading strategy: Every monday buy stocks that had positive news coverage during the weekend and sell stocks that had negative news coverage.</p>
<ul>
<li><p>This is valid because you are trading after the information is known.</p></li>
</ul>
</li>
<li><p>Example of INVALID trading strategy: On Friday buy all the stocks that WILL have positive news coverage during the weekend, and sell all the stocks that WILL have negative coverage during the weekend.</p>
<ul>
<li><p>This is Invalid because you are trading before the information is known.</p></li>
</ul>
</li>
<li><p>This might sound ridiculous. Obviously you cannot trade on the information that is not known at the time of the trade!</p></li>
</ul>
<p><strong>Types of trading strategies</strong></p>
<ul class="simple">
<li><p><strong>Strategic allocation</strong>: How you allocate across broad asset classes: Cash, Equities (US, Developed Markets, Emerging Markets), Government bonds (US, …), Corporate bonds(US, …), Commodities, Private equity, real assets (land,…)</p>
<ul>
<li><p>The strategy takes positions on broader asset classes. For example pension funds tend to follow a 70-30 split between equity and bonds</p></li>
<li><p>An example is of this is the mean-variance anaylsis we did last few chapters.</p></li>
<li><p>We will revisit this here but now making the analysis more tight</p></li>
<li><p>Another example is RISK-PARITY which we will discuss later</p></li>
</ul>
</li>
<li><p><strong>Timing</strong>: Easier to think in terms of one risky asset and cash. The strategy basically goes in and out of an asset according to some model that forecasts time-variaiton either in returns of the risky asset realitve to cash or in it’s riskness</p>
<ul>
<li><p>You obvioulsy can time multiple things at the same time, but it is useful separation to help understand what the strategy is doing</p></li>
</ul>
</li>
<li><p><strong>Cross-sectional</strong> (within asset class): This is about how you invest within an asset class. The “defaul” option is to do a market-cap weighted portfolio which we will discuss below. The cross-sectional strategies use some information to deviate from the market portfolio in the asset class</p>
<ul>
<li><p>The are cross-sectional strategies everywhere: equities, gov bonds, corp bonds, futures, equity indexes, currencies, commodities, options, crypto currrencies</p></li>
<li><p>All these asset classes have lots of data and are naturally a good place to do quantitative investing</p></li>
<li><p>For this class we focus on equities</p></li>
</ul>
</li>
<li><p>Strategies can be discretionary: A team decides to place a trade based on their evaluation of information about a firm or the macro environment</p></li>
<li><p>Strategies can be systematic: they can be codified. Explicit rule for the portfolio based on some hard data. Systematic trading strategies are often called <strong>Quantitative</strong></p></li>
</ul>
<section id="quantitative-trading-strategies">
<h2><strong>Quantitative trading strategies</strong><a class="headerlink" href="#quantitative-trading-strategies" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>A quant trading strategy get some hard data about one or multiple assets and transform this data  into  portfolio weights</p></li>
<li><p>So given data <span class="math notranslate nohighlight">\(Z_{t}\)</span> ( potentially a very big vector), a quantitative trading strategy is a function that maps data into weights <span class="math notranslate nohighlight">\(X_{t+1}=f(Z_t)\)</span></p></li>
</ul>
</section>
<section id="our-first-quantitative-strategy">
<h2><strong>Our First Quantitative Strategy</strong><a class="headerlink" href="#our-first-quantitative-strategy" title="Link to this heading">#</a></h2>
<p>Here what we will do: do the mean-variance analysis assuming I am an investor that is doing this in real time</p>
<ul class="simple">
<li><p>so I will say the investor will start in 1973, 10 years after the beginning of the sample</p></li>
<li><p>simply use the past data to estimate the means and covariances,</p></li>
<li><p>compute the weights and invest on the assets according to this strategy for the next month.</p></li>
</ul>
<p>I will do that for the entire sample.</p>
<p>This will be valid because at no moment we use information that an investor would not have had available in real time.</p>
<p>We will target an annual volatility of 15%</p>
<p>We will start by using just the first 10 years and evaluating on the rest of the sample as a warm up (because it is simpler)</p>
<p>Warm up</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct excess returns from our data</span>

<span class="n">Re</span><span class="o">=</span><span class="p">(</span><span class="n">Data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="n">Re</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
DatetimeIndex: 647 entries, 1963-02-28 to 2016-12-31
Data columns (total 5 columns):
 #   Column   Non-Null Count  Dtype  
---  ------   --------------  -----  
 0   MKTUS    647 non-null    float64
 1   BondUS   647 non-null    float64
 2   EM       647 non-null    float64
 3   MKTxUS   647 non-null    float64
 4   BondxUS  646 non-null    float64
dtypes: float64(5)
memory usage: 30.3 KB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># lets start by redoing our full sample analysis</span>

<span class="c1"># create a dataframe to store results</span>
<span class="n">Results</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([],</span><span class="n">index</span><span class="o">=</span><span class="p">[])</span>
<span class="c1">#Estimate moments using full sample</span>

<span class="n">ERe</span><span class="o">=</span><span class="n">Re</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">CovRe</span><span class="o">=</span><span class="n">Re</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="c1"># Set desired volatility and convert to monthly units</span>
<span class="n">Targetvol</span><span class="o">=</span><span class="mf">0.15</span><span class="o">/</span><span class="p">(</span><span class="mi">12</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>


<span class="c1"># construct weights and normalize them so the have desired volatility</span>
<span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">CovRe</span><span class="p">)</span> <span class="o">@</span> <span class="n">ERe</span><span class="o">*</span> <span class="p">(</span><span class="n">Targetvol</span><span class="o">/</span><span class="p">(</span><span class="n">ERe</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">CovRe</span><span class="p">)</span> <span class="o">@</span> <span class="n">ERe</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
<span class="c1">#store results for full sample</span>
<span class="n">Results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;avgreturn&#39;</span><span class="p">,</span><span class="s1">&#39;Fullsample&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">X</span> <span class="o">@</span> <span class="n">ERe</span><span class="o">*</span><span class="mi">12</span>
<span class="n">Results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span><span class="s1">&#39;Fullsample&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">CovRe</span> <span class="o">@</span> <span class="n">X</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">Results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;shaperatio&#39;</span><span class="p">,</span><span class="s1">&#39;Fullsample&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">ERe</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">X</span> <span class="o">@</span> <span class="n">CovRe</span> <span class="o">@</span> <span class="n">X</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">Results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Fullsample</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>avgreturn</th>
      <td>0.085055</td>
    </tr>
    <tr>
      <th>volatility</th>
      <td>0.150000</td>
    </tr>
    <tr>
      <th>shaperatio</th>
      <td>0.567030</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Estimate moments up to 1973</span>
<span class="n">Endofsample</span><span class="o">=</span><span class="mi">1973</span>
<span class="n">ERe</span><span class="o">=</span><span class="n">Re</span><span class="p">[:</span><span class="nb">str</span><span class="p">(</span><span class="n">Endofsample</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">CovRe</span><span class="o">=</span><span class="n">Re</span><span class="p">[:</span><span class="nb">str</span><span class="p">(</span><span class="n">Endofsample</span><span class="p">)]</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>

<span class="c1"># construct weights and normalize them so the have desired volatility</span>
<span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">CovRe</span><span class="p">)</span> <span class="o">@</span> <span class="n">ERe</span><span class="o">*</span> <span class="p">(</span><span class="n">Targetvol</span><span class="o">/</span><span class="p">(</span><span class="n">ERe</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">CovRe</span><span class="p">)</span> <span class="o">@</span> <span class="n">ERe</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># store results for estimation period</span>
<span class="n">Results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;avgreturn&#39;</span><span class="p">,</span><span class="s1">&#39;Estimation_pre&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Endofsample</span><span class="p">)]</span><span class="o">=</span><span class="n">X</span> <span class="o">@</span> <span class="n">ERe</span><span class="o">*</span><span class="mi">12</span>
<span class="n">Results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span><span class="s1">&#39;Estimation_pre&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Endofsample</span><span class="p">)]</span><span class="o">=</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">CovRe</span> <span class="o">@</span> <span class="n">X</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">Results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;shaperatio&#39;</span><span class="p">,</span><span class="s1">&#39;Estimation_pre&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Endofsample</span><span class="p">)]</span><span class="o">=</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">ERe</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">X</span> <span class="o">@</span> <span class="n">CovRe</span> <span class="o">@</span> <span class="n">X</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># construct time series of returns for out of sample period</span>
<span class="n">Rp</span><span class="o">=</span><span class="n">Re</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">Endofsample</span><span class="o">+</span><span class="mi">1</span><span class="p">):]</span> <span class="o">@</span> <span class="n">X</span>

<span class="c1"># store results for out of sample period</span>
<span class="n">Results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;avgreturn&#39;</span><span class="p">,</span><span class="s1">&#39;test_pos&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Endofsample</span><span class="p">)]</span><span class="o">=</span><span class="n">Rp</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">12</span>
<span class="n">Results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span><span class="s1">&#39;test_pos&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Endofsample</span><span class="p">)]</span><span class="o">=</span><span class="n">Rp</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="mi">12</span><span class="o">**</span><span class="mf">0.5</span>
<span class="n">Results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;shaperatio&#39;</span><span class="p">,</span><span class="s1">&#39;test_pos&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Endofsample</span><span class="p">)]</span><span class="o">=</span><span class="n">Rp</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">12</span><span class="o">/</span><span class="p">(</span><span class="n">Rp</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="mi">12</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>


<span class="n">Results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Fullsample</th>
      <th>Estimation_pre1973</th>
      <th>test_pos1973</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>avgreturn</th>
      <td>0.085055</td>
      <td>0.102715</td>
      <td>-0.014757</td>
    </tr>
    <tr>
      <th>volatility</th>
      <td>0.150000</td>
      <td>0.150000</td>
      <td>0.284975</td>
    </tr>
    <tr>
      <th>shaperatio</th>
      <td>0.567030</td>
      <td>0.684767</td>
      <td>-0.051783</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>Look how bad this is</p></li>
<li><p>The average excess return ends up negative!</p></li>
<li><p>The volatility ends up as much twice as large</p></li>
</ul>
<p>Why so bad? What is going on?</p>
<ul class="simple">
<li><p>We stopped in 1973. MAybe 10 years is not enough.</p></li>
<li><p>maybe we should split test sample and estimation sample more evenly?</p></li>
<li><p>what happens if we split right down the middle? Are the results better? Are they good enough?</p></li>
</ul>
<p>A more sophisticated and also more realistic description of a trading strategy uses the concept of a rolling estimation sample</p>
<p>Basically you start in some date 1973, build you portfolio and hold it for a month, and each month that passes you re-estimate your weights and again hold the new portfolio for another month</p>
<p>So you are always using data up to month t and holding the position in date t+1.</p>
</section>
<section id="garbage-in-garbage-out">
<h2>Garbage in, Garbage out<a class="headerlink" href="#garbage-in-garbage-out" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>we are plugging estimators for expected returns and the covariance matrix wihthout any evaluation if our procedure actually implements good estimators</p></li>
<li><p>If our estimators are garbage, MV analysis will produce garbage</p></li>
<li><p>Mean-variance optimization is EXTREMELY sensitive to the inputs</p>
<ol class="arabic simple">
<li><p>Expected returns</p></li>
<li><p>Covariance matrix: cross assets correlations and asset volatilities</p></li>
</ol>
</li>
<li><p>Importantly our estimators are extremely noisy–returns are very volatile</p></li>
<li><p>assuming the underlying distribution is constant (big if), we need very long data set to reduce the uncertainty of our estimates for expected returns, and also to a lesser extent correlations and vols</p></li>
</ul>
<section id="estimation-uncertainty">
<h3>Estimation uncertainty<a class="headerlink" href="#estimation-uncertainty" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>estimate the uncertainty regarding our average expected excess return estimates for each asset</p></li>
<li><p>show how the weights change as we change these estimates in a way that is consistent with the amount of uncertainty, i.e. those are alternative numbers that we could have estimated by change</p></li>
<li><p>show how sensitive the benefits of international diversification are</p></li>
</ul>
<p><strong>Standard errors of average estimators</strong></p>
<ul class="simple">
<li><p>If observations are serially uncorrelated over time then the standard deviation of a sample average is simply</p></li>
</ul>
<div class="math notranslate nohighlight">
\[std\left(\sum_t^T\frac{R_t}{N}\right)=\frac{std(x_t)}{\sqrt{T}}\]</div>
<ul class="simple">
<li><p>This measures how uncertain we are about the sample mean</p></li>
<li><p>For example, there is a 5% probability that the actual mean is <span class="math notranslate nohighlight">\(E[x_i]\leq\overline{R_t}-1.64{std(\overline{R_t})}\)</span></p></li>
<li><p>So <span class="math notranslate nohighlight">\(std(\overline{R_t})\)</span> gives a measure of how close our estimate is likely to be to true expected value</p></li>
<li><p>Lets compare the sample average and the sample average standard deviation for our assets</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># First we get the total number of observations and store it as `T`</span>
<span class="n">T</span><span class="o">=</span><span class="n">Re</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># (1) standard deviation of the sample average of excess return for each asset</span>
<span class="n">avg_std</span><span class="o">=</span><span class="p">(</span><span class="n">Re</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">T</span><span class="o">**</span><span class="mf">0.5</span><span class="p">))</span><span class="o">*</span><span class="mi">12</span>

<span class="c1"># (2) sample average of excess return for each asset</span>
<span class="n">avg</span><span class="o">=</span><span class="n">Re</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">12</span>


<span class="c1"># report annualized and in percent</span>
<span class="n">avg</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">yerr</span><span class="o">=</span><span class="n">avg_std</span><span class="o">*</span><span class="mf">1.64</span><span class="p">,</span>  <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/995d85b7715903d843d1fb63e63226dc0e3fde30aa6b9a3df6eed9175b79a46b.png" src="../../_images/995d85b7715903d843d1fb63e63226dc0e3fde30aa6b9a3df6eed9175b79a46b.png" />
</div>
</div>
<ul class="simple">
<li><p>What happens if the sample was only 10 years?</p></li>
<li><p>What happens if the assets is twice more volatile?</p></li>
<li><p>What happens if you want to be be 99% sure to be right (instead of 68%)</p></li>
</ul>
</section>
</section>
<section id="sensitivity-of-optimal-weights-to-uncertainty">
<h2>Sensitivity of optimal weights to uncertainty<a class="headerlink" href="#sensitivity-of-optimal-weights-to-uncertainty" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Lets revisit the classical financial advice that investors should have 60 in equities and 40 in bonds</p></li>
<li><p>We will assume that the truth is 2 standard deviations below the mean for the US market</p></li>
<li><p>We will them compare the expected return we expected to get, vs what we actually get</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">assets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MKTUS&#39;</span><span class="p">,</span><span class="s1">&#39;BondUS&#39;</span><span class="p">]</span>

<span class="n">Weights_perturb</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([],</span><span class="n">index</span><span class="o">=</span><span class="n">assets</span><span class="p">)</span>
<span class="n">ERe</span><span class="o">=</span><span class="n">Re</span><span class="p">[</span><span class="n">assets</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">CovRe</span><span class="o">=</span><span class="n">Re</span><span class="p">[</span><span class="n">assets</span><span class="p">]</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="n">T</span><span class="o">=</span><span class="n">Re</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">asset</span><span class="o">=</span><span class="s1">&#39;MKTUS&#39;</span>
<span class="n">pertubation</span><span class="o">=</span><span class="mi">2</span>
<span class="n">mu</span><span class="o">=</span><span class="n">Re</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">mu_std</span><span class="o">=</span><span class="n">Re</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="n">T</span><span class="o">**</span><span class="mf">0.5</span>
<span class="c1"># I am creating a copy of the average return vector so I can pertubate it below </span>
<span class="n">ER_perturb</span><span class="o">=</span><span class="n">ERe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># so this will be the pertubated mean for asset MKTUS, which will represent the actual truth</span>
<span class="n">ER_perturb</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span><span class="o">=</span><span class="n">mu</span><span class="o">-</span><span class="n">pertubation</span><span class="o">*</span><span class="n">mu_std</span>

<span class="c1"># mve for sample mean</span>
<span class="n">Weights_perturb</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;estimate&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">CovRe</span><span class="p">)</span> <span class="o">@</span> <span class="n">ERe</span>
<span class="c1"># mve for perturbed mean</span>
<span class="n">Weights_perturb</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;truth&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">CovRe</span><span class="p">)</span> <span class="o">@</span> <span class="n">ER_perturb</span>
</pre></div>
</div>
</div>
</div>
<p>We can then normalize the weights to achieve some desired volatility or that they add up to 1</p>
<p>Here I will simply make them add up to 1</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#normalizing weights so they add up to 1</span>
<span class="n">Weights_perturb</span><span class="o">=</span><span class="n">Weights_perturb</span><span class="o">/</span><span class="n">Weights_perturb</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">Weights_perturb</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>estimate</th>
      <th>truth</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>MKTUS</th>
      <td>0.581072</td>
      <td>0.272283</td>
    </tr>
    <tr>
      <th>BondUS</th>
      <td>0.418928</td>
      <td>0.727717</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">estimate</span></code> weights tell us the optimal weights given the data we saw</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">truth</span></code> tell us the optimal weights given the true moments</p></li>
</ul>
<p>We can now comapre the expected return that we expected to get (given the data) and the one we actually get (given the truth)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the expression first</span>
<span class="n">expected_data</span> <span class="o">=</span> <span class="n">Weights_perturb</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;estimate&#39;</span><span class="p">]</span> <span class="o">@</span> <span class="n">ERe</span> <span class="o">*</span> <span class="mi">12</span>
<span class="c1"># Then use the result in the f-string</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected to get given data: </span><span class="si">{</span><span class="n">expected_data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># Calculate the expression first</span>
<span class="n">actual_data</span> <span class="o">=</span> <span class="n">Weights_perturb</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;estimate&#39;</span><span class="p">]</span> <span class="o">@</span> <span class="n">ER_perturb</span> <span class="o">*</span> <span class="mi">12</span>

<span class="c1"># Then use the result in the f-string</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Will actually get given the truth:</span><span class="si">{</span><span class="n">actual_data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expected to get given data: 0.04852462499115857
Will actually get given the truth:0.02432653824907584
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>What perturbation are we are exposed to?  that they true mean is higher or lower than expected?</p></li>
<li><p>How does it depend on the weights?</p></li>
<li><p>Why perturbing one assets leads to changes in the other assets? What this cross-sensitivity depends on?</p></li>
<li><p>What do you think will happen if we do this with individual stocks instead? Why?</p></li>
<li><p>what do you think would happen by adding crypto to this problem, say bitcoin?</p></li>
<li><p>similar problems happen in estimating the correlations specially as the number of assets grow large</p></li>
</ul>
</section>
<section id="covariance-estimation-with-a-large-cross-sectional-of-assets">
<h2>Covariance estimation with a large cross-sectional of assets<a class="headerlink" href="#covariance-estimation-with-a-large-cross-sectional-of-assets" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Lets import the universe of US equities</p></li>
<li><p>The sample is 15 years.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">wrds</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psycopg2</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">dateutil.relativedelta</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandas.tseries.offsets</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="c1">###################</span>
<span class="c1"># Connect to WRDS. #</span>
<span class="c1"># You will be required to put your name and password if you have it</span>
<span class="c1">###################</span>
<span class="n">conn</span><span class="o">=</span><span class="n">wrds</span><span class="o">.</span><span class="n">Connection</span><span class="p">()</span> 

<span class="c1">###################</span>
<span class="c1"># This below dowloads from the server the data that we want #</span>
<span class="c1">###################</span>
<span class="n">crsp_m</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                      select a.permno, a.date, b.shrcd, b.exchcd,</span>
<span class="s2">                      a.ret, a.shrout, a.prc,a.retx</span>
<span class="s2">                      from crsp.msf as a</span>
<span class="s2">                      left join crsp.msenames as b</span>
<span class="s2">                      on a.permno=b.permno</span>
<span class="s2">                      and b.namedt&lt;=a.date</span>
<span class="s2">                      and a.date&lt;=b.nameendt</span>
<span class="s2">                      where a.date between &#39;01/01/2005&#39; and &#39;12/31/2020&#39;</span>
<span class="s2">                      and b.exchcd between 1 and 3</span>
<span class="s2">                      and b.shrcd between 10 and 11</span>
<span class="s2">                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">date_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span> 

<span class="c1"># this saves it</span>
<span class="c1">#crsp_m.to_pickle(&#39;../../assets/data/crspm2005_2020.pkl&#39;)</span>
<span class="c1"># variables downloaded</span>

<span class="c1"># 1. Permno-- are unique indentifier to a security </span>
<span class="c1"># (for exmaple a stock that has multiple types of stocks will have multiple permnos)</span>

<span class="c1"># 2. shrco is the type of share: common share, ADR, ETF, ....</span>
<span class="c1"># we will focus on common shares</span>

<span class="c1"># 3. exchcd is the code of the exchange where the stock was originally listed</span>
<span class="c1"># we will focus on stock listed in the 3 major stock exchanges ( basically the whole market)</span>

<span class="c1"># 4. ret,retx, shrout,  prc, are the stock return, the stock return excluding dividends, number of shares outstanding, and price</span>

<span class="c1"># 5. date is the trading date of the return</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WRDS recommends setting up a .pgpass file.
Created .pgpass file successfully.
You can create this file yourself at any time with the create_pgpass_file() function.
Loading library list...
Done
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p><em>If you don’t want to deal with that you can simply get the data by running the code below</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp_m</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;https://github.com/amoreira2/Fin418/blob/main/assets/data/crspm2005_2020.pkl?raw=true&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pandas.tseries.offsets</span><span class="w"> </span><span class="kn">import</span> <span class="n">MonthEnd</span>
<span class="c1"># keep the variables we need</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">crsp_m</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># change variable format to int</span>
<span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="c1"># Line up date to be end of month </span>
<span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 763626 entries, 0 to 763625
Data columns (total 3 columns):
 #   Column  Non-Null Count   Dtype         
---  ------  --------------   -----         
 0   permno  763626 non-null  int32         
 1   date    763626 non-null  datetime64[ns]
 2   ret     759919 non-null  float64       
dtypes: datetime64[ns](1), float64(1), int32(1)
memory usage: 14.6 MB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># there are about 4 thousand stocks in the sample on average</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">759919</span><span class="o">/</span><span class="p">(</span><span class="mi">15</span><span class="o">*</span><span class="mi">12</span><span class="p">))</span>

<span class="c1"># but overall 8 thousand stocks traded in the sample</span>
<span class="n">crsp</span><span class="o">.</span><span class="n">permno</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># why is that?</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4221.772222222222
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8386
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>How many parameters do we need to estimate for a covariance matrix across these 8 thousand stocks?</p></li>
<li><p>Do we even have enough observations for that?</p></li>
<li><p>What will happen with our covariance matrix?</p></li>
</ul>
<p>Lets just try and see what happens</p>
<p>We will do brute force</p>
<ol class="arabic simple">
<li><p>Set permno and date as indexes</p></li>
<li><p>unstack so we have the different firms in the columns and the dates in the rows</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;permno&#39;</span><span class="p">)</span>
<span class="n">crsp</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="21" halign="left">ret</th>
    </tr>
    <tr>
      <th>permno</th>
      <th>10001</th>
      <th>10002</th>
      <th>10012</th>
      <th>10025</th>
      <th>10026</th>
      <th>10028</th>
      <th>10032</th>
      <th>10042</th>
      <th>10044</th>
      <th>10051</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-01-31</th>
      <td>-0.040580</td>
      <td>-0.132466</td>
      <td>-0.320388</td>
      <td>0.277966</td>
      <td>-0.015909</td>
      <td>-0.063830</td>
      <td>-0.114527</td>
      <td>-0.195312</td>
      <td>0.130375</td>
      <td>-0.111111</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2005-02-28</th>
      <td>-0.045166</td>
      <td>-0.033255</td>
      <td>-0.285714</td>
      <td>0.082228</td>
      <td>-0.021554</td>
      <td>-0.034091</td>
      <td>-0.079861</td>
      <td>-0.213592</td>
      <td>0.297917</td>
      <td>-0.155556</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2005-03-31</th>
      <td>0.124822</td>
      <td>-0.013081</td>
      <td>-0.080000</td>
      <td>-0.031863</td>
      <td>-0.005401</td>
      <td>0.019608</td>
      <td>0.085849</td>
      <td>-0.111111</td>
      <td>0.209575</td>
      <td>-0.021382</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2005-04-30</th>
      <td>-0.074684</td>
      <td>-0.066700</td>
      <td>-0.195652</td>
      <td>-0.058734</td>
      <td>0.045270</td>
      <td>-0.094231</td>
      <td>0.052129</td>
      <td>-0.069444</td>
      <td>-0.197000</td>
      <td>-0.018487</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2005-05-31</th>
      <td>0.219030</td>
      <td>0.046586</td>
      <td>-0.243243</td>
      <td>-0.073158</td>
      <td>0.008376</td>
      <td>0.027601</td>
      <td>0.137077</td>
      <td>0.104478</td>
      <td>0.189298</td>
      <td>-0.126712</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2020-08-31</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.104118</td>
      <td>-0.082742</td>
      <td>0.023960</td>
      <td>NaN</td>
      <td>-0.018072</td>
      <td>0.131730</td>
      <td>...</td>
      <td>0.249569</td>
      <td>-0.021218</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.008584</td>
      <td>NaN</td>
      <td>0.741452</td>
    </tr>
    <tr>
      <th>2020-09-30</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.036668</td>
      <td>0.105670</td>
      <td>-0.071513</td>
      <td>NaN</td>
      <td>-0.177914</td>
      <td>-0.199393</td>
      <td>...</td>
      <td>-0.065808</td>
      <td>0.016459</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.055319</td>
      <td>NaN</td>
      <td>-0.139087</td>
    </tr>
    <tr>
      <th>2020-10-31</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.039727</td>
      <td>-0.058275</td>
      <td>-0.015432</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>0.104298</td>
      <td>...</td>
      <td>0.065025</td>
      <td>-0.056477</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.080645</td>
      <td>NaN</td>
      <td>-0.095499</td>
    </tr>
    <tr>
      <th>2020-11-30</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.072435</td>
      <td>0.143564</td>
      <td>0.074346</td>
      <td>NaN</td>
      <td>0.593284</td>
      <td>0.298798</td>
      <td>...</td>
      <td>0.421369</td>
      <td>0.224362</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.144737</td>
      <td>NaN</td>
      <td>0.462736</td>
    </tr>
    <tr>
      <th>2020-12-31</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.072598</td>
      <td>0.125541</td>
      <td>0.046848</td>
      <td>NaN</td>
      <td>-0.051522</td>
      <td>-0.030851</td>
      <td>...</td>
      <td>0.109665</td>
      <td>0.076239</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.122605</td>
      <td>NaN</td>
      <td>0.243252</td>
    </tr>
  </tbody>
</table>
<p>192 rows × 8386 columns</p>
</div></div></div>
</div>
<p>What do we do with the many nans?</p>
<p>Do we drop all dates that don’t have complete rows?</p>
<p>How many months are we going to be left with?</p>
<p>Lets just do it</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="n">cov</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="21" halign="left">ret</th>
    </tr>
    <tr>
      <th></th>
      <th>permno</th>
      <th>10001</th>
      <th>10002</th>
      <th>10012</th>
      <th>10025</th>
      <th>10026</th>
      <th>10028</th>
      <th>10032</th>
      <th>10042</th>
      <th>10044</th>
      <th>10051</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th></th>
      <th>permno</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="11" valign="top">ret</th>
      <th>10001</th>
      <td>0.007798</td>
      <td>-0.000774</td>
      <td>0.002537</td>
      <td>0.000522</td>
      <td>0.000039</td>
      <td>0.002555</td>
      <td>0.000775</td>
      <td>-0.001050</td>
      <td>0.000194</td>
      <td>0.000912</td>
      <td>...</td>
      <td>-0.000404</td>
      <td>-0.000114</td>
      <td>-0.001576</td>
      <td>-0.000129</td>
      <td>0.000675</td>
      <td>-0.005004</td>
      <td>-0.001406</td>
      <td>-0.000266</td>
      <td>0.000278</td>
      <td>-0.001426</td>
    </tr>
    <tr>
      <th>10002</th>
      <td>-0.000774</td>
      <td>0.024677</td>
      <td>0.002167</td>
      <td>0.001650</td>
      <td>0.002524</td>
      <td>0.003879</td>
      <td>-0.000004</td>
      <td>-0.000807</td>
      <td>0.000077</td>
      <td>0.000552</td>
      <td>...</td>
      <td>-0.004404</td>
      <td>-0.002795</td>
      <td>-0.010441</td>
      <td>-0.001337</td>
      <td>-0.017943</td>
      <td>0.002269</td>
      <td>-0.007665</td>
      <td>0.001515</td>
      <td>-0.009037</td>
      <td>-0.005984</td>
    </tr>
    <tr>
      <th>10012</th>
      <td>0.002537</td>
      <td>0.002167</td>
      <td>0.006135</td>
      <td>-0.006106</td>
      <td>0.000942</td>
      <td>0.000476</td>
      <td>0.004454</td>
      <td>0.001930</td>
      <td>-0.002265</td>
      <td>0.006284</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>10025</th>
      <td>0.000522</td>
      <td>0.001650</td>
      <td>-0.006106</td>
      <td>0.016193</td>
      <td>0.001591</td>
      <td>0.001028</td>
      <td>0.003443</td>
      <td>0.000223</td>
      <td>0.002208</td>
      <td>0.001293</td>
      <td>...</td>
      <td>0.001431</td>
      <td>0.001461</td>
      <td>0.002456</td>
      <td>0.001263</td>
      <td>0.010778</td>
      <td>-0.003024</td>
      <td>-0.014701</td>
      <td>0.000819</td>
      <td>0.005475</td>
      <td>-0.002047</td>
    </tr>
    <tr>
      <th>10026</th>
      <td>0.000039</td>
      <td>0.002524</td>
      <td>0.000942</td>
      <td>0.001591</td>
      <td>0.003983</td>
      <td>0.000821</td>
      <td>0.002423</td>
      <td>-0.000481</td>
      <td>0.001266</td>
      <td>0.002258</td>
      <td>...</td>
      <td>0.003223</td>
      <td>0.001250</td>
      <td>0.001479</td>
      <td>0.000853</td>
      <td>0.007287</td>
      <td>-0.004135</td>
      <td>-0.004120</td>
      <td>0.000071</td>
      <td>0.001340</td>
      <td>0.001451</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>93432</th>
      <td>-0.005004</td>
      <td>0.002269</td>
      <td>NaN</td>
      <td>-0.003024</td>
      <td>-0.004135</td>
      <td>-0.009098</td>
      <td>-0.007766</td>
      <td>NaN</td>
      <td>0.001334</td>
      <td>0.001569</td>
      <td>...</td>
      <td>-0.006456</td>
      <td>-0.001053</td>
      <td>-0.001264</td>
      <td>-0.000187</td>
      <td>-0.003197</td>
      <td>0.022076</td>
      <td>-0.009247</td>
      <td>0.006736</td>
      <td>-0.000768</td>
      <td>-0.009019</td>
    </tr>
    <tr>
      <th>93433</th>
      <td>-0.001406</td>
      <td>-0.007665</td>
      <td>NaN</td>
      <td>-0.014701</td>
      <td>-0.004120</td>
      <td>-0.002850</td>
      <td>0.006160</td>
      <td>NaN</td>
      <td>-0.012879</td>
      <td>-0.001388</td>
      <td>...</td>
      <td>-0.003570</td>
      <td>-0.013165</td>
      <td>0.001492</td>
      <td>-0.000840</td>
      <td>0.018457</td>
      <td>-0.009247</td>
      <td>1.276334</td>
      <td>0.001169</td>
      <td>0.024445</td>
      <td>0.032895</td>
    </tr>
    <tr>
      <th>93434</th>
      <td>-0.000266</td>
      <td>0.001515</td>
      <td>NaN</td>
      <td>0.000819</td>
      <td>0.000071</td>
      <td>0.002819</td>
      <td>-0.000537</td>
      <td>NaN</td>
      <td>0.000654</td>
      <td>-0.001071</td>
      <td>...</td>
      <td>0.000127</td>
      <td>0.000070</td>
      <td>0.000858</td>
      <td>-0.000743</td>
      <td>-0.009930</td>
      <td>0.006736</td>
      <td>0.001169</td>
      <td>0.015841</td>
      <td>0.004483</td>
      <td>0.000147</td>
    </tr>
    <tr>
      <th>93435</th>
      <td>0.000278</td>
      <td>-0.009037</td>
      <td>NaN</td>
      <td>0.005475</td>
      <td>0.001340</td>
      <td>-0.000840</td>
      <td>0.004911</td>
      <td>NaN</td>
      <td>-0.000609</td>
      <td>-0.001579</td>
      <td>...</td>
      <td>0.012086</td>
      <td>0.007676</td>
      <td>-0.004608</td>
      <td>0.007259</td>
      <td>0.019851</td>
      <td>-0.000768</td>
      <td>0.024445</td>
      <td>0.004483</td>
      <td>0.114267</td>
      <td>0.012217</td>
    </tr>
    <tr>
      <th>93436</th>
      <td>-0.001426</td>
      <td>-0.005984</td>
      <td>NaN</td>
      <td>-0.002047</td>
      <td>0.001451</td>
      <td>0.000558</td>
      <td>0.003966</td>
      <td>NaN</td>
      <td>0.002036</td>
      <td>0.004171</td>
      <td>...</td>
      <td>0.005557</td>
      <td>0.001712</td>
      <td>0.014019</td>
      <td>0.001869</td>
      <td>0.014379</td>
      <td>-0.009019</td>
      <td>0.032895</td>
      <td>0.000147</td>
      <td>0.012217</td>
      <td>0.034449</td>
    </tr>
  </tbody>
</table>
<p>8386 rows × 8386 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>So we got something. How do you think pandas solved the issue.</p></li>
<li><p>Did it really solve?</p></li>
<li><p>How many parameters were estimated?</p></li>
<li><p>How many observations do we have?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">((</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<span class="p">((</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">759919</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>35166691.0
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>46.27689398475364
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We have about 800 thousand month-firms observations</p></li>
<li><p>But we need to estimate 35 million parameters!</p></li>
<li><p>That is 46 more parameters then data points!</p></li>
<li><p>Obviously these estimates are total garbage</p></li>
<li><p>Typically we want MANY more observations than parameters!</p></li>
</ul>
</section>
<section id="what-to-do">
<h2>What to do?<a class="headerlink" href="#what-to-do" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Adopt trading strategies that use data more parsimoniously, essentially shrinking lots of the estimates towards some common value</p>
<ul class="simple">
<li><p><strong>Minimum</strong> variance investing: assume all assets have the same expected return</p></li>
<li><p>Risk-parity: Assume assets have zero correlation and all assets have the same Sharpe-Ratio</p></li>
<li><p>Market-cap weights: Theory tell us that this portfolios must be pretty good (CAPM logic)</p></li>
<li><p>etc</p></li>
</ul>
</li>
<li><p>Use factor models of risk</p>
<ul class="simple">
<li><p>factor models of risk impose structure in estimating large co-variance matrixes (how many parameters do you need to estimate for the covariance matrix of 5000 stocks?)</p></li>
</ul>
</li>
<li><p>Use more robust estimators: basically you “shrink” your estimates to some reasonable value based on some simple model</p>
<ul class="simple">
<li><p>for example you can adjust the sample mean towards the one implied by the CAPM</p></li>
</ul>
</li>
<li><p>Using short data samples to produce estimates for mean-variance inputs is very dangerous. It leads to pro-cyclical portfolio. When past returns have been high, current prices are high, implying that future returns may actually be low. Thus, using a past data sample to estimate a mean produces a high estimate right when future returns are likely to be low.</p></li>
</ol>
<p>The critical insight of Mean-Variance investing is <strong>Diversification</strong></p>
<p>One wants to construct portfolios that harvest this diversification</p>
</section>
<section id="shrinking-the-covariance-matrix">
<h2>Shrinking the Covariance Matrix<a class="headerlink" href="#shrinking-the-covariance-matrix" title="Link to this heading">#</a></h2>
<p>One approach that is quite intuitive is to shrink all the variances to a common value and all the covariance terms to a common value.</p>
<p>The idea comes from Bayesian thinking: before you look at the data you think all the assets are the same.</p>
<p>So you tilt towards this common value depending of the strenght of your prior</p>
<p>of course you have to tilt a little bit, not too much, otherwise you are not letting the data speak</p>
<div class="math notranslate nohighlight">
\[\hat{\Sigma}_s=h\Sigma_s+(1-h)\hat{\Sigma}\]</div>
<p>A empirically drive way to choose this <span class="math notranslate nohighlight">\(\Sigma_s\)</span> is to see the covariance terms to the average of the covariance terms and the variance terms to the average of the variance terms</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">average_diagonal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">average_diagonal</span><span class="p">)</span>



<span class="n">off_diagonal_terms</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices_from</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

<span class="n">average_off_diagonal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">off_diagonal_terms</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">average_off_diagonal</span><span class="p">)</span>

<span class="c1"># Create a copy of the covariance matrix</span>
<span class="n">cov_shrink</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># Set the UP off-diagonal terms to the average_off_diagonal</span>
<span class="n">cov_shrink</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices_from</span><span class="p">(</span><span class="n">cov_shrink</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">average_off_diagonal</span>

<span class="c1"># Set the LOWER off-diagonal terms to the average_off_diagonal</span>
<span class="n">cov_shrink</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">tril_indices_from</span><span class="p">(</span><span class="n">cov_shrink</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">average_off_diagonal</span>
<span class="c1"># Set the diagonal terms to the average_diagonal</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">cov_shrink</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">average_diagonal</span><span class="p">)</span>
<span class="c1"># note that now the covariance matrix is invertable</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.043679075680530866
0.0035243332461513386
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov_shrink</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="21" halign="left">ret</th>
    </tr>
    <tr>
      <th></th>
      <th>permno</th>
      <th>10001</th>
      <th>10002</th>
      <th>10012</th>
      <th>10025</th>
      <th>10026</th>
      <th>10028</th>
      <th>10032</th>
      <th>10042</th>
      <th>10044</th>
      <th>10051</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th></th>
      <th>permno</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="11" valign="top">ret</th>
      <th>10001</th>
      <td>0.043679</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>...</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
    </tr>
    <tr>
      <th>10002</th>
      <td>0.003524</td>
      <td>0.043679</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>...</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
    </tr>
    <tr>
      <th>10012</th>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.043679</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>...</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
    </tr>
    <tr>
      <th>10025</th>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.043679</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>...</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
    </tr>
    <tr>
      <th>10026</th>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.043679</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>...</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>93432</th>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>...</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.043679</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
    </tr>
    <tr>
      <th>93433</th>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>...</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.043679</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
    </tr>
    <tr>
      <th>93434</th>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>...</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.043679</td>
      <td>0.003524</td>
      <td>0.003524</td>
    </tr>
    <tr>
      <th>93435</th>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>...</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.043679</td>
      <td>0.003524</td>
    </tr>
    <tr>
      <th>93436</th>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>...</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.043679</td>
    </tr>
  </tbody>
</table>
<p>8386 rows × 8386 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate the inverse of the covariance matrix</span>
<span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_shrink</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 2.49006930e+01, -2.96564148e-03, -2.96564148e-03, ...,
        -2.96564148e-03, -2.96564148e-03, -2.96564148e-03],
       [-2.96564148e-03,  2.49006930e+01, -2.96564148e-03, ...,
        -2.96564148e-03, -2.96564148e-03, -2.96564148e-03],
       [-2.96564148e-03, -2.96564148e-03,  2.49006930e+01, ...,
        -2.96564148e-03, -2.96564148e-03, -2.96564148e-03],
       ...,
       [-2.96564148e-03, -2.96564148e-03, -2.96564148e-03, ...,
         2.49006930e+01, -2.96564148e-03, -2.96564148e-03],
       [-2.96564148e-03, -2.96564148e-03, -2.96564148e-03, ...,
        -2.96564148e-03,  2.49006930e+01, -2.96564148e-03],
       [-2.96564148e-03, -2.96564148e-03, -2.96564148e-03, ...,
        -2.96564148e-03, -2.96564148e-03,  2.49006930e+01]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate the inverse of the covariance matrix</span>
<span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[nan, nan, nan, ..., nan, nan, nan],
       [nan, nan, nan, ..., nan, nan, nan],
       [nan, nan, nan, ..., nan, nan, nan],
       ...,
       [nan, nan, nan, ..., nan, nan, nan],
       [nan, nan, nan, ..., nan, nan, nan],
       [nan, nan, nan, ..., nan, nan, nan]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># this is partly happenign because some terms are nans--these assets simply do not overlap in time</span>
<span class="n">cov</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="21" halign="left">ret</th>
    </tr>
    <tr>
      <th></th>
      <th>permno</th>
      <th>10001</th>
      <th>10002</th>
      <th>10012</th>
      <th>10025</th>
      <th>10026</th>
      <th>10028</th>
      <th>10032</th>
      <th>10042</th>
      <th>10044</th>
      <th>10051</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th></th>
      <th>permno</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="11" valign="top">ret</th>
      <th>10001</th>
      <td>0.007798</td>
      <td>-0.000774</td>
      <td>0.002537</td>
      <td>0.000522</td>
      <td>0.000039</td>
      <td>0.002555</td>
      <td>0.000775</td>
      <td>-0.001050</td>
      <td>0.000194</td>
      <td>0.000912</td>
      <td>...</td>
      <td>-0.000404</td>
      <td>-0.000114</td>
      <td>-0.001576</td>
      <td>-0.000129</td>
      <td>0.000675</td>
      <td>-0.005004</td>
      <td>-0.001406</td>
      <td>-0.000266</td>
      <td>0.000278</td>
      <td>-0.001426</td>
    </tr>
    <tr>
      <th>10002</th>
      <td>-0.000774</td>
      <td>0.024677</td>
      <td>0.002167</td>
      <td>0.001650</td>
      <td>0.002524</td>
      <td>0.003879</td>
      <td>-0.000004</td>
      <td>-0.000807</td>
      <td>0.000077</td>
      <td>0.000552</td>
      <td>...</td>
      <td>-0.004404</td>
      <td>-0.002795</td>
      <td>-0.010441</td>
      <td>-0.001337</td>
      <td>-0.017943</td>
      <td>0.002269</td>
      <td>-0.007665</td>
      <td>0.001515</td>
      <td>-0.009037</td>
      <td>-0.005984</td>
    </tr>
    <tr>
      <th>10012</th>
      <td>0.002537</td>
      <td>0.002167</td>
      <td>0.006135</td>
      <td>-0.006106</td>
      <td>0.000942</td>
      <td>0.000476</td>
      <td>0.004454</td>
      <td>0.001930</td>
      <td>-0.002265</td>
      <td>0.006284</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>10025</th>
      <td>0.000522</td>
      <td>0.001650</td>
      <td>-0.006106</td>
      <td>0.016193</td>
      <td>0.001591</td>
      <td>0.001028</td>
      <td>0.003443</td>
      <td>0.000223</td>
      <td>0.002208</td>
      <td>0.001293</td>
      <td>...</td>
      <td>0.001431</td>
      <td>0.001461</td>
      <td>0.002456</td>
      <td>0.001263</td>
      <td>0.010778</td>
      <td>-0.003024</td>
      <td>-0.014701</td>
      <td>0.000819</td>
      <td>0.005475</td>
      <td>-0.002047</td>
    </tr>
    <tr>
      <th>10026</th>
      <td>0.000039</td>
      <td>0.002524</td>
      <td>0.000942</td>
      <td>0.001591</td>
      <td>0.003983</td>
      <td>0.000821</td>
      <td>0.002423</td>
      <td>-0.000481</td>
      <td>0.001266</td>
      <td>0.002258</td>
      <td>...</td>
      <td>0.003223</td>
      <td>0.001250</td>
      <td>0.001479</td>
      <td>0.000853</td>
      <td>0.007287</td>
      <td>-0.004135</td>
      <td>-0.004120</td>
      <td>0.000071</td>
      <td>0.001340</td>
      <td>0.001451</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>93432</th>
      <td>-0.005004</td>
      <td>0.002269</td>
      <td>NaN</td>
      <td>-0.003024</td>
      <td>-0.004135</td>
      <td>-0.009098</td>
      <td>-0.007766</td>
      <td>NaN</td>
      <td>0.001334</td>
      <td>0.001569</td>
      <td>...</td>
      <td>-0.006456</td>
      <td>-0.001053</td>
      <td>-0.001264</td>
      <td>-0.000187</td>
      <td>-0.003197</td>
      <td>0.022076</td>
      <td>-0.009247</td>
      <td>0.006736</td>
      <td>-0.000768</td>
      <td>-0.009019</td>
    </tr>
    <tr>
      <th>93433</th>
      <td>-0.001406</td>
      <td>-0.007665</td>
      <td>NaN</td>
      <td>-0.014701</td>
      <td>-0.004120</td>
      <td>-0.002850</td>
      <td>0.006160</td>
      <td>NaN</td>
      <td>-0.012879</td>
      <td>-0.001388</td>
      <td>...</td>
      <td>-0.003570</td>
      <td>-0.013165</td>
      <td>0.001492</td>
      <td>-0.000840</td>
      <td>0.018457</td>
      <td>-0.009247</td>
      <td>1.276334</td>
      <td>0.001169</td>
      <td>0.024445</td>
      <td>0.032895</td>
    </tr>
    <tr>
      <th>93434</th>
      <td>-0.000266</td>
      <td>0.001515</td>
      <td>NaN</td>
      <td>0.000819</td>
      <td>0.000071</td>
      <td>0.002819</td>
      <td>-0.000537</td>
      <td>NaN</td>
      <td>0.000654</td>
      <td>-0.001071</td>
      <td>...</td>
      <td>0.000127</td>
      <td>0.000070</td>
      <td>0.000858</td>
      <td>-0.000743</td>
      <td>-0.009930</td>
      <td>0.006736</td>
      <td>0.001169</td>
      <td>0.015841</td>
      <td>0.004483</td>
      <td>0.000147</td>
    </tr>
    <tr>
      <th>93435</th>
      <td>0.000278</td>
      <td>-0.009037</td>
      <td>NaN</td>
      <td>0.005475</td>
      <td>0.001340</td>
      <td>-0.000840</td>
      <td>0.004911</td>
      <td>NaN</td>
      <td>-0.000609</td>
      <td>-0.001579</td>
      <td>...</td>
      <td>0.012086</td>
      <td>0.007676</td>
      <td>-0.004608</td>
      <td>0.007259</td>
      <td>0.019851</td>
      <td>-0.000768</td>
      <td>0.024445</td>
      <td>0.004483</td>
      <td>0.114267</td>
      <td>0.012217</td>
    </tr>
    <tr>
      <th>93436</th>
      <td>-0.001426</td>
      <td>-0.005984</td>
      <td>NaN</td>
      <td>-0.002047</td>
      <td>0.001451</td>
      <td>0.000558</td>
      <td>0.003966</td>
      <td>NaN</td>
      <td>0.002036</td>
      <td>0.004171</td>
      <td>...</td>
      <td>0.005557</td>
      <td>0.001712</td>
      <td>0.014019</td>
      <td>0.001869</td>
      <td>0.014379</td>
      <td>-0.009019</td>
      <td>0.032895</td>
      <td>0.000147</td>
      <td>0.012217</td>
      <td>0.034449</td>
    </tr>
  </tbody>
</table>
<p>8386 rows × 8386 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># but that is not the only problem. The covariance matrix is not invertable because it is singular. </span>
<span class="c1"># to see this we will fill the nans with the average off diagonal term</span>
<span class="n">cov_nonnans</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">average_off_diagonal</span><span class="p">)</span>
<span class="n">cov_nonnans</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="21" halign="left">ret</th>
    </tr>
    <tr>
      <th></th>
      <th>permno</th>
      <th>10001</th>
      <th>10002</th>
      <th>10012</th>
      <th>10025</th>
      <th>10026</th>
      <th>10028</th>
      <th>10032</th>
      <th>10042</th>
      <th>10044</th>
      <th>10051</th>
      <th>...</th>
      <th>93423</th>
      <th>93426</th>
      <th>93428</th>
      <th>93429</th>
      <th>93430</th>
      <th>93432</th>
      <th>93433</th>
      <th>93434</th>
      <th>93435</th>
      <th>93436</th>
    </tr>
    <tr>
      <th></th>
      <th>permno</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="11" valign="top">ret</th>
      <th>10001</th>
      <td>0.007798</td>
      <td>-0.000774</td>
      <td>0.002537</td>
      <td>0.000522</td>
      <td>0.000039</td>
      <td>0.002555</td>
      <td>0.000775</td>
      <td>-0.001050</td>
      <td>0.000194</td>
      <td>0.000912</td>
      <td>...</td>
      <td>-0.000404</td>
      <td>-0.000114</td>
      <td>-0.001576</td>
      <td>-0.000129</td>
      <td>0.000675</td>
      <td>-0.005004</td>
      <td>-0.001406</td>
      <td>-0.000266</td>
      <td>0.000278</td>
      <td>-0.001426</td>
    </tr>
    <tr>
      <th>10002</th>
      <td>-0.000774</td>
      <td>0.024677</td>
      <td>0.002167</td>
      <td>0.001650</td>
      <td>0.002524</td>
      <td>0.003879</td>
      <td>-0.000004</td>
      <td>-0.000807</td>
      <td>0.000077</td>
      <td>0.000552</td>
      <td>...</td>
      <td>-0.004404</td>
      <td>-0.002795</td>
      <td>-0.010441</td>
      <td>-0.001337</td>
      <td>-0.017943</td>
      <td>0.002269</td>
      <td>-0.007665</td>
      <td>0.001515</td>
      <td>-0.009037</td>
      <td>-0.005984</td>
    </tr>
    <tr>
      <th>10012</th>
      <td>0.002537</td>
      <td>0.002167</td>
      <td>0.006135</td>
      <td>-0.006106</td>
      <td>0.000942</td>
      <td>0.000476</td>
      <td>0.004454</td>
      <td>0.001930</td>
      <td>-0.002265</td>
      <td>0.006284</td>
      <td>...</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
      <td>0.003524</td>
    </tr>
    <tr>
      <th>10025</th>
      <td>0.000522</td>
      <td>0.001650</td>
      <td>-0.006106</td>
      <td>0.016193</td>
      <td>0.001591</td>
      <td>0.001028</td>
      <td>0.003443</td>
      <td>0.000223</td>
      <td>0.002208</td>
      <td>0.001293</td>
      <td>...</td>
      <td>0.001431</td>
      <td>0.001461</td>
      <td>0.002456</td>
      <td>0.001263</td>
      <td>0.010778</td>
      <td>-0.003024</td>
      <td>-0.014701</td>
      <td>0.000819</td>
      <td>0.005475</td>
      <td>-0.002047</td>
    </tr>
    <tr>
      <th>10026</th>
      <td>0.000039</td>
      <td>0.002524</td>
      <td>0.000942</td>
      <td>0.001591</td>
      <td>0.003983</td>
      <td>0.000821</td>
      <td>0.002423</td>
      <td>-0.000481</td>
      <td>0.001266</td>
      <td>0.002258</td>
      <td>...</td>
      <td>0.003223</td>
      <td>0.001250</td>
      <td>0.001479</td>
      <td>0.000853</td>
      <td>0.007287</td>
      <td>-0.004135</td>
      <td>-0.004120</td>
      <td>0.000071</td>
      <td>0.001340</td>
      <td>0.001451</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>93432</th>
      <td>-0.005004</td>
      <td>0.002269</td>
      <td>0.003524</td>
      <td>-0.003024</td>
      <td>-0.004135</td>
      <td>-0.009098</td>
      <td>-0.007766</td>
      <td>0.003524</td>
      <td>0.001334</td>
      <td>0.001569</td>
      <td>...</td>
      <td>-0.006456</td>
      <td>-0.001053</td>
      <td>-0.001264</td>
      <td>-0.000187</td>
      <td>-0.003197</td>
      <td>0.022076</td>
      <td>-0.009247</td>
      <td>0.006736</td>
      <td>-0.000768</td>
      <td>-0.009019</td>
    </tr>
    <tr>
      <th>93433</th>
      <td>-0.001406</td>
      <td>-0.007665</td>
      <td>0.003524</td>
      <td>-0.014701</td>
      <td>-0.004120</td>
      <td>-0.002850</td>
      <td>0.006160</td>
      <td>0.003524</td>
      <td>-0.012879</td>
      <td>-0.001388</td>
      <td>...</td>
      <td>-0.003570</td>
      <td>-0.013165</td>
      <td>0.001492</td>
      <td>-0.000840</td>
      <td>0.018457</td>
      <td>-0.009247</td>
      <td>1.276334</td>
      <td>0.001169</td>
      <td>0.024445</td>
      <td>0.032895</td>
    </tr>
    <tr>
      <th>93434</th>
      <td>-0.000266</td>
      <td>0.001515</td>
      <td>0.003524</td>
      <td>0.000819</td>
      <td>0.000071</td>
      <td>0.002819</td>
      <td>-0.000537</td>
      <td>0.003524</td>
      <td>0.000654</td>
      <td>-0.001071</td>
      <td>...</td>
      <td>0.000127</td>
      <td>0.000070</td>
      <td>0.000858</td>
      <td>-0.000743</td>
      <td>-0.009930</td>
      <td>0.006736</td>
      <td>0.001169</td>
      <td>0.015841</td>
      <td>0.004483</td>
      <td>0.000147</td>
    </tr>
    <tr>
      <th>93435</th>
      <td>0.000278</td>
      <td>-0.009037</td>
      <td>0.003524</td>
      <td>0.005475</td>
      <td>0.001340</td>
      <td>-0.000840</td>
      <td>0.004911</td>
      <td>0.003524</td>
      <td>-0.000609</td>
      <td>-0.001579</td>
      <td>...</td>
      <td>0.012086</td>
      <td>0.007676</td>
      <td>-0.004608</td>
      <td>0.007259</td>
      <td>0.019851</td>
      <td>-0.000768</td>
      <td>0.024445</td>
      <td>0.004483</td>
      <td>0.114267</td>
      <td>0.012217</td>
    </tr>
    <tr>
      <th>93436</th>
      <td>-0.001426</td>
      <td>-0.005984</td>
      <td>0.003524</td>
      <td>-0.002047</td>
      <td>0.001451</td>
      <td>0.000558</td>
      <td>0.003966</td>
      <td>0.003524</td>
      <td>0.002036</td>
      <td>0.004171</td>
      <td>...</td>
      <td>0.005557</td>
      <td>0.001712</td>
      <td>0.014019</td>
      <td>0.001869</td>
      <td>0.014379</td>
      <td>-0.009019</td>
      <td>0.032895</td>
      <td>0.000147</td>
      <td>0.012217</td>
      <td>0.034449</td>
    </tr>
  </tbody>
</table>
<p>8386 rows × 8386 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># still not invertable!</span>
<span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_nonnans</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">LinAlgError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="nn">Input In [28],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_nonnans</span><span class="p">)</span>

<span class="nn">File &lt;__array_function__ internals&gt;:180,</span> in <span class="ni">inv</span><span class="nt">(*args, **kwargs)</span>

<span class="nn">File c:\Users\Alan.Moreira\Anaconda3\lib\site-packages\numpy\linalg\linalg.py:545,</span> in <span class="ni">inv</span><span class="nt">(a)</span>
<span class="g g-Whitespace">    </span><span class="mi">543</span> <span class="n">signature</span> <span class="o">=</span> <span class="s1">&#39;D-&gt;D&#39;</span> <span class="k">if</span> <span class="n">isComplexType</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;d-&gt;d&#39;</span>
<span class="g g-Whitespace">    </span><span class="mi">544</span> <span class="n">extobj</span> <span class="o">=</span> <span class="n">get_linalg_error_extobj</span><span class="p">(</span><span class="n">_raise_linalgerror_singular</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">545</span> <span class="n">ainv</span> <span class="o">=</span> <span class="n">_umath_linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">signature</span><span class="o">=</span><span class="n">signature</span><span class="p">,</span> <span class="n">extobj</span><span class="o">=</span><span class="n">extobj</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">546</span> <span class="k">return</span> <span class="n">wrap</span><span class="p">(</span><span class="n">ainv</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">result_t</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nn">File c:\Users\Alan.Moreira\Anaconda3\lib\site-packages\numpy\linalg\linalg.py:88,</span> in <span class="ni">_raise_linalgerror_singular</span><span class="nt">(err, flag)</span>
<span class="g g-Whitespace">     </span><span class="mi">87</span> <span class="k">def</span><span class="w"> </span><span class="nf">_raise_linalgerror_singular</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">88</span>     <span class="k">raise</span> <span class="n">LinAlgError</span><span class="p">(</span><span class="s2">&quot;Singular matrix&quot;</span><span class="p">)</span>

<span class="ne">LinAlgError</span>: Singular matrix
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># now lets Shrink the sampel covariance matrix to our &quot;prior&quot;</span>
<span class="c1"># this works even with quite a small shrinkage parameter</span>
<span class="n">h</span><span class="o">=</span><span class="mf">0.01</span>
<span class="n">cov_shrinked</span><span class="o">=</span><span class="n">cov_shrink</span><span class="o">*</span><span class="n">h</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">cov_nonnans</span>
<span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_shrink</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 2.49006930e+01, -2.96564148e-03, -2.96564148e-03, ...,
        -2.96564148e-03, -2.96564148e-03, -2.96564148e-03],
       [-2.96564148e-03,  2.49006930e+01, -2.96564148e-03, ...,
        -2.96564148e-03, -2.96564148e-03, -2.96564148e-03],
       [-2.96564148e-03, -2.96564148e-03,  2.49006930e+01, ...,
        -2.96564148e-03, -2.96564148e-03, -2.96564148e-03],
       ...,
       [-2.96564148e-03, -2.96564148e-03, -2.96564148e-03, ...,
         2.49006930e+01, -2.96564148e-03, -2.96564148e-03],
       [-2.96564148e-03, -2.96564148e-03, -2.96564148e-03, ...,
        -2.96564148e-03,  2.49006930e+01, -2.96564148e-03],
       [-2.96564148e-03, -2.96564148e-03, -2.96564148e-03, ...,
        -2.96564148e-03, -2.96564148e-03,  2.49006930e+01]])
</pre></div>
</div>
</div>
</div>
<p>Which shrinkage parameter to use is a “data-driven” question</p>
<p>You have to see what works</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./chapters/Finance"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quantitative-trading-strategies"><strong>Quantitative trading strategies</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#our-first-quantitative-strategy"><strong>Our First Quantitative Strategy</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#garbage-in-garbage-out">Garbage in, Garbage out</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimation-uncertainty">Estimation uncertainty</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sensitivity-of-optimal-weights-to-uncertainty">Sensitivity of optimal weights to uncertainty</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#covariance-estimation-with-a-large-cross-sectional-of-assets">Covariance estimation with a large cross-sectional of assets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-to-do">What to do?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#shrinking-the-covariance-matrix">Shrinking the Covariance Matrix</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alan Moreira
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021 Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0).
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>